<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>content&#x2F;controllers&#x2F;SMETHAddressBookController.js</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.8.0pr2&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.8.0pr2&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="..&#x2F;assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/SMETHAcknowledgementController.html">SMETHAcknowledgementController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHAcknowledgementPreferencesController.html">SMETHAcknowledgementPreferencesController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHAddressBookController.html">SMETHAddressBookController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHAdvancedPreferencesController.html">SMETHAdvancedPreferencesController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHAttachmentController.html">SMETHAttachmentController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHAutomaticAcknowledgementController.html">SMETHAutomaticAcknowledgementController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHBankPreferencesController.html">SMETHBankPreferencesController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHComposeMessageController.html">SMETHComposeMessageController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHControlFactory.html">SMETHControlFactory</a></li>
            
                <li><a href="..&#x2F;classes/SMETHExportController.html">SMETHExportController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHHeaderController.html">SMETHHeaderController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHMail.html">SMETHMail</a></li>
            
                <li><a href="..&#x2F;classes/SMETHMailPreferencesController.html">SMETHMailPreferencesController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHMessageHandler.html">SMETHMessageHandler</a></li>
            
                <li><a href="..&#x2F;classes/SMETHMessageListController.html">SMETHMessageListController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHOptionController.html">SMETHOptionController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHRawContentController.html">SMETHRawContentController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHReadMessageController.html">SMETHReadMessageController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHReportController.html">SMETHReportController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHRequestController.html">SMETHRequestController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHUtils.html">SMETHUtils</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="..&#x2F;modules/smeth.html">smeth</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: content&#x2F;controllers&#x2F;SMETHAddressBookController.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x2F;* ***** BEGIN LICENSE BLOCK *****
 * This file is part of smeth (https:&#x2F;&#x2F;code.google.com&#x2F;p&#x2F;sepamail-smeth&#x2F;)
 *
 * Version: MPL 2.0&#x2F;GPL 3.0&#x2F;LGPL 3.0
 *
 * The contents of this file are subject to the Mozilla Public License Version
 * 2.0 (the &quot;License&quot;); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 * http:&#x2F;&#x2F;www.mozilla.org&#x2F;MPL&#x2F;2.0&#x2F;
 *
 * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,
 * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
 * for the specific language governing rights and limitations under the
 * License.
 *
 * The Initials Developers of the Original Code are :
 *  Ammit Heeramun, idSoft
 *  Bishan Kumar Madhoo, idSoft
 *  Manfred Sherlock Olm, deciBI &amp; vizGet
 * Portions created by the Initials Developers are Copyright (C) 2012
 * the Initial Developer. All Rights Reserved.
 *
 * Contributor(s):
 *  Ammit Heeramun
 *  Bishan Kumar Madhoo
 *  Manfred Sherlock Olm, smeth@decibi.fr
 *
 * Alternatively, the contents of this file may be used under the terms of
 * either the GNU General Public License Version 3 or later (the &quot;GPL&quot;), or
 * the GNU Lesser General Public License Version 3.0 or later (the &quot;LGPL&quot;),
 * in which case the provisions of the GPL or the LGPL are applicable instead
 * of those above. If you wish to allow use of your version of this file only
 * under the terms of either the GPL or the LGPL, and not to allow others to
 * use your version of this file under the terms of the MPL, indicate your
 * decision by deleting the provisions above and replace them with the notice
 * and other provisions required by the GPL or the LGPL. If you do not delete
 * the provisions above, a recipient may use your version of this file under
 * the terms of any one of the MPL, the GPL or the LGPL.
 *
 * ***** END LICENSE BLOCK ***** *&#x2F;

&#x2F;**
 * @module smeth
 * @file SMETHAddressBookController.js
 * @mvc controller
 * @version green
 * @since green
 * @author Bishan Kumar Madhoo
 * @description SMETHAddressBookController extends the Thunderbird Address Book for SEPAmail message specific fields.
 *&#x2F;

&#x2F;**
 * The NetUtil.jsm JavaScript code module offers utility routines performing common network related tasks.
 *
 * @include NetUtil.jsm
 * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Mozilla&#x2F;JavaScript_code_modules&#x2F;NetUtil.jsm
 *&#x2F;
Components.utils.import(&quot;resource:&#x2F;&#x2F;gre&#x2F;modules&#x2F;NetUtil.jsm&quot;);

&#x2F;**
 * SMETHMessageHandler class contain functions to handle info, error, warning and exceptions messages
 *
 * @include SMETHMessageHandler.js
 *&#x2F;
Components.utils.import(&quot;resource:&#x2F;&#x2F;smeth&#x2F;smethlib&#x2F;SMETHMessageHandler.js&quot;);

&#x2F;**
 * SMETHUtils class contains all the useful functions that will be used in SMETH
 *
 * @include SMETHUtils.js
 *&#x2F;
Components.utils.import(&quot;resource:&#x2F;&#x2F;smeth&#x2F;smethlib&#x2F;SMETHUtils.js&quot;);

&#x2F;**
 * Strict mode for scripts
 * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;JavaScript&#x2F;Reference&#x2F;Functions_and_function_scope&#x2F;Strict_mode
 *&#x2F;
&quot;use strict&quot;;

&#x2F;**
 * SMETHAddressBookController adds SEPAmail specific fields to the Thunderbird Address Book
 *
 * @class SMETHAddressBookController
 *&#x2F;
var SMETHAddressBookController = {

    &#x2F;**
     * Declare the SMETHMessageHandler class
     *
     * @attribute _smethMessageHandler
     * @private
     *&#x2F;
    _smethMessageHandler : new SMETHMessageHandler(window),

    &#x2F;**
     * Declare the utilities class
     *
     * @attribute _smethUtils
     * @private
     * @default null
     *&#x2F;
    _smethUtils : new SMETHUtils(window),

    &#x2F;**
     * Load a RIS2D map from local storage
     *
     * @method getLocalRISD2Map
     *&#x2F;
    getLocalRISD2Map : function() {

        &#x2F;&#x2F; Get the RIS2D map file
        var mapFile = this._smethUtils.getFile(&#x27;RIS2D map&#x27;);

        &#x2F;&#x2F; Check if a file was obtained
        if (mapFile != null) {

            &#x2F;&#x2F; Reset map type
            this.resetMap();

            &#x2F;&#x2F; Set the RIS2D map type
            document.getElementById(&quot;SMETHRis2DMapType&quot;).value = &#x27;file&#x27;;

            &#x2F;&#x2F; Display name of file in file field
            document.getElementById(&#x27;ris2dFile&#x27;).file = mapFile;

            &#x2F;&#x2F; Read the content of the map file
            NetUtil.asyncFetch(mapFile, function(inputStream, status) {

                &#x2F;&#x2F; Check if there is any reading error
                if (!Components.isSuccessCode(status)) {
                    throw new Error(&quot;Error reading from file&quot;);
                    return;
                }

                &#x2F;&#x2F; Read the file
                var data = NetUtil.readInputStreamToString(inputStream, inputStream.available());

                &#x2F;&#x2F; Show the map
                document.getElementById(&quot;sepamailRis2d&quot;).src = &#x27;data:image;base64,&#x27; + window.btoa(data);
            });
        }
    },

    &#x2F;**
     * Get a RIS2D map from a remote URL
     *
     * @method getRemoteRISD2Map
     *&#x2F;
    getRemoteRISD2Map : function() {

        &#x2F;&#x2F; Get the map URL
        var mapUrl = document.getElementById(&quot;ris2dURI&quot;).value;

        &#x2F;&#x2F; Check if a map URL has properly been defined
        if (mapUrl.length &gt; 0) {

            &#x2F;&#x2F; IO Service to read remote map document
            var ioserv = Components.classes[&quot;@mozilla.org&#x2F;network&#x2F;io-service;1&quot;]
                                   .getService(Components.interfaces.nsIIOService);

            &#x2F;&#x2F; Read the remote map
            var channel = ioserv.newChannel(mapUrl, 0, null);
            var stream = channel.open();

            &#x2F;&#x2F; Check if the document could be read
            if (channel instanceof Components.interfaces.nsIHttpChannel &amp;&amp; channel.responseStatus != 200) {

                &#x2F;&#x2F; Prompt service
                var prompts = Components.classes[&quot;@mozilla.org&#x2F;embedcomp&#x2F;prompt-service;1&quot;]
                                        .getService(Components.interfaces.nsIPromptService);

                &#x2F;&#x2F; Remote map could not be read
                prompts.alert(null, &quot;SMETH&quot;, SMETHAddressBookTranslations.semUrlUpdateError);

            } else {

                &#x2F;&#x2F; Create instance of byte stream to get content of remote map document
                var bstream = Components.classes[&quot;@mozilla.org&#x2F;binaryinputstream;1&quot;]
                                        .createInstance(Components.interfaces.nsIBinaryInputStream);
                bstream.setInputStream(stream);

                &#x2F;&#x2F; Read the remote document content and add to the file data string
                var size = 0;
                var file_data = &quot;&quot;;
                while(size = bstream.available()) {
                    file_data += bstream.readBytes(size);
                }

                &#x2F;&#x2F; Reset map type
                this.resetMap();

                &#x2F;&#x2F; Map URL
                document.getElementById(&quot;ris2dURI&quot;).value = mapUrl;

                &#x2F;&#x2F; Set the RIS2D map type
                document.getElementById(&quot;SMETHRis2DMapType&quot;).value = &#x27;web&#x27;;

                &#x2F;&#x2F; Show the map
                document.getElementById(&quot;sepamailRis2d&quot;).src = &#x27;data:image;base64,&#x27; + window.btoa(file_data);
            }
        }
    },

    &#x2F;**
     * load is the event triggered when a contact card is loaded
     *
     * @method load
     * @param {Object} aCard nsIAbCard which is being loaded
     * @param {Object} aDocument A reference to the contact editor document
     *&#x2F;
    load : function(aCard, aDocument) {

        &#x2F;&#x2F; Populate the SEPAmail specific fields on the contact card document
        SMETHAddressBookController.populateSEPAmailValues(aCard, aDocument);
    },

    &#x2F;**
     * onLoad registers listeners for the loading and saving of contact cards in Thunderbird address book
     *
     * @method onLoad
     *&#x2F;
    onLoad : function() {

        &#x2F;&#x2F; Register the contact card load listener
        RegisterLoadListener(SMETHAddressBookController.load);

        &#x2F;&#x2F; Register the contact card save listener
        RegisterSaveListener(SMETHAddressBookController.save);
    },

    &#x2F;**
     * populateSEPAmailValues populates the SEPAmail specific fields in the contact card
     *
     * @method populateSEPAmailValues
     * @param {Object} aCard nsIAbCard which is being loaded
     * @param {Object} aDocument A reference to the contact editor document
     *&#x2F;
    populateSEPAmailValues : function(aCard, aDocument) {

        &#x2F;&#x2F; Contact title
        aDocument.getElementById(&quot;SMETHTitle&quot;).value = aCard.getProperty(&quot;SMETHTitle&quot;, &#x27;&#x27;);

        &#x2F;&#x2F; SEPAmail account
        aDocument.getElementById(&quot;SMETHSEPAmailAccount&quot;).value = aCard.getProperty(&quot;SMETHSEPAmailAccount&quot;, &#x27;&#x27;);

        &#x2F;&#x2F; Get the map type
        var mapType = aCard.getProperty(&quot;SMETHRIS2DMapType&quot;, &#x27;none&#x27;);

        &#x2F;&#x2F; RIS2D map type
        aDocument.getElementById(&quot;SMETHRis2DMapType&quot;).value = mapType;

        &#x2F;&#x2F; Populate UI based on map type
        switch (mapType) {

            case &#x27;none&#x27;:
                aDocument.getElementById(&quot;sepamailRis2d&quot;).src = &#x27;chrome:&#x2F;&#x2F;smeth&#x2F;skin&#x2F;images&#x2F;blank-ris2d.png&#x27;;
                aDocument.getElementById(&quot;ris2dFile&quot;).file = null;
                aDocument.getElementById(&quot;ris2dFile&quot;).label = &#x27;&#x27;;
                aDocument.getElementById(&quot;ris2dURI&quot;).value = &#x27;&#x27;;
                break;

            case &#x27;file&#x27;:
                aDocument.getElementById(&quot;sepamailRis2d&quot;).src = &#x27;data:image;base64,&#x27; +
                    aCard.getProperty(&quot;SMETHRIS2DMapData&quot;, &#x27;&#x27;);
                aDocument.getElementById(&quot;ris2dFile&quot;).icon = &#x27;moz-icon:&#x2F;&#x2F;file:&#x2F;&#x2F;&#x27; +
                    aCard.getProperty(&quot;SMETHRIS2DMapFile&quot;, &#x27;&#x27;);
                aDocument.getElementById(&quot;ris2dFile&quot;).label = aCard.getProperty(&quot;SMETHRIS2DMapFile&quot;, &#x27;&#x27;);
                aDocument.getElementById(&quot;ris2dURI&quot;).value = &#x27;&#x27;;
                break;

            case &#x27;web&#x27;:
                aDocument.getElementById(&quot;sepamailRis2d&quot;).src = &#x27;data:image;base64,&#x27; +
                    aCard.getProperty(&quot;SMETHRIS2DMapData&quot;, &#x27;&#x27;);
                aDocument.getElementById(&quot;ris2dFile&quot;).file = null;
                aDocument.getElementById(&quot;ris2dFile&quot;).label = &#x27;&#x27;;
                aDocument.getElementById(&quot;ris2dURI&quot;).value = aCard.getProperty(&quot;SMETHRIS2DMapURL&quot;, &#x27;&#x27;);
                break;
        }
    },

    &#x2F;**
     * Reset the RIS2D map displayed on the UI
     *
     * @method resetMap
     *&#x2F;
    resetMap : function() {

        &#x2F;&#x2F; Reset RIS2D map
        document.getElementById(&quot;sepamailRis2d&quot;).src = &#x27;chrome:&#x2F;&#x2F;smeth&#x2F;skin&#x2F;images&#x2F;blank-ris2d.png&#x27;;
        document.getElementById(&quot;ris2dFile&quot;).file = null;
        document.getElementById(&quot;ris2dFile&quot;).label = &#x27;&#x27;;
        document.getElementById(&quot;ris2dURI&quot;).value = &#x27;&#x27;;
    },

    &#x2F;**
     * save is the event triggered when a contact card is being saved
     *
     * @method save
     * @param {Object} aCard nsIAbCard which is being saved
     * @param {Object} aDocument A reference to the contact editor document
     *&#x2F;
    save : function(aCard, aDocument) {

        &#x2F;&#x2F; Contact title
        aCard.setProperty(&quot;SMETHTitle&quot;,  aDocument.getElementById(&quot;SMETHTitle&quot;).value);

        &#x2F;&#x2F; SEPAmail account
        aCard.setProperty(&quot;SMETHSEPAmailAccount&quot;, aDocument.getElementById(&quot;SMETHSEPAmailAccount&quot;).value);

        &#x2F;&#x2F; Get the RIS2D map type
        var mapType = aDocument.getElementById(&quot;SMETHRis2DMapType&quot;).value;

        &#x2F;&#x2F; Save the RIS2D map type
        aCard.setProperty(&quot;SMETHRIS2DMapType&quot;, mapType);

        &#x2F;&#x2F; Save map data based on map type
        switch (mapType) {

            case &#x27;none&#x27;:
                aCard.setProperty(&quot;SMETHRIS2DMapData&quot;, &#x27;&#x27;);
                aCard.setProperty(&quot;SMETHRIS2DMapFile&quot;, &#x27;&#x27;);
                aCard.setProperty(&quot;SMETHRIS2DMapURL&quot;, &#x27;&#x27;);
                break;

            case &#x27;file&#x27;:
                aCard.setProperty(&quot;SMETHRIS2DMapData&quot;, aDocument.getElementById(&quot;sepamailRis2d&quot;).src.substr(18));
                aCard.setProperty(&quot;SMETHRIS2DMapFile&quot;, aDocument.getElementById(&quot;ris2dFile&quot;).label);
                aCard.setProperty(&quot;SMETHRIS2DMapURL&quot;, &#x27;&#x27;);
                break;

            case &#x27;web&#x27;:
                aCard.setProperty(&quot;SMETHRIS2DMapData&quot;, aDocument.getElementById(&quot;sepamailRis2d&quot;).src.substr(18));
                aCard.setProperty(&quot;SMETHRIS2DMapFile&quot;, &#x27;&#x27;);
                aCard.setProperty(&quot;SMETHRIS2DMapURL&quot;, aDocument.getElementById(&quot;ris2dURI&quot;).value);
                break;
        }
    }
}

SMETHAddressBookController.onLoad();
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
