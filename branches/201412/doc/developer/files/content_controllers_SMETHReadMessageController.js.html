<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>content&#x2F;controllers&#x2F;SMETHReadMessageController.js</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.8.0pr2&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.8.0pr2&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="..&#x2F;assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/SMETHAcknowledgementController.html">SMETHAcknowledgementController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHAcknowledgementPreferencesController.html">SMETHAcknowledgementPreferencesController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHAddressBookController.html">SMETHAddressBookController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHAdvancedPreferencesController.html">SMETHAdvancedPreferencesController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHAttachmentController.html">SMETHAttachmentController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHAutomaticAcknowledgementController.html">SMETHAutomaticAcknowledgementController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHBankPreferencesController.html">SMETHBankPreferencesController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHComposeMessageController.html">SMETHComposeMessageController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHControlFactory.html">SMETHControlFactory</a></li>
            
                <li><a href="..&#x2F;classes/SMETHExportController.html">SMETHExportController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHHeaderController.html">SMETHHeaderController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHMail.html">SMETHMail</a></li>
            
                <li><a href="..&#x2F;classes/SMETHMailPreferencesController.html">SMETHMailPreferencesController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHMessageHandler.html">SMETHMessageHandler</a></li>
            
                <li><a href="..&#x2F;classes/SMETHMessageListController.html">SMETHMessageListController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHOptionController.html">SMETHOptionController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHRawContentController.html">SMETHRawContentController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHReadMessageController.html">SMETHReadMessageController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHReportController.html">SMETHReportController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHRequestController.html">SMETHRequestController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHUtils.html">SMETHUtils</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="..&#x2F;modules/smeth.html">smeth</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: content&#x2F;controllers&#x2F;SMETHReadMessageController.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x2F;* ***** BEGIN LICENSE BLOCK *****
 * This file is part of smeth (https:&#x2F;&#x2F;code.google.com&#x2F;p&#x2F;sepamail-smeth&#x2F;)
 *
 * Version: MPL 2.0&#x2F;GPL 3.0&#x2F;LGPL 3.0
 *
 * The contents of this file are subject to the Mozilla Public License Version
 * 2.0 (the &quot;License&quot;); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 * http:&#x2F;&#x2F;www.mozilla.org&#x2F;MPL&#x2F;2.0&#x2F;
 *
 * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,
 * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
 * for the specific language governing rights and limitations under the
 * License.
 *
 * The Initials Developers of the Original Code are :
 *  Ammit Heeramun, idSoft
 *  Bishan Kumar Madhoo, idSoft
 *  Manfred Sherlock Olm, deciBI &amp; vizGet
 * Portions created by the Initials Developers are Copyright (C) 2012
 * the Initial Developer. All Rights Reserved.
 *
 * Contributor(s):
 *  Ammit Heeramun
 *  Bishan Kumar Madhoo
 *  Manfred Sherlock Olm, smeth@decibi.fr
 *
 * Alternatively, the contents of this file may be used under the terms of
 * either the GNU General Public License Version 3 or later (the &quot;GPL&quot;), or
 * the GNU Lesser General Public License Version 3.0 or later (the &quot;LGPL&quot;),
 * in which case the provisions of the GPL or the LGPL are applicable instead
 * of those above. If you wish to allow use of your version of this file only
 * under the terms of either the GPL or the LGPL, and not to allow others to
 * use your version of this file under the terms of the MPL, indicate your
 * decision by deleting the provisions above and replace them with the notice
 * and other provisions required by the GPL or the LGPL. If you do not delete
 * the provisions above, a recipient may use your version of this file under
 * the terms of any one of the MPL, the GPL or the LGPL.
 *
 * ***** END LICENSE BLOCK ***** *&#x2F;

&#x2F;**
 * @main smeth
 * @file SMETHReadMessageController.js
 * @mvc controller
 * @version 1212
 * @since 1210
 * @author Ammit Heeramun
 * @description SMETHReadMessageController is the class that is attached to SMETHReadMessageView, it helps in the setting up of the thunderbird main window interface for displaying of different type of SEPAmail messages.
 *&#x2F;

&#x2F;**
 * SMETHMessageHandler class contain functions to handle info, error, warning and exceptions messages
 *
 * @include SMETHMessageHandler.js
 *&#x2F;
Components.utils.import(&quot;resource:&#x2F;&#x2F;smeth&#x2F;smethlib&#x2F;SMETHMessageHandler.js&quot;);

&#x2F;**
 * SMETHUtils class contains all the useful functions that will be used in Smeth
 *
 * @include SMETHUtils.js
 *&#x2F;
Components.utils.import(&quot;resource:&#x2F;&#x2F;smeth&#x2F;smethlib&#x2F;SMETHUtils.js&quot;);

&#x2F;**
 * SMETHControlFactory class contain functions to create XUL and HTML controls
 *
 * @include SMETHControlFactory.js
 *&#x2F;
Components.utils.import(&quot;resource:&#x2F;&#x2F;smeth&#x2F;smethlib&#x2F;SMETHControlFactory.js&quot;);

&#x2F;**
 * SMETHMail class that represent the message object for Smeth
 *
 * @include SMETHMail.js
 *&#x2F;
Components.utils.import(&quot;resource:&#x2F;&#x2F;smeth&#x2F;smethlib&#x2F;SMETHMail.js&quot;);

&#x2F;**
 * The FileUtils.jsm JavaScript code module offers utility routines dealing with files.
 *
 * @include FileUtils.jsm
 * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Mozilla&#x2F;JavaScript_code_modules&#x2F;FileUtils.jsm
 *&#x2F;
Components.utils.import(&quot;resource:&#x2F;&#x2F;gre&#x2F;modules&#x2F;FileUtils.jsm&quot;);

&#x2F;**
 * The NetUtil.jsm JavaScript code module provides easy-to-use APIs for performing common network related tasks.
 *
 * @include NetUtil.jsm
 * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Mozilla&#x2F;JavaScript_code_modules&#x2F;NetUtil.jsm
 *&#x2F;
Components.utils.import(&quot;resource:&#x2F;&#x2F;gre&#x2F;modules&#x2F;NetUtil.jsm&quot;);

&#x2F;**
 * Strict mode for scripts
 * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;JavaScript&#x2F;Reference&#x2F;Functions_and_function_scope&#x2F;Strict_mode
 *
 *&#x2F;
&quot;use strict&quot;;

&#x2F;**
 * SMETHReadMessageController is the class that is attached to SMETHReadMessageView, it helps in the setting up of the thunderbird main window interface for displaying of different type of SEPAmail messages.
 *
 * @class SMETHReadMessageController
 *&#x2F;
var SMETHReadMessageController = {

   &#x2F;**
    * Declare the SMETHMessageHandler class
    *
    * @attribute _smethMessageHandler
    * @private
    * @default null
    *&#x2F;
    _smethMessageHandler : null,

   &#x2F;**
    * Declare the utils class
    *
    * @attribute _smethUtils
    * @private
    * @default null
    *&#x2F;
    _smethUtils : new SMETHUtils(window),

   &#x2F;**
    * Declare the SMETHControlFactory class
    *
    * @attribute _smethControlFactory
    * @private
    * @default null
    *&#x2F;
    _smethControlFactory : null,

   &#x2F;**
    * Declare the smeth mail object
    *
    * @attribute _smethMail
    * @private
    * @default null
    *&#x2F;
    _smethMail : null,

   &#x2F;**
    * Preferences object
    *
    * @attribute _smethPreferences
    * @private
    * @default null
    *&#x2F;
    _smethPreferences : null,

   &#x2F;**
    * Preference prefIsBodyXML
    *
    * @attribute _smethPrefIsBodyXML
    * @private
    * @default null
    *&#x2F;
    _smethPrefIsBodyXML : null,

   &#x2F;**
    * Preference prefSEPAmailXMLTag
    *
    * @attribute _smethPrefSEPAmailXMLTag
    * @private
    * @default null
    *&#x2F;
    _smethPrefSEPAmailXMLTag : null,

   &#x2F;**
    * Preference for missive message type XPath
    *
    * @attribute _smethPrefMissiveMsgTypXpath
    * @private
    * @default null
    *&#x2F;
    _smethPrefMissiveMsgTypXpath : null,

   &#x2F;**
    * Preference for the missive root tag
    *
    * @attribute _smethPrefMissiveRootTag
    * @private
    * @default null
    *&#x2F;
    _smethPrefMissiveRootTag : null,

   &#x2F;**
    * Preference for SEPAmail accounts
    *
    * @attribute _smethEmailToQxbanObj
    * @private
    * @default null
    *&#x2F;
    _smethEmailToQxbanObj : null,

   &#x2F;**
    * Smeth config object
    *
    * @attribute _smethConfigObject
    * @private
    * @default null
    *&#x2F;
    _smethConfigObject : null,

    &#x2F;**
     * Smeth message type
     *
     * @attribute _smethMessageType
     * @private
     * @default null
     *&#x2F;
    _smethMessageType : null,

    &#x2F;**
     * Initiation of the Smeth plugin
     *
     * @method init
     * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Code_snippets&#x2F;Preferences#XPCOM_interfaces_for_preferences_system
     *&#x2F;

    init : function() {

        try {

            &#x2F;&#x2F; Instantiate the SMETHMessageHandler class
            this._smethMessageHandler = new SMETHMessageHandler(window);

            &#x2F;&#x2F; Instantiate the
            &#x2F;&#x2F;this._smethUtils = new SMETHUtils(window);

            &#x2F;&#x2F; Instantiate the SMETHControlFactory class
            this._smethControlFactory = new SMETHControlFactory(document);

            &#x2F;&#x2F; Register to receive notifications of preference changes
            &#x2F;&#x2F; @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Code_snippets&#x2F;Preferences#XPCOM_interfaces_for_preferences_system
            this._smethPreferences = Components.classes[&quot;@mozilla.org&#x2F;preferences-service;1&quot;]
                                    .getService(Components.interfaces.nsIPrefService)
                                    .getBranch(&quot;extensions.smeth.&quot;);
            this._smethPreferences.QueryInterface(Components.interfaces.nsIPrefBranch2);

            &#x2F;&#x2F; Add an observer for changes in preferences
            this._smethPreferences.addObserver(&quot;&quot;, this, false);

            &#x2F;&#x2F; Retreive the value of the preference &quot;prefIsBodyXML&quot;
            this._smethPrefIsBodyXML = this._smethPreferences.getBoolPref(&quot;prefIsBodyXML&quot;);

            &#x2F;&#x2F; Retreive the value of the preference &quot;prefSEPAmailXMLTag&quot;
            this._smethPrefSEPAmailXMLTag = this._smethPreferences.getCharPref(&quot;prefSEPAmailXMLTag&quot;);

            &#x2F;&#x2F; Retreive the value of the missive preference &quot;prefMsgTypXpath&quot;
            this._smethPrefMissiveMsgTypXpath = this._smethPreferences.getCharPref(&quot;missive.prefMsgTypXpath&quot;);

            &#x2F;&#x2F; Retreive the value of the missive preference &quot;prefRootTag&quot;
            this._smethPrefMissiveRootTag = this._smethPreferences.getCharPref(&quot;missive.prefRootTag&quot;);

            &#x2F;&#x2F; Get SEPAmail account preferences &quot;myqxbans&quot;
            this._smethEmailToQxbanObj = JSON.parse(this._smethPreferences.getCharPref(&#x27;myqxbans&#x27;));

        } catch (ex) {
            SMETHReadMessageController._smethMessageHandler.exception(ex);
        }

    },

    &#x2F;**
     * observe function Called when events occur on the preferences
     *
     * @method observe
     * @param {String} aSubject Event Subject
     * @param {String} aTopic Event Topic
     * @param {Object} aData Event Data
     *&#x2F;
    observe: function(aSubject, aTopic, aData) {

        try {

            if (aTopic != &quot;nsPref:changed&quot;) {
                return;
            }

            switch(aData) {

                case &quot;prefIsBodyXML&quot;:

                    &#x2F;&#x2F; Retreive the value of the preference &quot;prefIsBodyXML&quot;
                    this._smethPrefIsBodyXML = this._smethPreferences.getBoolPref(&quot;prefIsBodyXML&quot;);
                    break;
            }

        } catch(ex) {
            SMETHReadMessageController._smethMessageHandler.exception(ex);
        }
    },

    &#x2F;**
     * onMessagePaneLoad listener to be triggered on each mail select
     *
     * @method onMessagePaneLoad
     * @param {Object} aEvent Event data
     * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Code_snippets&#x2F;On_page_load
     *&#x2F;
    onMessagePaneLoad : function(aEvent) {

        try {

            &#x2F;&#x2F; Get the selected mail header
            var selectedMailHeader = gFolderDisplay.selectedMessage;

            if (null != selectedMailHeader) {

                &#x2F;&#x2F; Intatiate the smeth mail object
                SMETHReadMessageController.initializeSmethMailObject(selectedMailHeader);
            }

        } catch(ex) {
            SMETHReadMessageController._smethMessageHandler.exception(ex);
        }
    },

    &#x2F;**
     * initializeSmethMailObject function initialize a SmethMail Object using the mail selected header
     *
     * @method initializeSmethMailObject
     * @param {Object} aSelectedMailHeader Selected mail header
     *&#x2F;
    initializeSmethMailObject : function (aSelectedMailHeader) {

        try {

            &#x2F;&#x2F; Define the options for the MsgHdrToMimeMessage function
            var options = { examineEncryptedParts: true, partsOnDemand: false };

            &#x2F;&#x2F; Instantiate the smeth mail object
            this._smethMail = new SMETHMail(aSelectedMailHeader);

            &#x2F;&#x2F; Get the mail content
            MsgHdrToMimeMessage(aSelectedMailHeader, null, function (aMailHeader, aMailContent) {

                try {

                    &#x2F;&#x2F; Set the mail content object
                    SMETHReadMessageController._smethMail.content = aMailContent;

                    &#x2F;&#x2F; Set the mail body
                    SMETHReadMessageController._smethMail.body =
                        SMETHReadMessageController._smethUtils.getMailBody(SMETHReadMessageController._smethMail.content.parts[0],
                        document.getElementById(&quot;messagepane&quot;).contentDocument.body.textContent.replace(&#x2F;(\n|\t)&#x2F;gm, &quot;&quot;));

                    &#x2F;&#x2F; Set whether the selected mail is a SEPAmail
                    SMETHReadMessageController._smethMail.isSEPAmail =
                        SMETHReadMessageController._smethUtils.isSEPAmail(SMETHReadMessageController._smethMail.body);

                    &#x2F;&#x2F; Check if message is a SEPAmail message
                    if (SMETHReadMessageController._smethMail.isSEPAmail) {

                        &#x2F;&#x2F; Get the SEPAmail message root node type
                        SMETHReadMessageController._smethMail.sepamailType =
                            SMETHReadMessageController._smethUtils.getSEPAmailMessageRootNodeType(SMETHReadMessageController._smethMail.body);

                        &#x2F;&#x2F; Initialize the messagepane UI using the smeth mail object
                        SMETHReadMessageController.initializeMessagePaneUI(SMETHReadMessageController._smethMail);

                        &#x2F;&#x2F; Set the mail object for the acknowledgement controller
                        SMETHAcknowledgementController.missiveMailObject = SMETHReadMessageController._smethMail;

                    } else {

                        &#x2F;&#x2F; Message is not a SEPAmail message
                        SMETHReadMessageController.disableSEPAmailUI();
                    }

                } catch(ex) {
                    SMETHReadMessageController._smethMessageHandler.exception(ex);
                }

            }, true, options);

        } catch(ex) {
            throw ex;
        }

    },

    &#x2F;**
     * initializeMessagePaneUI initialises the messagepane user interface using the parametered SmethMail object
     *
     * @method initializeMessagePaneUI
     * @param {object} aSmethMail Selected mail object
     *&#x2F;
    initializeMessagePaneUI : function(aSmethMail) {

        try {

            &#x2F;&#x2F; Check if a mail is a SEPAmail
            if (aSmethMail.isSEPAmail) {

                &#x2F;&#x2F; Initialise
                SMETHReadMessageController.initializeSEPAmailUI();

                &#x2F;&#x2F; Parse the raw mail body
                this._smethMail.sepamailXMLObject = new DOMParser().parseFromString(aSmethMail.body, &quot;text&#x2F;xml&quot;);

                &#x2F;&#x2F;Set the SEPAmail message type
                this._smethMail.sepamailMessageType = SMETHReadMessageController._smethUtils.getSEPAmailMessageType(this._smethMail.sepamailXMLObject);

                &#x2F;&#x2F; Initializes the SEPAmail SMTP header
                SMETHReadMessageController.initializeSEPAmailSMTPHeaderUI();

                &#x2F;&#x2F;TODO:Proper handling for different message types
                if (this._smethMail.sepamailMessageType != &#x27;&#x27;) {

                    &#x2F;&#x2F; Retrieve the Smeth config object from the preferences
                    this._smethConfigObject = this._smethUtils.getControllerConfigObject(this._smethMail.sepamailMessageType);

                    if (this._smethConfigObject != null) {

                        &#x2F;&#x2F; Set the missive message type for the acknowledgement controller
                        SMETHAcknowledgementController.missiveMessageType = this._smethMail.sepamailMessageType;

                        &#x2F;&#x2F; Check for SEPAmail request content
                        if (SMETHRequestController.isSEPAmailRequest(aSmethMail.body)) {

                            &#x2F;&#x2F; We have a SEPAmail valid report missive XML
                            this._smethMessageType = &#x27;SEPAMAIL_REQUEST&#x27;;

                        } else if (SMETHReportController.isSEPAmailReport(aSmethMail.body)) {

                            &#x2F;&#x2F; We have a SEPAmail valid report missive XML
                            this._smethMessageType = &#x27;SEPAMAIL_REPORT&#x27;;
                        }

                        &#x2F;&#x2F; Initializes the SEPAmail header
                        SMETHHeaderController.initializeSEPAmailHeaderUI();

                        &#x2F;&#x2F; Initializes the SEPAmail body
                        SMETHReadMessageController.initializeSEPAmailBodyUI();

                        &#x2F;&#x2F; Check if there are attachments for the current message type
                        if (this._smethConfigObject.settings.hasAttachments) {

                            &#x2F;&#x2F; Initializes the SEPAmail attachment
                            SMETHReadMessageController.initializeSEPAmailAttachmentUI();
                        }

                        &#x2F;&#x2F; Set translated labels for SMETH UI controls
                        this._smethUtils.translateSEPAmailDocument(document.getElementById(&quot;sepamailUIContainer&quot;),
                            SMETHTranslations);

                        &#x2F;&#x2F; TODO: Freeze form if we are not in the message inbox
                        if (SMETHReadMessageController._smethUtils.getFolderType(gFolderDisplay) != &#x27;INBOX&#x27;) {

                            &#x2F;&#x2F; Freeze the SEPAmail UI content
                            SMETHReadMessageController._smethUtils.freezeContent(document.getElementById(&quot;sepamailUIContainer&quot;));
                        }

                    } else {

                        this.disableSEPAmailUI();
                        SMETHReadMessageController._smethMessageHandler.info(&quot;SEPAmail message type config not yet defined&quot;);
                    }

                } else {

                    if (SMETHAcknowledgementController.isAcknowledgementMissiveMessage(aSmethMail.body)) {

                        &#x2F;&#x2F; We have a SEPAmail valid acknowledgement missive XML
                        this._smethMessageType = &#x27;SEPAMAIL_ACKNOWLEDGEMENT&#x27;;

                        &#x2F;&#x2F; Initializes the SEPAmail header
                        SMETHHeaderController.initializeSEPAmailHeaderUI();

                        &#x2F;&#x2F; Initializes the SEPAmail body
                        SMETHReadMessageController.initializeSEPAmailBodyUI();

                    } else {

                        this.disableSEPAmailUI();
                        SMETHReadMessageController._smethMessageHandler.info(&quot;SEPAmail message type not yet handled&quot;);
                    }
                }

                &#x2F;&#x2F; Check if we have a SEPAmail raw browser
                if (document.getElementById(&quot;sepamailRawBrowser&quot;) != null) {

                    &#x2F;&#x2F; Use the load event of the browser to show SEPAmail message content
                    document.getElementById(&quot;sepamailRawBrowser&quot;).addEventListener(&quot;load&quot;, function load(event) {

                            &#x2F;&#x2F; Remove the listener
                            document.getElementById(&quot;sepamailRawBrowser&quot;).removeEventListener(&quot;load&quot;, load, true);

                            &#x2F;&#x2F; Display SEPAmail message content
                            SMETHRawContentController.displayMessage(this, gFolderDisplay.selectedMessage,
                                SMETHReadMessageController._smethMail.sepamailXMLObject);

                        }, true);

                    &#x2F;&#x2F; Load the raw mode template
                    document.getElementById(&quot;sepamailRawBrowser&quot;).loadURI(&#x27;chrome:&#x2F;&#x2F;smeth&#x2F;content&#x2F;codemirror&#x2F;template&#x2F;rawModeViewerTemplate.html&#x27;);
                }

            } else {
                this.disableSEPAmailUI();
            }

        } catch(ex) {
            throw ex;
        }

    },

    &#x2F;**
     * handleRawModeToggle enables or disables the SMETH raw mode
     *
     * @method initializeSEPAmailUI
     *&#x2F;
    handleRawModeToggle : function() {

        &#x2F;&#x2F; Mode toggle button
        var button = document.getElementById(&quot;smethSepamailRawModeToggle&quot;);

        &#x2F;&#x2F; Check the toggle button state
        if (button.checked) {

            &#x2F;&#x2F; Check if we need to create the raw mode display textbox
            if (document.getElementById(&quot;sepamailRawBrowser&quot;) == null) {

                &#x2F;&#x2F; Create a multiline textbox for the raw mode
                var browser = SMETHReadMessageController._smethControlFactory.createBrowserXULElement();

                &#x2F;&#x2F; Set the properties of the browser
                browser.setAttribute(&#x27;autofind&#x27;, false);
                browser.setAttribute(&#x27;disablehistory&#x27;, true);
                browser.setAttribute(&#x27;disablesecurity&#x27;, true);
                browser.setAttribute(&#x27;flex&#x27;, 1);
                browser.setAttribute(&#x27;id&#x27;, &#x27;sepamailRawBrowser&#x27;);
                browser.setAttribute(&#x27;name&#x27;, &#x27;sepamailRawBrowser&#x27;);
                browser.setAttribute(&#x27;src&#x27;, &#x27;about:blank&#x27;);
                browser.setAttribute(&#x27;type&#x27;, &#x27;content&#x27;);

                &#x2F;&#x2F; Add the browser to the message pane
                document.getElementById(&quot;messagepanewrapper&quot;).appendChild(browser);
            }

            &#x2F;&#x2F; Use the load event of the browser to show SEPAmail message content
            document.getElementById(&quot;sepamailRawBrowser&quot;).addEventListener(&quot;load&quot;, function load(event) {

                    &#x2F;&#x2F; Remove the listener
                    document.getElementById(&quot;sepamailRawBrowser&quot;).removeEventListener(&quot;load&quot;, load, true);

                    &#x2F;&#x2F; Display SEPAmail message content
                    SMETHRawContentController.displayMessage(this, gFolderDisplay.selectedMessage,
                        SMETHReadMessageController._smethMail.sepamailXMLObject);

                }, true);

            &#x2F;&#x2F; Load the raw mode template
            document.getElementById(&quot;sepamailRawBrowser&quot;).loadURI(&#x27;chrome:&#x2F;&#x2F;smeth&#x2F;content&#x2F;codemirror&#x2F;template&#x2F;rawModeViewerTemplate.html&#x27;);

            &#x2F;&#x2F; Show&#x2F;hide message pane controls
            document.getElementById(&quot;sepamailRawBrowser&quot;).setAttribute(&#x27;hidden&#x27;, false);
            document.getElementById(&quot;sepamailUIContainer&quot;).setAttribute(&#x27;hidden&#x27;, true);

        } else {
            document.getElementById(&quot;sepamailRawBrowser&quot;).setAttribute(&#x27;hidden&#x27;, true);
            document.getElementById(&quot;sepamailUIContainer&quot;).setAttribute(&#x27;hidden&#x27;, false);
            document.getElementById(&quot;messagepanewrapper&quot;).removeChild(document.getElementById(&quot;sepamailRawBrowser&quot;));
        }

        &#x2F;&#x2F; Remove focus from the toggle button
        button.blur();
    },

    &#x2F;**
     * initializeSEPAmailUI function initialises the SEPAmail UI
     *
     * @method initializeSEPAmailUI
     *&#x2F;
    initializeSEPAmailUI : function(){

        &#x2F;&#x2F; Toggle the message header buttons
        SMETHReadMessageController.toggleMessageHeaderButtons();

        &#x2F;&#x2F; Get message pane wrapper
        var messagePaneWrapper = document.getElementById(&quot;messagepanewrapper&quot;);

        &#x2F;&#x2F; Get and hide the message pane browser displaying the raw XML
        var messagePaneBrowser = document.getElementById(&quot;messagepane&quot;);
        messagePaneBrowser.hidden = true;

        &#x2F;&#x2F; Get the SEPAmailUIContainer
        var sepamailUIContainer = document.getElementById(&quot;sepamailUIContainer&quot;);

        &#x2F;&#x2F; Check if the sepamailUIContainer is present
        if (null != sepamailUIContainer) {

            &#x2F;&#x2F; Removes the sepamailUIContainer childrens
            while (sepamailUIContainer.hasChildNodes()) {
                sepamailUIContainer.removeChild(sepamailUIContainer.firstChild);
            }

        } else {

            &#x2F;&#x2F; Create the SEPAmailUIContainer
            sepamailUIContainer = this._smethControlFactory.createVBoxXULElement(&quot;sepamailUIContainer&quot;)
            sepamailUIContainer.setAttribute(&quot;flex&quot;, 1);

            &#x2F;&#x2F; Add a the SEPAmailUIContainer vbox in which all the parts of the SEPAmail UI will be added
            messagePaneWrapper.appendChild(sepamailUIContainer);
        }

        &#x2F;&#x2F; Get the export menu
        var menuExport = document.getElementById(&quot;menu_Export&quot;);

        &#x2F;&#x2F; Enable the export menu
        menuExport.setAttribute(&quot;disabled&quot;, &quot;false&quot;);
    },

    &#x2F;**
     * disableSEPAmailUI function disables the SEPAmail UI
     *
     * @method disableSEPAmailUI
     *&#x2F;
    disableSEPAmailUI : function() {

        &#x2F;&#x2F; Toogle the message header buttons
        SMETHReadMessageController.toggleMessageHeaderButtons();

        &#x2F;&#x2F; Get the message header toolbox
        var messageheaderToolBox = document.getElementById(&quot;dateValueBox&quot;);

        &#x2F;&#x2F; Get message pane wrapper
        var messagePaneWrapper = document.getElementById(&quot;messagepanewrapper&quot;);

        &#x2F;&#x2F; Check if the sepamailLogoBox is present
        if (null != document.getElementById(&quot;sepamailLogoBox&quot;)) {

            &#x2F;&#x2F; Removes the sepamailLogoBox
            messageheaderToolBox.removeChild(document.getElementById(&quot;sepamailLogoBox&quot;));
        }

        &#x2F;&#x2F; Remove the SMETH Raw mode button
        if (document.getElementById(&quot;smethSepamailRawModeToggle&quot;) != null) {
            messageheaderToolBox.removeChild(document.getElementById(&quot;smethSepamailRawModeToggle&quot;));
        }

        &#x2F;&#x2F; Check if the raw mode browser is available
        if (document.getElementById(&quot;sepamailRawBrowser&quot;) != null) {

            &#x2F;&#x2F; Remove the SMETH raw mode browser
            messagePaneWrapper.removeChild(document.getElementById(&quot;sepamailRawBrowser&quot;));
        }

        &#x2F;&#x2F; Check if the sepamailUIContainer is present
        if (null != document.getElementById(&quot;sepamailUIContainer&quot;)) {

            &#x2F;&#x2F; Removes the sepamailUIContainer
            messagePaneWrapper.removeChild(document.getElementById(&quot;sepamailUIContainer&quot;));
        }

        &#x2F;&#x2F; Get and show the message pane browser
        var messagePaneBrowser = document.getElementById(&quot;messagepane&quot;);
        messagePaneBrowser.hidden = false;

        &#x2F;&#x2F; Get the export menu
        var menuExport = document.getElementById(&quot;menu_Export&quot;);

        &#x2F;&#x2F; Disable the export menu
        menuExport.setAttribute(&quot;disabled&quot;, &quot;true&quot;);
    },

    &#x2F;**
     * initializeSEPAmailSMTPHeaderUI function initialises the SEPAmail SMTP header user interface
     *
     * @method initializeSEPAmailSMTPHeaderUI
     *&#x2F;
    initializeSEPAmailSMTPHeaderUI : function() {

        try {

            &#x2F;&#x2F; Get the message header toolbox
            var messageheaderToolBox = document.getElementById(&quot;dateValueBox&quot;);

            &#x2F;&#x2F; Check if the SEPAmail logo is present
            if (null == document.getElementById(&quot;sepamailLogoBox&quot;)) {

                &#x2F;&#x2F; Create the box XUL element to contain the SEPAmail logo
                var imageBoxXUL = SMETHReadMessageController._smethControlFactory.createBoxXULElement(&quot;sepamailLogoBox&quot;);

                &#x2F;&#x2F; Create the image XUL element
                var imageXUL = SMETHReadMessageController._smethControlFactory.createImageXULElement(&quot;sepamailLogo&quot;,&quot;chrome:&#x2F;&#x2F;{appname}&#x2F;skin&#x2F;images&#x2F;sepamailLogo.png&quot;, &quot;32px&quot;, &quot;32px&quot;);
                imageXUL.setAttribute(&quot;onclick&quot;, &quot;SMETHReadMessageController.handleSEPAmailInfo();&quot;);

                &#x2F;&#x2F; Append the SEPAmail logo to the box
                imageBoxXUL.appendChild(imageXUL);

                &#x2F;&#x2F; Append SEPAmail logo box to the message header toolbox
                messageheaderToolBox.insertBefore(imageBoxXUL, document.getElementById(&quot;smimeBox&quot;));
            }

            &#x2F;&#x2F; Check if we need to add the raw mode button
            if ((document.getElementById(&quot;smethSepamailRawModeToggle&quot;) == null) &amp;&amp; (document.getElementById(&quot;sepamailLogoBox&quot;) != null)) {

                &#x2F;&#x2F; Create the XUL button element
                var button = SMETHReadMessageController._smethControlFactory.createButtonXULElement(&#x27;smethSepamailRawModeToggle&#x27;, &#x27;Raw mode&#x27;);

                &#x2F;&#x2F; Set the button properties
                button.setAttribute(&#x27;type&#x27;, &#x27;checkbox&#x27;);
                button.setAttribute(&#x27;oncommand&#x27;, &#x27;SMETHReadMessageController.handleRawModeToggle();&#x27;);

                &#x2F;&#x2F; Add the button to the header
                messageheaderToolBox.insertBefore(button, document.getElementById(&quot;sepamailLogoBox&quot;));
            }

        } catch(ex) {
            throw ex;
        }

    },

    &#x2F;**
     * initializeSEPAmailBodyUI function initialises the SEPAmail body user interface
     *
     * @method initializeSEPAmailBodyUI
     *&#x2F;
    initializeSEPAmailBodyUI : function() {

        try {

            &#x2F;&#x2F; Check if we are displaying an acknowledgement
            if (this._smethMessageType == &#x27;SEPAMAIL_ACKNOWLEDGEMENT&#x27;) {

                &#x2F;&#x2F; Transform the SEPAmail acknowledgement document
                var sepamailAckBodyDocument = this._smethUtils.transformXMLDocument(this._smethMail.sepamailXMLObject,
                        this._smethPreferences.getCharPref(&quot;acknowledgement.body.XSLUrl&quot;));

                &#x2F;&#x2F; Get the sepamailUIContainer
                var sepamailAckUIContainer = document.getElementById(&quot;sepamailUIContainer&quot;);

                &#x2F;&#x2F; Appends the resulting transformation fragment first child to the sepamailUIContainer
                sepamailAckUIContainer.appendChild(sepamailAckBodyDocument.firstChild);

            } else {

                &#x2F;&#x2F; Check if the Body XSL Url is defined
                if (this._smethConfigObject.settings.body != &quot;&quot;) {

                    &#x2F;&#x2F; Transform the SEPAmail XML document
                    var sepamailBodyDocument = this._smethUtils.transformXMLDocument(this._smethMail.sepamailXMLObject,
                        &quot;chrome:&#x2F;&#x2F;{appname}&#x2F;content&#x2F;xsl&#x2F;&quot; + this._smethConfigObject.settings.body);

                    &#x2F;&#x2F; Get the sepamailUIContainer
                    var sepamailUIContainer = document.getElementById(&quot;sepamailUIContainer&quot;);

                    &#x2F;&#x2F; Appends the resulting transformation fragment first child to the sepamailUIContainer
                    sepamailUIContainer.appendChild(sepamailBodyDocument.firstChild);

                } else {
                    throw new Error(&quot;XSL Url for SEPAmail body is not define in the configuration file&quot;);
                }
            }

        } catch(ex) {
            throw ex;
        }
    },

    &#x2F;**
     * initializeSEPAmailAttachmentUI function initialises the SEPAmail attachment user interface
     *
     * @method initializeSEPAmailAttachmentUI
     *&#x2F;
    initializeSEPAmailAttachmentUI : function() {

        try {

            &#x2F;&#x2F; Declare the attachment XSL url
            var attachmentXSLUrl = this._smethPreferences.getCharPref(&quot;missive.attachment&quot;);

            &#x2F;&#x2F; Check if the attachment XSL Url is define
            if (attachmentXSLUrl != &#x27;&#x27;) {

                &#x2F;&#x2F; Transform the SEPAmail XML document
                var sepamailAttachmentDocument = this._smethUtils.transformXMLDocument(this._smethMail.sepamailXMLObject, &quot;chrome:&#x2F;&#x2F;{appname}&#x2F;content&#x2F;xsl&#x2F;&quot; + attachmentXSLUrl);

                &#x2F;&#x2F; Get the sepamailUIContainer
                var sepamailUIContainer = document.getElementById(&quot;sepamailUIContainer&quot;);

                &#x2F;&#x2F; Appends the resulting transformation fragment first child to the sepamailUIContainer
                sepamailUIContainer.appendChild(sepamailAttachmentDocument.firstChild);

                &#x2F;&#x2F; Calculates and sets the attachements size
                SMETHAttachmentController.calculateAttachmentSize();

            } else {
                throw new Error(&quot;XSL Url for SEPAmail attachment is not define in the configuration file&quot;);
            }

        } catch(ex) {
            throw ex;
        }
    },

    &#x2F;**
     * checkAttachmentsContentType function checks if the mail content
     * contains an attachement of the parametred content type
     *
     * @method checkAttachmentsContentType
     * @param {Object} aMailContent Object
     * @param {String} aContentType String
     * @return {Boolean} Whether the mail is of type xml
     *&#x2F;
    checkAttachmentsContentType : function(aMailContent, aContentType){

        try
        {
            for (var i = 0; i &lt; aMailContent.allAttachments.length; i++) {
                if(aContentType == aMailContent.allAttachments[i].contentType) {
                    return true;
                } else {
                    return false;
                }
            }

            return false;

        } catch(ex) {
            throw ex;
        }
    },

    &#x2F;**
     * toggleMessageHeaderButtons function toggle the message header buttons depending whether its a SEPAmail or not
     *
     * @method toggleMessageHeaderButtons
     *&#x2F;
    toggleMessageHeaderButtons : function()
    {
        try
        {
            &#x2F;&#x2F; Get the header view toolbar
            var headerViewToolbar = document.getElementById(&quot;header-view-toolbar&quot;);

            &#x2F;&#x2F; Get the header other actions button
            var otherActionsButton = document.getElementById(&quot;otherActionsButton&quot;);

            &#x2F;&#x2F; Get the header subject row and textbox
            var subjectRow = document.getElementById(&quot;expandedsubjectRow&quot;);

            &#x2F;&#x2F; Get the to label
            var toLabel = document.getElementById(&quot;expandedtoLabel&quot;);

            if (SMETHReadMessageController._smethMail.isSEPAmail)
            {

                &#x2F;&#x2F; Hide the header buttons
                headerViewToolbar.hidden = true;
                otherActionsButton.hidden = true;

                &#x2F;&#x2F; Hide Subject
                if(SMETHReadMessageController._smethMail.header.subject == &quot;&quot;)
                {
                    &#x2F;&#x2F; Collapse the subject row
                    subjectRow.collapsed = true;

                    &#x2F;&#x2F; Correct the to label when the subject row is collapsed
                    toLabel.setAttribute(&quot;style&quot;, &quot;margin-left:2.8em;&quot;);
                }
                else
                {
                    &#x2F;&#x2F; Expand the subject row
                    subjectRow.collapsed = false;

                    &#x2F;&#x2F; Remove the correction for the to label
                    toLabel.removeAttribute(&quot;style&quot;);
                }
            }
            else
            {
                &#x2F;&#x2F; Unhide the header buttons
                headerViewToolbar.hidden = false;
                otherActionsButton.hidden = false;

                &#x2F;&#x2F;&#x2F; Expand the subject row
                subjectRow.collapsed = false;

                 &#x2F;&#x2F; Remove the correction for the to label
                toLabel.removeAttribute(&quot;style&quot;);
            }
        }
        catch(ex)
        {
            throw ex;
        }
    },

    &#x2F;**
     * handleReportButtonClick function handles the click event for report buttons
     *
     * @method handleReportButtonClick
     * @param {String} anXSLUrl XSL Url for report form
     *&#x2F;
    handleReportButtonClick : function (anXSLUrl) {

        try {

            &#x2F;&#x2F; Transform the SEPAmail XML document to get the report XML
            var sepamailReportDocument = this._smethUtils.transformXMLDocument(this._smethMail.sepamailXMLObject, &quot;chrome:&#x2F;&#x2F;{appname}&#x2F;content&#x2F;xsl&#x2F;&quot; + anXSLUrl);

            &#x2F;&#x2F; Get the account that will be used to send the report
            var account = SMETHReadMessageController._smethUtils.getAccountByMsgHeader(this._smethMail.header);

            &#x2F;&#x2F; Open the compose window
            this._smethUtils.openComposeWindow((new XMLSerializer()).serializeToString(sepamailReportDocument), account,
                this._smethMail.header, SMETHTranslations.mailSubject);

        } catch (ex) {
            throw ex;
        }
    },

    &#x2F;**
     * defaultSmethAccount function returns the default smeth account to send mail
     *
     * @method getDefaultSmethAccount
     * @return {Object} Default smeth account to send mail
     * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Thunderbird&#x2F;Account_interfaces
     * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Thunderbird&#x2F;Account_examples
     *&#x2F;
    getDefaultSmethAccount : function() {
        try
        {
            &#x2F;&#x2F; Intantiate the account manager interface
            &#x2F;&#x2F; @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Thunderbird&#x2F;Account_interfaces
            &#x2F;&#x2F; @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Thunderbird&#x2F;Account_examples
            var accountMgr = Components.classes[&quot;@mozilla.org&#x2F;messenger&#x2F;account-manager;1&quot;]
                             .getService(Components.interfaces.nsIMsgAccountManager);

            &#x2F;&#x2F; Get the acceptation report XSL url based on the SEPAmail type and SEPAmail Message Type
            var smethAccountEmail = this._smethPreferences.getCharPref( &quot;defaultAccountEmail&quot;);

            if (&quot;&quot; != smethAccountEmail) {

                var accounts = accountMgr.accounts;

                for (var i = 0; i &lt; accounts.Count(); i++){

                    var account = accounts.QueryElementAt(i, Components.interfaces.nsIMsgAccount);

                    if (account.defaultIdentity) {

                        if (smethAccountEmail == account.defaultIdentity.email) {
                            return account;
                        }
                    }
                }

            } else {
                 throw new Error(&quot;Default SMETH account is not define in the configuration file so we are using the default thunderbird account.&quot;);
            }

            return accountMgr.defaultAccount;

        } catch (ex) {
            throw ex;
        }
    },

    &#x2F;**
     * composeGenericButtonClick function handles the click event for the composeGenericButton
     *
     * @method composeGenericButtonClick
     * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Extensions&#x2F;Thunderbird&#x2F;HowTos&#x2F;Common_Thunderbird_Use_Cases&#x2F;Compose_New_Message
     * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;XPCOM_Interface_Reference&#x2F;nsIIOService
     *&#x2F;
    composeGenericButtonClick : function() {

        try {

            &#x2F;&#x2F; Get account to send message
            var account = this._getMessageCompositionAccount();

            &#x2F;&#x2F; Check if we have an appriate account to compose a message
            if (account != null) {

                &#x2F;&#x2F; Open message composition window with appropriate content
                this._openMessageComposition(account,
                    this._smethUtils.getTemplateForMessageType(&#x27;send.request@generic&#x27;));

            } else {
                alert(SMETHTranslations.noSuitableAccounts);
            }

        } catch (ex) {
            throw ex;
        }
    },

    &#x2F;**
     * composeMandateInitiationRequestButtonClick function handles the click event for the composeMandateInitiationRequestButton
     *
     * @method composeMandateInitiationRequestButtonClick
     * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Extensions&#x2F;Thunderbird&#x2F;HowTos&#x2F;Common_Thunderbird_Use_Cases&#x2F;Compose_New_Message
     * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;XPCOM_Interface_Reference&#x2F;nsIIOService
     *&#x2F;
    composeMandateInitiationRequestButtonClick : function() {

        try {

            &#x2F;&#x2F; Get account to send message
            var account = this._getMessageCompositionAccount();

            &#x2F;&#x2F; Check if we have an appriate account to compose a message
            if (account != null) {

                &#x2F;&#x2F; Open message composition window with appropriate content
                this._openMessageComposition(account,
                    this._smethUtils.getTemplateForMessageType(&#x27;mandat@direct.debit&#x27;));

            } else {
                alert(SMETHTranslations.noSuitableAccounts);
            }

        } catch (ex) {
            throw ex;
        }
    },

    &#x2F;**
     * composePrenotificationButtonClick function handles the click event for the composePrenotificationButton
     *
     * @method composePrenotificationButtonClick
     * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Extensions&#x2F;Thunderbird&#x2F;HowTos&#x2F;Common_Thunderbird_Use_Cases&#x2F;Compose_New_Message
     * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;XPCOM_Interface_Reference&#x2F;nsIIOService
     *&#x2F;
    composePrenotificationButtonClick : function() {

        try {

            &#x2F;&#x2F; Get account to send message
            var account = this._getMessageCompositionAccount();

            &#x2F;&#x2F; Check if we have an appriate account to compose a message
            if (account != null) {

                &#x2F;&#x2F; Open message composition window with appropriate content
                this._openMessageComposition(account,
                    this._smethUtils.getTemplateForMessageType(&#x27;notification@direct.debit&#x27;));

            } else {
                alert(SMETHTranslations.noSuitableAccounts);
            }

        } catch (ex) {
            throw ex;
        }
    },

    &#x2F;**
     * composeRequestForCopyButtonClick function handles the click event for the composeRequestForCopyButton
     *
     * @method composeRequestForCopyButtonClick
     * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Extensions&#x2F;Thunderbird&#x2F;HowTos&#x2F;Common_Thunderbird_Use_Cases&#x2F;Compose_New_Message
     * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;XPCOM_Interface_Reference&#x2F;nsIIOService
     *&#x2F;
    composeRequestForCopyButtonClick : function() {

        try {

            &#x2F;&#x2F; Get account to send message
            var account = this._getMessageCompositionAccount();

            &#x2F;&#x2F; Check if we have an appriate account to compose a message
            if (account != null) {

                &#x2F;&#x2F; Open message composition window with appropriate content
                this._openMessageComposition(account,
                    this._smethUtils.getTemplateForMessageType(&#x27;request.copy@direct.debit&#x27;));

            } else {
                alert(SMETHTranslations.noSuitableAccounts);
            }

        } catch (ex) {
            throw ex;
        }
    },

    &#x2F;**
     * composeRequestButtonClick function handles the click event for the composeRequestButton
     *
     * @method composeRequestButtonClick
     * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Extensions&#x2F;Thunderbird&#x2F;HowTos&#x2F;Common_Thunderbird_Use_Cases&#x2F;Compose_New_Message
     * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;XPCOM_Interface_Reference&#x2F;nsIIOService
     *&#x2F;
    composeRequestButtonClick : function() {

        try {

            &#x2F;&#x2F; Get account to send message
            var account = this._getMessageCompositionAccount();

            &#x2F;&#x2F; Check if we have an appriate account to compose a message
            if (account != null) {

                &#x2F;&#x2F; Open message composition window with appropriate content
                this._openMessageComposition(account,
                    this._smethUtils.getTemplateForMessageType(&#x27;activation.request@payment.activation&#x27;));

            } else {
                alert(SMETHTranslations.noSuitableAccounts);
            }

        } catch (ex) {
            throw ex;
        }
    },

    &#x2F;**
     * composeTestRequestButtonClick function handles the click event for the composeTestRequestButton
     *
     * @method composeTestRequestButtonClick
     * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Extensions&#x2F;Thunderbird&#x2F;HowTos&#x2F;Common_Thunderbird_Use_Cases&#x2F;Compose_New_Message
     * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;XPCOM_Interface_Reference&#x2F;nsIIOService
     *&#x2F;
    composeTestRequestButtonClick : function() {

        try {

            &#x2F;&#x2F; Get account to send message
            var account = this._getMessageCompositionAccount();

            &#x2F;&#x2F; Check if we have an appriate account to compose a message
            if (account != null) {

                &#x2F;&#x2F; Open message composition window with appropriate content
                this._openMessageComposition(account,
                    this._smethUtils.getTemplateForMessageType(&#x27;simple.request@test&#x27;));

            } else {
                alert(SMETHTranslations.noSuitableAccounts);
            }

        } catch (ex) {
            throw ex;
        }
    },

    &#x2F;**
     * handleSEPAmailInfo function handles SEPAmail logo click event
     *
     * @method handleSEPAmailInfo
     *&#x2F;
    handleSEPAmailInfo : function() {

        &#x2F;&#x2F; Create the SEPAmail namespace resolver object
        var sender, qxban;

        switch (SMETHReadMessageController._smethMessageType) {

            case &#x27;SEPAMAIL_ACKNOWLEDGEMENT&#x27;:

                try {

                    &#x2F;&#x2F; Get the sender
                    sender = this._smethMail.sepamailXMLObject.evaluate(&quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvHdr&#x2F;sem:Snd&#x2F;sem:IBAN&quot;, this._smethMail.sepamailXMLObject, this._smethUtils.nsResolver, XPathResult.STRING_TYPE,null).stringValue;
                    qxban = this._smethMail.sepamailXMLObject.evaluate(&quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvHdr&#x2F;sem:Snd&#x2F;sem:IBAN&quot;, this._smethMail.sepamailXMLObject, this._smethUtils.nsResolver, XPathResult.STRING_TYPE,null).stringValue;

                } catch (e) {
                    SMETHReadMessageController._smethMessageHandler.exception(e);
                }

                break;

            case &#x27;SEPAMAIL_REQUEST&#x27;:

                try {

                    &#x2F;&#x2F; Get the sender
                    sender = this._smethMail.sepamailXMLObject.evaluate(&quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvBdy&#x2F;sem:sepamail_message_001&#x2F;sem:MsgBdy&#x2F;sem:ActivationRequest&#x2F;sem:ReqCompl&#x2F;sem:Request&#x2F;pain013:PmtInf&#x2F;pain013:Dbtr&#x2F;pain013:Nm&quot;, this._smethMail.sepamailXMLObject, this._smethUtils.nsResolver, XPathResult.STRING_TYPE,null).stringValue;
                    qxban = this._smethMail.sepamailXMLObject.evaluate(&quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvHdr&#x2F;sem:Snd&#x2F;sem:IBAN&quot;, this._smethMail.sepamailXMLObject, this._smethUtils.nsResolver, XPathResult.STRING_TYPE,null).stringValue;

                } catch (e) {
                    SMETHReadMessageController._smethMessageHandler.exception(e);
                }

                break;

            default:
                &#x2F;&#x2F; We do not handle other types of content and allow Thunderbird to control the sending of messages
        }

        &#x2F;&#x2F; Open the dialogue
        window.openDialog(&quot;chrome:&#x2F;&#x2F;Smeth&#x2F;content&#x2F;SMETHInfoView.xul&quot;, &quot;&quot;, &quot;chrome,resizable=1,modal=1,dialog=1&quot;,sender,qxban);

    },

    &#x2F;**
     * Handle the message added event
     *
     * @method msgAdded
     * @param {Object} aMsgHdr Header of the message being added to the mail session
     *&#x2F;
    msgAdded : function(aMsgHdr) {

        &#x2F;&#x2F; Check if message is new
        if (!aMsgHdr.isRead) {

            &#x2F;&#x2F; Add a message header to the automatic acknowledgement processing queue
            SMETHAutomaticAcknowledgementController.addToProcessQueue(aMsgHdr);
        }

    },

    &#x2F;**
     * Get the status of a given email account
     *
     * @method _getAccountStatus
     * @param {Object} account Email account object
     * @return The status of the given account
     *&#x2F;
    _getAccountStatus : function(account) {

        &#x2F;&#x2F; Check if the account key has been defined
        if (account.key != null) {

            &#x2F;&#x2F; Scan the list of email accounts for which SEPAmail accounts have been configured
            for (var i = 0; i &lt; this._smethEmailToQxbanObj.length; i++) {

                &#x2F;&#x2F; Check if we are at the required account
                if (this._smethEmailToQxbanObj[i].account == account.key) {

                    &#x2F;&#x2F; Get the status of the email account
                    return this._smethEmailToQxbanObj[i].status;
                }
            }
        }

        return &#x27;INACTIVE&#x27;;
    },

    &#x2F;**
     * Get the default active SEPAmail account
     *
     * @method _getDefaultActiveAccount
     * @return Default active account or null if the account has not been defined
     *&#x2F;
    _getDefaultActiveAccount : function() {

        &#x2F;&#x2F; Key of the default SEPAmail account
        var defaultAccountKey = null;

        &#x2F;&#x2F; Get the key of the default account
        for (var i = 0; i &lt; this._smethEmailToQxbanObj.length; i++) {

            &#x2F;&#x2F; Check the status of the current account
            if (this._smethEmailToQxbanObj[i].status == &#x27;DEFAULT_ACTIVE&#x27;) {
                defaultAccountKey = this._smethEmailToQxbanObj[i].account;
                break;
            }
        }

        &#x2F;&#x2F; Check if the key of the default account has been found
        if (defaultAccountKey != null) {

            &#x2F;&#x2F; Account manager interface instance
            var accountManager = Components.classes[&quot;@mozilla.org&#x2F;messenger&#x2F;account-manager;1&quot;]
                                           .getService(Components.interfaces.nsIMsgAccountManager);

            &#x2F;&#x2F; List of registered accounts
            var accounts = accountManager.accounts;

            &#x2F;&#x2F; Scan the list of accounts
            for (var j = 0; j &lt; accounts.Count(); j++) {

                &#x2F;&#x2F; Current account
                var currentAccount = accounts.QueryElementAt(j, Components.interfaces.nsIMsgAccount);

                &#x2F;&#x2F; Check the key of the current account
                if (currentAccount.key == defaultAccountKey) {
                    return currentAccount;
                }
            }
        }

        return null;
    },

    &#x2F;**
     * _getMessageCompositionAccount gets the account by which a message needs to be composed
     *
     * @method _getMessageCompositionAccount
     * @return The account that needs to be used to send a SEPAmail message
     *&#x2F;
    _getMessageCompositionAccount : function() {

        &#x2F;&#x2F; Reload the SEPAmail account preferences &quot;myqxbans&quot;
        this._smethEmailToQxbanObj = JSON.parse(this._smethPreferences.getCharPref(&#x27;myqxbans&#x27;));

        &#x2F;&#x2F; Composition account
        var account = null;

        &#x2F;&#x2F; Get the currently selected folder
        var msgFolder = gFolderDisplay ? GetFirstSelectedMsgFolder() : null;

        &#x2F;&#x2F; Check if a folder has been selected
        if (msgFolder != null) {

            &#x2F;&#x2F; Selected folder related account
            account = this._smethUtils.getAccountByFolder(msgFolder);

            &#x2F;&#x2F; Check if an account was obtained
            if (account != null) {

                &#x2F;&#x2F; Check the status of the account
                if (this._getAccountStatus(account) == &#x27;INACTIVE&#x27;) {

                    &#x2F;&#x2F; Get the default SEPAmail account since selected account is not active
                    account = this._getDefaultActiveAccount();
                }
            }

        } else {

            &#x2F;&#x2F; Get default SEPAmail account
            account = this._getDefaultActiveAccount();
        }

        &#x2F;&#x2F; Check if an account for sending message has been determined
        if (account == null) {

            &#x2F;&#x2F; Check if user selected a folder
            if (msgFolder != null) {

                &#x2F;&#x2F; Use selected folder account to send SEPAmail message
                account = this._smethUtils.getAccountByFolder(msgFolder);

            } else {

                &#x2F;&#x2F; Account manager interface instance
                var accountManager = Components.classes[&quot;@mozilla.org&#x2F;messenger&#x2F;account-manager;1&quot;]
                                               .getService(Components.interfaces.nsIMsgAccountManager);

                &#x2F;&#x2F; List of registered accounts
                var accounts = accountManager.accounts;

                &#x2F;&#x2F; Check the number of accounts defined
                if (accounts.Count() &gt; 0) {
                    account = accounts.QueryElementAt(0, Components.interfaces.nsIMsgAccount);
                }
            }
        }

        return account;
    },

    &#x2F;**
     * Open a message composition window for a given template file name and account
     *
     * @method _openMessageComposition
     * @param {Object} account Thunderbird account object
     * @param {String} templateUrl The URL of the message type XML template
     *&#x2F;
    _openMessageComposition : function(account, templateUrl) {

        &#x2F;&#x2F; Decalre the XMLHttpRequest to load the template XML
        var xmlHttpRequest = new XMLHttpRequest();

        &#x2F;&#x2F; Send request for the template XML document
        xmlHttpRequest.open(&#x27;GET&#x27;, templateUrl, false);
        xmlHttpRequest.send();

        &#x2F;&#x2F; Get the temple XML document object
        var templateXMLDocument = xmlHttpRequest.responseXML;

        &#x2F;&#x2F; Compose service fields instance
        &#x2F;&#x2F; @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;XPCOM_Interface_Reference&#x2F;NsIMsgCompFields
        var composeFields = Components.classes[&quot;@mozilla.org&#x2F;messengercompose&#x2F;composefields;1&quot;]
                                      .createInstance(Components.interfaces.nsIMsgCompFields);

        composeFields.body = ((new XMLSerializer()).serializeToString(templateXMLDocument));
        composeFields.characterSet = &quot;UTF-8&quot;;
        composeFields.from = account.defaultIdentity.email;

        &#x2F;&#x2F; Message compose parameters instance
        &#x2F;&#x2F; @see http:&#x2F;&#x2F;doxygen.db48x.net&#x2F;mozilla-full&#x2F;html&#x2F;da&#x2F;d05&#x2F;interfacensIMsgComposeParams.html
        var msgComposeParams = Components.classes[&quot;@mozilla.org&#x2F;messengercompose&#x2F;composeparams;1&quot;]
                                         .createInstance(Components.interfaces.nsIMsgComposeParams);

        &#x2F;&#x2F; Define the message composition parameters
        msgComposeParams.composeFields = composeFields;
        msgComposeParams.identity = account.defaultIdentity;
        msgComposeParams.format = Components.interfaces.nsIMsgCompFormat.PlainText
        msgComposeParams.type = Components.interfaces.nsIMsgCompType.New;

        &#x2F;&#x2F; Message compose service
        &#x2F;&#x2F; @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Extensions&#x2F;Thunderbird&#x2F;HowTos&#x2F;Common_Thunderbird_Use_Cases&#x2F;Compose_New_Message
        var msgComposeService = Components.classes[&quot;@mozilla.org&#x2F;messengercompose;1&quot;]
                                          .getService(Components.interfaces.nsIMsgComposeService);

        &#x2F;&#x2F; Remove vCards and signatures from missive email
        this._smethUtils.removeEmailExtras(msgComposeService);

        &#x2F;&#x2F; Open the acknowledgement message
        msgComposeService.OpenComposeWindowWithParams(null, msgComposeParams);
    }
}

&#x2F;&#x2F; Add the window load event listener
&#x2F;&#x2F; Entry point of the Smeth plugin
&#x2F;&#x2F; @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Code_snippets&#x2F;On_page_load
window.addEventListener(&quot;load&quot;, function load(event) {

    try {

        &#x2F;&#x2F;remove listener, no longer needed
        window.removeEventListener(&quot;load&quot;, load, false);

        &#x2F;&#x2F; Get the message pane
        var messagepane = document.getElementById(&quot;messagepane&quot;);

        &#x2F;&#x2F; Check if the message pane is valid
        if (messagepane) {

            &#x2F;&#x2F; Initialize the SMETHReadMessageController
            SMETHReadMessageController.init();

            &#x2F;&#x2F; Initialise the automatic acknowledgement controller
            SMETHAutomaticAcknowledgementController.init();

            &#x2F;&#x2F; Add load event for message pane to be triggered on each message select
            &#x2F;&#x2F; @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Code_snippets&#x2F;On_page_load
            messagepane.addEventListener(&quot;load&quot;, function(event) {SMETHReadMessageController.onMessagePaneLoad(event);}, true);
        }

        &#x2F;&#x2F; Message listener service
        &#x2F;&#x2F; @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Extensions&#x2F;Thunderbird&#x2F;HowTos&#x2F;Common_Thunderbird_Use_Cases&#x2F;Open_Folder
        var notificationService = Components.classes[&quot;@mozilla.org&#x2F;messenger&#x2F;msgnotificationservice;1&quot;]
                                            .getService(Components.interfaces.nsIMsgFolderNotificationService);

        &#x2F;&#x2F; Register listener for new messages
        &#x2F;&#x2F; @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Extensions&#x2F;Thunderbird&#x2F;HowTos&#x2F;Common_Thunderbird_Use_Cases&#x2F;Open_Folder
        notificationService.addListener(SMETHReadMessageController, notificationService.msgAdded);

        &#x2F;&#x2F; Mail session instance
        var mailSession = Components.classes[&quot;@mozilla.org&#x2F;messenger&#x2F;services&#x2F;session;1&quot;]
                                    .getService(Components.interfaces.nsIMsgMailSession);

        &#x2F;&#x2F; Define listeners for mail session events
        var folderListener = {
            OnItemAdded: function(parent, item, viewString) {},
            OnItemRemoved: function(parent, item, viewString) {},
            OnItemPropertyChanged: function(parent, item, viewString) {},
            OnItemIntPropertyChanged: function(item, property, oldValue, newValue) {},
            OnItemBoolPropertyChanged: function(item, property, oldValue, newValue) {},
            OnItemUnicharPropertyChanged: function(item, property, oldValue, newValue) {},
            OnItemPropertyFlagChanged: function(item, property, oldFlag, newFlag) {},
            OnItemEvent: function(item, event) {
                SMETHMessageListController.OnItemEvent(item, event);
                SMETHAutomaticAcknowledgementController.processQueue(item, event);
            },
            OnDeleteOrMoveMessagesCompleted: function(aFolder) {}
        }

        &#x2F;&#x2F; Register listener on all folders of the mail session
        mailSession.AddFolderListener(folderListener, Components.interfaces.nsIFolderListener.all);

    } catch(ex) {
        SMETHReadMessageController._smethMessageHandler.exception(ex);
    }

}, false);
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
