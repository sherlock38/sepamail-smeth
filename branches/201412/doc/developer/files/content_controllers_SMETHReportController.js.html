<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>content&#x2F;controllers&#x2F;SMETHReportController.js</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.8.0pr2&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.8.0pr2&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="..&#x2F;assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/SMETHAcknowledgementController.html">SMETHAcknowledgementController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHAcknowledgementPreferencesController.html">SMETHAcknowledgementPreferencesController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHAddressBookController.html">SMETHAddressBookController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHAdvancedPreferencesController.html">SMETHAdvancedPreferencesController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHAttachmentController.html">SMETHAttachmentController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHAutomaticAcknowledgementController.html">SMETHAutomaticAcknowledgementController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHBankPreferencesController.html">SMETHBankPreferencesController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHComposeMessageController.html">SMETHComposeMessageController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHControlFactory.html">SMETHControlFactory</a></li>
            
                <li><a href="..&#x2F;classes/SMETHExportController.html">SMETHExportController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHHeaderController.html">SMETHHeaderController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHMail.html">SMETHMail</a></li>
            
                <li><a href="..&#x2F;classes/SMETHMailPreferencesController.html">SMETHMailPreferencesController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHMessageHandler.html">SMETHMessageHandler</a></li>
            
                <li><a href="..&#x2F;classes/SMETHMessageListController.html">SMETHMessageListController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHOptionController.html">SMETHOptionController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHRawContentController.html">SMETHRawContentController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHReadMessageController.html">SMETHReadMessageController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHReportController.html">SMETHReportController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHRequestController.html">SMETHRequestController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHUtils.html">SMETHUtils</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="..&#x2F;modules/smeth.html">smeth</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: content&#x2F;controllers&#x2F;SMETHReportController.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x2F;* ***** BEGIN LICENSE BLOCK *****
 * This file is part of smeth (https:&#x2F;&#x2F;code.google.com&#x2F;p&#x2F;sepamail-smeth&#x2F;)
 *
 * Version: MPL 2.0&#x2F;GPL 3.0&#x2F;LGPL 3.0
 *
 * The contents of this file are subject to the Mozilla Public License Version
 * 2.0 (the &quot;License&quot;); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 * http:&#x2F;&#x2F;www.mozilla.org&#x2F;MPL&#x2F;2.0&#x2F;
 *
 * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,
 * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
 * for the specific language governing rights and limitations under the
 * License.
 *
 * The Initials Developers of the Original Code are :
 *  Ammit Heeramun, idSoft
 *  Bishan Kumar Madhoo, idSoft
 *  Manfred Sherlock Olm, deciBI &amp; vizGet
 * Portions created by the Initials Developers are Copyright (C) 2012
 * the Initial Developer. All Rights Reserved.
 *
 * Contributor(s):
 *  Ammit Heeramun
 *  Bishan Kumar Madhoo
 *  Manfred Sherlock Olm, smeth@decibi.fr
 *
 * Alternatively, the contents of this file may be used under the terms of
 * either the GNU General Public License Version 3 or later (the &quot;GPL&quot;), or
 * the GNU Lesser General Public License Version 3.0 or later (the &quot;LGPL&quot;),
 * in which case the provisions of the GPL or the LGPL are applicable instead
 * of those above. If you wish to allow use of your version of this file only
 * under the terms of either the GPL or the LGPL, and not to allow others to
 * use your version of this file under the terms of the MPL, indicate your
 * decision by deleting the provisions above and replace them with the notice
 * and other provisions required by the GPL or the LGPL. If you do not delete
 * the provisions above, a recipient may use your version of this file under
 * the terms of any one of the MPL, the GPL or the LGPL.
 *
 * ***** END LICENSE BLOCK ***** *&#x2F;

&#x2F;**
 * @module smeth
 * @file SMETHReportController.js
 * @mvc controller
 * @version 1212
 * @since 1210
 * @author Ammit Heeramun
 * @description SMETHReportController is the class that is responsible for the composition and sending of SEPAmail reports(Simple Test and Activation)
 *&#x2F;

&#x2F;**
 * SMETHMessageHandler class contain functions to handle info, error, warning and exceptions messages
 *
 * @include SMETHMessageHandler.js
 *&#x2F;
Components.utils.import(&quot;resource:&#x2F;&#x2F;smeth&#x2F;smethlib&#x2F;SMETHMessageHandler.js&quot;);

&#x2F;**
 * @description Strict mode for scripts
 * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;JavaScript&#x2F;Reference&#x2F;Functions_and_function_scope&#x2F;Strict_mode
 *&#x2F;
&quot;use strict&quot;;

&#x2F;**
 * SMETHReportController class defines all the events that is related to the compose report window
 *
 * @class SMETHReportController
 *
 *&#x2F;
var SMETHReportController = {

   &#x2F;**
    * Declare the SMETHMessageHandler class
    *
    * @attribute _smethMessageHandler
    * @private
    *&#x2F;
    _smethMessageHandler : new SMETHMessageHandler(window),

   &#x2F;**
    * Preferences object
    *
    * @attribute _smethPreferences
    * @private
    * @default null
    *&#x2F;
    _smethPreferences : null,

   &#x2F;**
    * Declare the content document
    *
    * @attribute _content
    * @private
    * @default null
    *&#x2F;
    _content : null,

   &#x2F;**
    * XML Object
    *
    * @attribute _contentXMLObject
    * @private
    * @default null
    *&#x2F;
    _contentXMLObject : null,

   &#x2F;**
    * Smeth message type
    *
    * @attribute _smethMessageType
    * @private
    * @default null
    *&#x2F;
    _smethMessageType : null,

   &#x2F;**
    * Smeth report status
    *
    * @attribute _smethReportStatus
    * @private
    * @default null
    *&#x2F;
    _smethReportStatus : null,

   &#x2F;**
    * Smeth utils object
    *
    * @attribute _smethUtils
    * @private
    * @default null
    *&#x2F;
    _smethUtils : null,

    &#x2F;**
     *_init fucntion Initialises all the objects that will be used in &quot;SMETHReportController&quot;
     *
     * @method _init
     * @private
     * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Code_snippets&#x2F;Preferences#XPCOM_interfaces_for_preferences_system
     *&#x2F;
    _init:function() {

        &#x2F;&#x2F; Instantiate the SMETHUtils class
        this._smethUtils = new SMETHUtils(window);

        &#x2F;&#x2F; Initialise the preference object
        &#x2F;&#x2F; @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Code_snippets&#x2F;Preferences#XPCOM_interfaces_for_preferences_system
        this._smethPreferences = Components.classes[&quot;@mozilla.org&#x2F;preferences-service;1&quot;]
                                           .getService(Components.interfaces.nsIPrefService)
                                           .getBranch(&quot;extensions.smeth.&quot;);

        this._smethPreferences.QueryInterface(Components.interfaces.nsIPrefBranch2);
    },

    &#x2F;**
     * AttachDocumentEventHandler event handles the attachement of SEPAmail Documents
     *
     * @method AttachDocumentEventHandler
     *&#x2F;
    AttachDocumentEventHandler : function() {

        try {

            switch(SMETHReportController._smethMessageType) {

                case &quot;simple.report@test&quot;:
                    this._appendAttachmentToTestXmlDocument(SMETHReportController._smethUtils.getFile(&quot;Open document to attach&quot;));
                    break;

                default:
                    SMETHReportController._smethMessageHandler.info(&quot;Attachments not yet handled for other type of reports&quot;);
                    break;
            }

        } catch(ex) {
            SMETHReportController._smethMessageHandler.exception(ex);
        }
    },

    &#x2F;**
     * NotifyComposeBodyReady event notifies when the compose body is ready
     *
     * @method NotifyComposeBodyReady
     *&#x2F;
    NotifyComposeBodyReady: function() {

        try {

            switch(SMETHReportController._smethMessageType) {

                case &quot;activation.report@payment.activation&quot;:

                    &#x2F;&#x2F; Get the report status XPath
                    var reportStatusXpath = this._smethPreferences.getCharPref(&quot;missive.activation.report.statusXpath&quot;);

                    &#x2F;&#x2F; Get the SEPAmail message type using Xpath
                    this._smethReportStatus = this._contentXMLObject.evaluate(reportStatusXpath, this._contentXMLObject, SMETHReportController._smethUtils.nsResolver, XPathResult.STRING_TYPE,null).stringValue;

                    break;

                default:
                    break;
            }

            &#x2F;&#x2F; Transform the SEPAmail XML document
            var sepamailComposeBody = this.transformXMLDocument(this._contentXMLObject,
                SMETHReportController._smethUtils.getCompositionTransformationForMessageType(SMETHReportController._smethMessageType));

            &#x2F;&#x2F; Get the content window
            var smethComposeBodyFormContainer = document.getElementById(&quot;smethComposeBodyFormContainer&quot;);

            &#x2F;&#x2F; Set translated labels for SMETH UI controls
            sepamailComposeBody = SMETHReportController._smethUtils.translateSEPAmailDocument(sepamailComposeBody, SEMTHReportComposeWindowTranslations);

            &#x2F;&#x2F; Append the child to the content frame
            smethComposeBodyFormContainer.appendChild(sepamailComposeBody.firstChild);

            &#x2F;&#x2F; Initialise attachment UI
            this._initializeAttachmentUI(this._contentXMLObject);

        } catch(ex) {
            SMETHReportController._smethMessageHandler.exception(ex);
        }
    },

    &#x2F;**
     * SendMailEventHandler event handles the send event of an email
     *
     * @method SendMailEventHandler
     * @param {Object} anEvent Event parameters
     *&#x2F;
    SendMailEventHandler : function(anEvent) {

        try {

            &#x2F;&#x2F; Get the message compose window
            var msgcomposeWindow = document.getElementById(&quot;msgcomposeWindow&quot;);

            &#x2F;&#x2F; Get the message type
            var msg_type = msgcomposeWindow.getAttribute(&quot;msgtype&quot;);

            &#x2F;&#x2F; Check if it is an actual send event
            if (!(msg_type == nsIMsgCompDeliverMode.Now || msg_type == nsIMsgCompDeliverMode.Later)) {
                return;
            }

            &#x2F;&#x2F; Get the current editor
            var editor = GetCurrentEditor();

            &#x2F;&#x2F; Begin the transaction
            editor.beginTransaction();

            &#x2F;&#x2F; Set the date and time at which message is being sent
            SMETHReportController._smethUtils.setSendDateTime(this._contentXMLObject);

            &#x2F;&#x2F; Set the message expiry of the request
            SMETHReportController._smethUtils.setMessageExpiry(this._contentXMLObject);

            &#x2F;&#x2F; Polulate the values of the missive header
            this._populateMissiveHeader();

            &#x2F;&#x2F; Populate the QXBANS
            if (SMETHReportController._smethUtils.populateQXBAN(gMsgCompose, document, this._contentXMLObject)) {

                &#x2F;&#x2F; Get the mode for the message type
                var mode = SMETHReportController._smethUtils.getMessageTypeMode(SMETHReportController._smethMessageType);

                &#x2F;&#x2F; Get the encrypt checkbox menu item
                var menuSecurityEncryptRequire = document.getElementById(&quot;menu_securityEncryptRequire2&quot;);

                &#x2F;&#x2F; Get the sign checkbox menu item
                var menuSecuritySign = document.getElementById(&quot;menu_securitySign2&quot;);

                &#x2F;&#x2F; Check if we are in the production mode
                if (mode == &#x27;production&#x27;) {

                    &#x2F;&#x2F; Check if the current email is signed and encrypted
                    if (!(menuSecurityEncryptRequire.checked &amp;&amp; menuSecuritySign.checked)) {

                        &#x2F;&#x2F; Show error message
                        SMETHReportController._smethUtils.showAlert(&#x27;SMETH&#x27;,
                            SMETHReportController._smethUtils.messageBundle.getLocalisedMessage(&#x27;ecosystem.mode.error&#x27;));

                        &#x2F;&#x2F; Block message sending
                        anEvent.preventDefault();
                    }

                } else {

                    if (!(menuSecurityEncryptRequire.checked &amp;&amp; menuSecuritySign.checked)) {

                        &#x2F;&#x2F; Display message about outgoing email being unsigned and unencrypted since we are in test mode
                        SMETHReportController._smethUtils.showAlert(&#x27;SMETH&#x27;,
                            SMETHReportController._smethUtils.messageBundle.getLocalisedMessage(&#x27;ecosystem.mode.warning&#x27;));
                    }
                }

                switch(SMETHReportController._smethMessageType) {

                    case &quot;activation.report@payment.activation&quot;:

                        &#x2F;&#x2F; populate the XML object with the forms values
                        this._populateReportXMLWithFieldsValues();
                        break;

                    case &quot;simple.report@test&quot;:

                        &#x2F;&#x2F; populate the XML object with the forms values
                        this._populateTestReportXMLWithFieldsValues();
                        break;

                    case &quot;rapport@direct.debit&quot;:

                        &#x2F;&#x2F; populate the XML object with the forms values
                        this._populateMandateReportXMLWithFieldsValues();
                        break;

                    default:
                        break;
                }

                &#x2F;&#x2F; Set the text content of the mail being sent
                editor.document.body.textContent = &#x27;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&#x27; +
                    (new XMLSerializer()).serializeToString(this._contentXMLObject);

            } else {
                anEvent.preventDefault();
            }

            editor.endTransaction();

        } catch(ex) {
            SMETHReportController._smethMessageHandler.exception(ex);
        }
    },

   &#x2F;**
     * TryHandleMissiveAttachments handles missive attachment operations
     *
     * @method TryHandleMissiveAttachments
     * @param {String} action Action that is being carried out on the missive attachment
     * @param {Object} target Missive attachment item
     *&#x2F;
    TryHandleMissiveAttachments : function(action, target) {

        var i;

        switch (action) {

            case &quot;deleteAllFromTest&quot;:

                var dataNodes = this._contentXMLObject.getElementsByTagName(&quot;sem:Data&quot;);
                var container = this._contentXMLObject.evaluate(&quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvBdy&#x2F;sem:sepamail_message_001&#x2F;sem:MsgBdy&#x2F;sem:SimpleTestReport&quot;,
                    SMETHReportController._smethUtils.nsResolver, XPathResult.FIRST_ORDERED_NODE_TYPE, null);

                try {

                    &#x2F;&#x2F; Check if target has been defined
                    if (target == undefined) {

                        &#x2F;&#x2F; Remove data nodes from XML
                        while(dataNodes[0] != null) {
                            container.singleNodeValue.removeChild(dataNodes[0]);
                        }

                    } else {

                        &#x2F;&#x2F; Scan the list of nodes and delete the attached file selected by the user
                        for (i = 0; i &lt; dataNodes.length; i++) {

                            &#x2F;&#x2F; Check if we are the required data node
                            if (dataNodes[i].firstChild.data == target.triggerNode.data.textContent) {
                                container.singleNodeValue.removeChild(dataNodes[i]);
                                break;
                            }
                        }
                    }

                    &#x2F;&#x2F; Initialize the attachment UI
                    SMETHReportController._disableAttachmentUI();

                    &#x2F;&#x2F; Initialize the attachment UI
                    SMETHReportController._initializeAttachmentUI(SMETHReportController._contentXMLObject);

                } catch (e) {
                    throw e;
                }

                break;

            default:
                break;

        }
    },

    &#x2F;**
     * _appendAttachmentToTestXmlDocument appends attachment to the XML document of a test report
     *
     * @method _appendAttachmentToTestXmlDocument
     * @param {Object} file File to append as attachment
     *&#x2F;
    _appendAttachmentToTestXmlDocument : function(file) {

        try {

            &#x2F;&#x2F; Check if file is not null
            if (null != file) {

                &#x2F;&#x2F; Read the file
                NetUtil.asyncFetch(file, function(inputStream, status) {

                    &#x2F;&#x2F; Check if there is any reading error
                    if (!Components.isSuccessCode(status)) {
                        throw new Error(&quot;Error reading from file&quot;);
                        return;
                    }

                    &#x2F;&#x2F; Read the file
                    var data = NetUtil.readInputStreamToString(inputStream, inputStream.available());

                    &#x2F;&#x2F; New element for data node
                    var dataNode = SMETHReportController._contentXMLObject.createElement(&#x27;sem:Data&#x27;);
                    dataNode.appendChild(SMETHReportController._contentXMLObject.createCDATASection(window.btoa(data)));

                    &#x2F;&#x2F; Get the container node
                    var containerNode = SMETHReportController._contentXMLObject.evaluate(&quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvBdy&#x2F;sem:sepamail_message_001&#x2F;sem:MsgBdy&#x2F;sem:SimpleTestReport&quot;,
                        SMETHReportController._contentXMLObject, SMETHReportController._smethUtils.nsResolver,
                        XPathResult.FIRST_ORDERED_NODE_TYPE, null);

                    &#x2F;&#x2F; Append the data node to the container node
                    containerNode.singleNodeValue.appendChild(dataNode);

                    &#x2F;&#x2F; Disable the attachment UI
                    SMETHReportController._disableAttachmentUI();

                    &#x2F;&#x2F; Initialize the attachment UI
                    SMETHReportController._initializeAttachmentUI(SMETHReportController._contentXMLObject);

                });
            }

        } catch(ex) {
            SMETHRequestController._smethMessageHandler.exception(ex);
        }
    },

    &#x2F;**
     * _disableAttachmentUI function removes the attachment UI
     *
     * @method _disableAttachmentUI
     *&#x2F;
    _disableAttachmentUI : function() {

        &#x2F;&#x2F; Get the content window
        var smethComposeBodyFormContainer = document.getElementById(&quot;smethComposeBodyFormContainer&quot;);

        &#x2F;&#x2F; Check if the sepamailLogoBox is present
        if (null != document.getElementById(&quot;missiveAttachmentContainer&quot;)) {

            &#x2F;&#x2F; Removes the sepamailLogoBox
            smethComposeBodyFormContainer.removeChild(document.getElementById(&quot;missiveAttachmentContainer&quot;));
        }
    },

    &#x2F;**
     * _initializeAttachmentUI function initialises the SEPAmail attachment user interface for report messages
     *
     * @method _initializeAttachmentUI
     * @param {Object} xmlObject XML DOM containing attachment
     *&#x2F;
    _initializeAttachmentUI : function(xmlObject) {

        try {

            &#x2F;&#x2F; URL of XSL which transforms an XML document to its attachment UI
            var attachmentXSLUrl = SMETHReportController._smethUtils.getCompositionAttachmentTransformationForMessageType(SMETHReportController._smethMessageType);

            &#x2F;&#x2F; Check if the XSL URL has been defined
            if (attachmentXSLUrl != null) {

                &#x2F;&#x2F; Regenerate XML object
                var object = new DOMParser().parseFromString((new XMLSerializer()).serializeToString(xmlObject), &quot;text&#x2F;xml&quot;);

                &#x2F;&#x2F; Transform the SEPAmail XML document
                var attachmentDocument = SMETHRequestController._transformXMLDocument(object, attachmentXSLUrl);

                &#x2F;&#x2F; Get the content window
                var smethComposeBodyFormContainer = document.getElementById(&quot;smethComposeBodyFormContainer&quot;);

                &#x2F;&#x2F; Appends the resulting transformation fragment first child to the sepamailUIContainer
                if (attachmentDocument.firstChild) {
                    smethComposeBodyFormContainer.appendChild(attachmentDocument.firstChild);
                }

                &#x2F;&#x2F; Show the attach button
                document.getElementById(&quot;button-attach&quot;).hidden = false;

            } else {

                &#x2F;&#x2F; Hide the attach button since we are not adding attachments to the message
                document.getElementById(&quot;button-attach&quot;).hidden = true;
            }

        } catch(ex) {
            throw ex;
        }
    },

    &#x2F;**
     * _populateMissiveHeader populates the header of missive with values specified by the user
     *
     * @method _populateMissiveHeader
     *&#x2F;
    _populateMissiveHeader: function() {

        &#x2F;&#x2F; Missive header values textboxes
        var missiveIdTextbox = document.getElementById(&quot;missiveIdTextbox&quot;);
        var typeMissiveTextbox = document.getElementById(&quot;typeMissiveTextbox&quot;);
        var orderMissiveTextbox = document.getElementById(&quot;orderMissiveTextbox&quot;);
        var priorityTextbox = document.getElementById(&quot;priorityTextbox&quot;);
        var messageIdTextbox = document.getElementById(&quot;messageIdTextbox&quot;);

        &#x2F;&#x2F; Check if the missive ID textbox is defined
        if (missiveIdTextbox == null) {

            &#x2F;&#x2F; Automatically generated missive ID
            SMETHReportController._smethUtils.setMissiveId(this._contentXMLObject);

        } else {

            &#x2F;&#x2F; Check if a missive ID has been defined
            if (missiveIdTextbox.value.length &gt; 0) {

                &#x2F;&#x2F; Set the user generated missive ID
                SMETHReportController._smethUtils.setNodeValue(this._contentXMLObject,
                    &quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvId&quot;, missiveIdTextbox.value);

            } else {

                &#x2F;&#x2F; Automatically generated missive ID
                SMETHReportController._smethUtils.setMissiveId(this._contentXMLObject);
            }
        }

        &#x2F;&#x2F; Set the missive type
        if (typeMissiveTextbox != null) {
            SMETHReportController._smethUtils.setNodeValue(this._contentXMLObject,
                &quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvTyp&quot;, typeMissiveTextbox.value);
        }

        &#x2F;&#x2F; Set the missive order
        if (orderMissiveTextbox != null) {
            SMETHReportController._smethUtils.setNodeValue(this._contentXMLObject,
                &quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvOrd&quot;, orderMissiveTextbox.value);
        }

        &#x2F;&#x2F; Set the missive priority
        if (priorityTextbox != null) {
            SMETHReportController._smethUtils.setNodeValue(this._contentXMLObject,
                &quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvPri&quot;, priorityTextbox.value);
        }

        &#x2F;&#x2F; Check if the message ID textbox is defined
        if (messageIdTextbox == null) {

            &#x2F;&#x2F; Automatically generated message ID
            SMETHReportController._smethUtils.setMessageId(this._contentXMLObject);

        } else {

            &#x2F;&#x2F; Check if a message ID has been defined
            if (messageIdTextbox.value.length &gt; 0) {

                &#x2F;&#x2F; Set the user generated message ID
                SMETHReportController._smethUtils.setNodeValue(this._contentXMLObject,
                    &quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvBdy&#x2F;sem:sepamail_message_001&#x2F;sem:MsgHdr&#x2F;sem:MsgId&quot;,
                    messageIdTextbox.value);

            } else {

                &#x2F;&#x2F; Automatically generated message ID
                SMETHReportController._smethUtils.setMessageId(this._contentXMLObject);
            }
        }
    },

    &#x2F;**
     *_populateReportXMLWithFieldsValues function populates the XML Object with the form fields values
     *
     * @method _populateReportXMLWithFieldsValues
     * @private
     *&#x2F;
    _populateReportXMLWithFieldsValues: function() {

        try {

            var reportAmountTextbox = document.getElementById(&quot;semBdyReportAmount&quot;);
            var reportPaymentTypeMenulist = document.getElementById(&quot;semBdyReportPaymentMethod&quot;);
            var reportRequestDataDatepicker = document.getElementById(&quot;semBdyReportDataValue&quot;);

            &#x2F;&#x2F; Date and time value for pain attributes
            var painAttributeDateTime = SMETHReportController._smethUtils.formatDateForSEPAmail(new Date());

            &#x2F;&#x2F; Set the date and time for pain attributes
            SMETHReportController._smethUtils.setNodeValue(this._contentXMLObject,
                &quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvBdy&#x2F;sem:sepamail_message_001&#x2F;sem:MsgBdy&#x2F;sem:ActivationReport&#x2F;sem:Header&#x2F;sem:CreDtTm&quot;,
                painAttributeDateTime);
            SMETHReportController._smethUtils.setNodeValue(this._contentXMLObject,
                &quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvBdy&#x2F;sem:sepamail_message_001&#x2F;sem:MsgBdy&#x2F;sem:ActivationReport&#x2F;sem:RepCompl&#x2F;sem:Report&#x2F;pain014:GrpHdr&#x2F;pain014:CreDtTm&quot;,
                painAttributeDateTime);

            switch (this._smethReportStatus) {

                case &quot;ACSP&quot;:

                    &#x2F;&#x2F; Set the &quot;InstdAmt&quot; value
                    SMETHReportController._smethUtils.setNodeValue(this._contentXMLObject,
                        &quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvBdy&#x2F;sem:sepamail_message_001&#x2F;sem:MsgBdy&#x2F;sem:ActivationReport&#x2F;sem:RepCompl&#x2F;sem:Report&#x2F;pain014:OrgnlPmtInfAndSts&#x2F;pain014:TxInfAndSts&#x2F;pain014:OrgnlTxRef&#x2F;pain014:Amt&#x2F;pain014:InstdAmt&quot;,
                        reportAmountTextbox.value);

                    &#x2F;&#x2F; Set the &quot;PmtMtd&quot; value
                    SMETHReportController._smethUtils.setNodeValue(this._contentXMLObject,
                        &quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvBdy&#x2F;sem:sepamail_message_001&#x2F;sem:MsgBdy&#x2F;sem:ActivationReport&#x2F;sem:RepCompl&#x2F;sem:Report&#x2F;pain014:OrgnlPmtInfAndSts&#x2F;pain014:TxInfAndSts&#x2F;pain014:OrgnlTxRef&#x2F;pain014:PmtMtd&quot;,
                        reportPaymentTypeMenulist.value);

                    &#x2F;&#x2F; Set the &quot;ReqdExctnDt&quot; value
                    SMETHReportController._smethUtils.setNodeValue(this._contentXMLObject,
                        &quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvBdy&#x2F;sem:sepamail_message_001&#x2F;sem:MsgBdy&#x2F;sem:ActivationReport&#x2F;sem:RepCompl&#x2F;sem:Report&#x2F;pain014:OrgnlPmtInfAndSts&#x2F;pain014:TxInfAndSts&#x2F;pain014:OrgnlTxRef&#x2F;pain014:ReqdExctnDt&quot;,
                        reportRequestDataDatepicker.value);

                    break;

                case &quot;RJCT&quot;:

                    &#x2F;&#x2F; Set the &quot;InstdAmt&quot; value
                    SMETHReportController._smethUtils.setNodeValue(this._contentXMLObject,
                        &quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvBdy&#x2F;sem:sepamail_message_001&#x2F;sem:MsgBdy&#x2F;sem:ActivationReport&#x2F;sem:RepCompl&#x2F;sem:Report&#x2F;pain014:OrgnlPmtInfAndSts&#x2F;pain014:TxInfAndSts&#x2F;pain014:OrgnlTxRef&#x2F;pain014:Amt&#x2F;pain014:InstdAmt&quot;,
                        reportAmountTextbox.value);

                    &#x2F;&#x2F; Set the &quot;PmtMtd&quot; value
                    SMETHReportController._smethUtils.setNodeValue(this._contentXMLObject,
                        &quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvBdy&#x2F;sem:sepamail_message_001&#x2F;sem:MsgBdy&#x2F;sem:ActivationReport&#x2F;sem:RepCompl&#x2F;sem:Report&#x2F;pain014:OrgnlPmtInfAndSts&#x2F;pain014:TxInfAndSts&#x2F;pain014:OrgnlTxRef&#x2F;pain014:PmtMtd&quot;,
                        reportPaymentTypeMenulist.value);

                    &#x2F;&#x2F; Set the &quot;ReqdExctnDt&quot; value
                    SMETHReportController._smethUtils.setNodeValue(this._contentXMLObject,
                        &quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvBdy&#x2F;sem:sepamail_message_001&#x2F;sem:MsgBdy&#x2F;sem:ActivationReport&#x2F;sem:RepCompl&#x2F;sem:Report&#x2F;pain014:OrgnlPmtInfAndSts&#x2F;pain014:TxInfAndSts&#x2F;pain014:OrgnlTxRef&#x2F;pain014:ReqdExctnDt&quot;,
                        reportRequestDataDatepicker.value);

                    break;

                default:

                    &#x2F;&#x2F; Current report status has not yet been handled
                    throw new Error(&quot;Report for the message status &#x27;&quot; + this._smethReportStatus + &quot;&#x27; has not been handled yet.&quot;);
            }

        } catch(ex) {
            throw ex;
        }
    },

    &#x2F;**
     * _populateMandateReportXMLWithFieldsValues function populates the XML object with form fields&#x27; values
     *
     * @method _populateMandateReportXMLWithFieldsValues
     * @private
     * @todo BKM method implementation
     *&#x2F;
    _populateMandateReportXMLWithFieldsValues : function() {

        try {

            var messageId;
            var messageIdTextbox = document.getElementById(&quot;messageIdTextbox&quot;);
            var rejectionCodeTextbox = document.getElementById(&quot;semRejectionCodeTextbox&quot;);
            var rejectionInfoTextbox = document.getElementById(&quot;semRejectionInfoTextbox&quot;);
            var changeBankDetailsCheckbox = document.getElementById(&quot;changeBankDetailsCheckbox&quot;);
            var newAgentTextbox = document.getElementById(&quot;semNewAgentTextbox&quot;);
            var newIBANTextbox = document.getElementById(&quot;semNewIBANTextbox&quot;);

            &#x2F;&#x2F; Check if a message ID has been defined
            if (messageIdTextbox.value.length &gt; 0) {

                &#x2F;&#x2F; Get the user defined message ID
                messageId = messageIdTextbox.value;

            } else {

                &#x2F;&#x2F; Automatically generated message ID
                messageId = SMETHReportController._smethUtils.generateMessageId();
            }

            &#x2F;&#x2F; Set the message ID
            SMETHReportController._smethUtils.setNodeValue(this._contentXMLObject,
                &quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvBdy&#x2F;sem:sepamail_message_001&#x2F;sem:MsgHdr&#x2F;sem:MsgId&quot;,
                messageId);

            &#x2F;&#x2F; Set the message ID for the mandate group header
            SMETHReportController._smethUtils.setNodeValue(this._contentXMLObject,
                &quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvBdy&#x2F;sem:sepamail_message_001&#x2F;sem:MsgBdy&#x2F;sem:DirectDebitMandateAcceptance&#x2F;sem:sepamail_message_direct_debit_mandate_acceptance_001&#x2F;sem:Report&#x2F;p012:GrpHdr&#x2F;p012:MsgId&quot;,
                messageId);

            &#x2F;&#x2F; Set the creation date and time
            SMETHReportController._smethUtils.setNodeValue(this._contentXMLObject,
                &quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvBdy&#x2F;sem:sepamail_message_001&#x2F;sem:MsgBdy&#x2F;sem:DirectDebitMandateAcceptance&#x2F;sem:sepamail_message_direct_debit_mandate_acceptance_001&#x2F;sem:Report&#x2F;p012:GrpHdr&#x2F;p012:CreDtTm&quot;,
                SMETHRequestController._smethUtils.formatDateForSEPAmail(new Date()));

            &#x2F;&#x2F; Check if we have a rejected request
            if (rejectionCodeTextbox != null) {

                &#x2F;&#x2F; Set the rejection code
                SMETHReportController._smethUtils.setNodeValue(this._contentXMLObject,
                    &quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvBdy&#x2F;sem:sepamail_message_001&#x2F;sem:MsgBdy&#x2F;sem:DirectDebitMandateAcceptance&#x2F;sem:sepamail_message_direct_debit_mandate_acceptance_001&#x2F;sem:Report&#x2F;p012:UndrlygAccptncDtls&#x2F;p012:AccptncRslt&#x2F;p012:RjctRsn&#x2F;p012:Cd&quot;,
                    rejectionCodeTextbox.value.trim());

                &#x2F;&#x2F; Set the rejection info
                SMETHReportController._smethUtils.setNodeValue(this._contentXMLObject,
                    &quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvBdy&#x2F;sem:sepamail_message_001&#x2F;sem:MsgBdy&#x2F;sem:DirectDebitMandateAcceptance&#x2F;sem:sepamail_message_direct_debit_mandate_acceptance_001&#x2F;sem:Report&#x2F;p012:UndrlygAccptncDtls&#x2F;p012:AccptncRslt&#x2F;p012:AddtlRjctRsnInf&quot;,
                    rejectionInfoTextbox.value.trim());
            }

            &#x2F;&#x2F; Check if user is changing bank details
            if (changeBankDetailsCheckbox.checked) {

                &#x2F;&#x2F; New element for extension node
                var extensionNode = this._contentXMLObject.createElement(&#x27;sem:DSExt&#x27;);

                &#x2F;&#x2F; Create node for new agent
                var agentNode = this._contentXMLObject.createElement(&#x27;sem:BIC&#x27;);
                agentNode.textContent = newAgentTextbox.value.trim();

                &#x2F;&#x2F; Create node for new IBAN
                var ibanNode = this._contentXMLObject.createElement(&#x27;sem:IBAN&#x27;);
                ibanNode.textContent = newIBANTextbox.value.trim();

                &#x2F;&#x2F; Append the agent and IBAN nodes to the extension node
                extensionNode.appendChild(agentNode);
                extensionNode.appendChild(ibanNode);

                &#x2F;&#x2F; Get the container node of the extension node
                var exTContainerNode = this._contentXMLObject.evaluate(&quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvBdy&#x2F;sem:sepamail_message_001&#x2F;sem:MsgBdy&#x2F;sem:DirectDebitMandateAcceptance&#x2F;sem:sepamail_message_direct_debit_mandate_acceptance_001&quot;,
                    this._contentXMLObject, SMETHReportController._smethUtils.nsResolver,
                    XPathResult.FIRST_ORDERED_NODE_TYPE, null);

                &#x2F;&#x2F; Add the extension node to the container
                exTContainerNode.singleNodeValue.appendChild(extensionNode);
            }

        } catch(ex) {
            throw ex;
        }
    },

    &#x2F;**
     * _populateTestReportXMLWithFieldsValues function populates the XML Object with the form fields values
     *
     * @method _populateTestReportXMLWithFieldsValues
     * @private
     *&#x2F;
    _populateTestReportXMLWithFieldsValues : function() {

        try {

            var requestTestIdTextbox = document.getElementById(&quot;requestTestIdTextbox&quot;);
            var listboxTestRequestText = document.getElementById(&quot;listboxTestRequestText&quot;);

            &#x2F;&#x2F; Set the &quot;TestId&quot; value
            SMETHReportController._smethUtils.setNodeValue(this._contentXMLObject,
                &quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvBdy&#x2F;sem:sepamail_message_001&#x2F;sem:MsgBdy&#x2F;sem:SimpleTestReport&#x2F;sem:TestId&quot;,
                requestTestIdTextbox.value);

            &#x2F;&#x2F; Get the specific node
            var node = this._contentXMLObject.evaluate(&quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvBdy&#x2F;sem:sepamail_message_001&#x2F;sem:MsgBdy&#x2F;sem:SimpleTestReport&quot;,
                this._contentXMLObject, SMETHReportController._smethUtils.nsResolver,
                XPathResult.FIRST_ORDERED_NODE_TYPE, null);

            &#x2F;&#x2F; sem:Text nodes
            var textNodes = this._contentXMLObject.getElementsByTagName(&quot;sem:Text&quot;);

            &#x2F;&#x2F; Remove all sem:Text nodes from the report
            while(textNodes[0] != null) {
                node.singleNodeValue.removeChild(textNodes[0]);
            }

            &#x2F;&#x2F; Set the &quot;Text&quot; values
            for (var i = 0; i &lt; listboxTestRequestText.itemCount; i++) {

                &#x2F;&#x2F; New element for text node
                var textNode = this._contentXMLObject.createElement(&#x27;sem:Text&#x27;);

                &#x2F;&#x2F; Set the value of the node
                textNode.textContent = listboxTestRequestText.getItemAtIndex(i).value;

                &#x2F;&#x2F; Add the text node to the container
                node.singleNodeValue.appendChild(textNode);
            }

            &#x2F;&#x2F; Re-create data nodes so that they contain CDDATA elements
            var dataNodes = this._contentXMLObject.getElementsByTagName(&quot;sem:Data&quot;);

            var consoleService = Components.classes[&quot;@mozilla.org&#x2F;consoleservice;1&quot;]
                                           .getService(Components.interfaces.nsIConsoleService);

            &#x2F;&#x2F; Scan the list of data nodes and recreate data nodes with CDDATA elements
            for (var j = 0; j &lt; dataNodes.length; j++) {
                consoleService.logStringMessage(dataNodes[j].textContent);
                var currentData = dataNodes[j].textContent;
                dataNodes[j].textContent = null;
                dataNodes[j].appendChild(this._contentXMLObject.createCDATASection(currentData));
            }

        } catch(ex) {

            throw ex;
        }
    },

    &#x2F;**
     * isSEPAmailReport function check if the content of a body contains a valid report missive message
     *
     * @method isSEPAmailReport
     * @param {String} aContent Mail body content
     * @return {Boolean} Wether the content is of type SEPAmail report
     * @todo BKM - Refactorise with one unified method for determinig message type
     *&#x2F;
    isSEPAmailReport: function(aContent) {

        try {
            &#x2F;&#x2F; Initialise the default objects
            this._init();

            &#x2F;&#x2F; Initialise the content object
            this._content = aContent;

            &#x2F;&#x2F; Parse the content XML
            this._contentXMLObject = new DOMParser().parseFromString(aContent, &quot;text&#x2F;xml&quot;);

            &#x2F;&#x2F; Verify for any parse error
            if (&quot;parsererror&quot; !=  this._contentXMLObject.documentElement.nodeName) {

                &#x2F;&#x2F; List of request messages
                var validMessages = new Array(&quot;activation.report@payment.activation&quot;, &quot;simple.report@test&quot;,
                    &quot;rapport@direct.debit&quot;);

                &#x2F;&#x2F; Get the message type xpath
                var smethPrefMissiveMsgTypXpath = this._smethPreferences.getCharPref(&quot;missive.prefMsgTypXpath&quot;);

                &#x2F;&#x2F; Get the SEPAmail message type using Xpath
                this._smethMessageType = this._contentXMLObject.evaluate(smethPrefMissiveMsgTypXpath,
                    this._contentXMLObject, SMETHReportController._smethUtils.nsResolver, XPathResult.STRING_TYPE,
                    null).stringValue;

                &#x2F;&#x2F; Check whether the xml is of type report
                return validMessages.indexOf(this._smethMessageType) &gt; -1;

            } else {
                return false;
            }

            return false;

        } catch(ex) {
            SMETHReportController._smethMessageHandler.exception(ex);
        }
    },

    &#x2F;**
     * transformXMLDocument function transforms the parametered XML document using the paramentered XSL file URL
     *
     * @method transformXMLDocument
     * @param {XML} anXML Document
     * @param {String} anXSLUrl String
     * @return {XML} Transformed XML document
     * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Using_the_Mozilla_JavaScript_interface_to_XSL_Transformations#Using_XSLTProcessor_from_XPCOM_components
     *&#x2F;
    transformXMLDocument : function (anXML, anXSLUrl) {

        try {
            &#x2F;&#x2F; Decalre the XMLHttpRequest to load the XSL
            var xmlHttpRequest = new XMLHttpRequest();

            &#x2F;&#x2F; Send request for the XSL document
            xmlHttpRequest.open(&#x27;GET&#x27;, anXSLUrl, false);
            xmlHttpRequest.send();

            &#x2F;&#x2F; Get the XSL document object
            var xslDocument = xmlHttpRequest.responseXML;

            &#x2F;&#x2F; Instatiate the XSLT Processor
            &#x2F;&#x2F; @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Using_the_Mozilla_JavaScript_interface_to_XSL_Transformations#Using_XSLTProcessor_from_XPCOM_components
            var xsltProcessor= Components.classes[&quot;@mozilla.org&#x2F;document-transformer;1?type=xslt&quot;]
                                .createInstance(Components.interfaces.nsIXSLTProcessor);

            &#x2F;&#x2F; Import the XSL document object in the XSLT processor
            xsltProcessor.importStylesheet(xslDocument);

            &#x2F;&#x2F; Declare an empty XML document that will own the fragment
            var resultDocumentOwner = document.implementation.createDocument(&quot;&quot;, &quot;&quot;, null);

            &#x2F;&#x2F; Get the resulting transformation fragment
            var resultFragment = xsltProcessor.transformToFragment(anXML,resultDocumentOwner);

            &#x2F;&#x2F; Append the result fragment to its fragment owner
            resultDocumentOwner.appendChild(resultFragment);

            return resultDocumentOwner;

        } catch(ex) {
            throw ex;
        }
    }
}

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
