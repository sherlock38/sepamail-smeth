<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>content&#x2F;controllers&#x2F;SMETHReadMessageController.js</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.8.0pr2&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.8.0pr2&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="..&#x2F;assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/SMETHAcknowledgementController.html">SMETHAcknowledgementController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHAcknowledgementPreferencesController.html">SMETHAcknowledgementPreferencesController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHAdvancedPreferencesController.html">SMETHAdvancedPreferencesController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHAttachmentController.html">SMETHAttachmentController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHBankPreferencesController.html">SMETHBankPreferencesController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHComposeMessageController.html">SMETHComposeMessageController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHControlFactory.html">SMETHControlFactory</a></li>
            
                <li><a href="..&#x2F;classes/SMETHHeaderController.html">SMETHHeaderController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHMail.html">SMETHMail</a></li>
            
                <li><a href="..&#x2F;classes/SMETHMailPreferencesController.html">SMETHMailPreferencesController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHMessageHandler.html">SMETHMessageHandler</a></li>
            
                <li><a href="..&#x2F;classes/SMETHOptionController.html">SMETHOptionController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHQXBANPreferencesController.html">SMETHQXBANPreferencesController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHReadMessageController.html">SMETHReadMessageController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHReportController.html">SMETHReportController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHRequestController.html">SMETHRequestController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHUtils.html">SMETHUtils</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="..&#x2F;modules/smeth.html">smeth</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: content&#x2F;controllers&#x2F;SMETHReadMessageController.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x2F;* ***** BEGIN LICENSE BLOCK *****
 * This file is part of smeth (https:&#x2F;&#x2F;code.google.com&#x2F;p&#x2F;sepamail-smeth&#x2F;)
 *
 * Version: MPL 2.0&#x2F;GPL 3.0&#x2F;LGPL 3.0
 *
 * The contents of this file are subject to the Mozilla Public License Version
 * 2.0 (the &quot;License&quot;); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 * http:&#x2F;&#x2F;www.mozilla.org&#x2F;MPL&#x2F;2.0&#x2F;
 *
 * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,
 * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
 * for the specific language governing rights and limitations under the
 * License.
 *
 * The Initials Developers of the Original Code are :
 *  Ammit Heeramun, idSoft
 *  Bishan Kumar Madhoo, idSoft
 *  Manfred Sherlock Olm, deciBI &amp; vizGet
 * Portions created by the Initials Developers are Copyright (C) 2012
 * the Initial Developer. All Rights Reserved.
 *
 * Contributor(s):
 *  Ammit Heeramun
 *  Bishan Kumar Madhoo 
 *  Manfred Sherlock Olm, smeth@decibi.fr
 *
 * Alternatively, the contents of this file may be used under the terms of
 * either the GNU General Public License Version 3 or later (the &quot;GPL&quot;), or
 * the GNU Lesser General Public License Version 3.0 or later (the &quot;LGPL&quot;),
 * in which case the provisions of the GPL or the LGPL are applicable instead
 * of those above. If you wish to allow use of your version of this file only
 * under the terms of either the GPL or the LGPL, and not to allow others to
 * use your version of this file under the terms of the MPL, indicate your
 * decision by deleting the provisions above and replace them with the notice
 * and other provisions required by the GPL or the LGPL. If you do not delete
 * the provisions above, a recipient may use your version of this file under
 * the terms of any one of the MPL, the GPL or the LGPL.
 *
 * ***** END LICENSE BLOCK ***** *&#x2F;

&#x2F;**
 * @main smeth
 * @file SMETHReadMessageController.js
 * @mvc controller
 * @version 1212
 * @since 1210
 * @author Ammit Heeramun
 * @description SMETHReadMessageController is the class that is attached to SMETHReadMessageView, it helps in the setting up of the thunderbird main window interface for displaying of different type of SEPAmail messages.
 *&#x2F;

&#x2F;**
 * SMETHMessageHandler class contain functions to handle info, error, warning and exceptions messages
 * 
 * @include SMETHMessageHandler.js
 *&#x2F;
Components.utils.import(&quot;resource:&#x2F;&#x2F;smeth&#x2F;smethlib&#x2F;SMETHMessageHandler.js&quot;);

&#x2F;**
 * SMETHUtils class contains all the useful functions that will be used in Smeth
 * 
 * @include SMETHUtils.js
 *&#x2F;
Components.utils.import(&quot;resource:&#x2F;&#x2F;smeth&#x2F;smethlib&#x2F;SMETHUtils.js&quot;);

&#x2F;**
 * SMETHControlFactory class contain functions to create XUL and HTML controls
 * 
 * @include SMETHControlFactory.js
 *&#x2F;
Components.utils.import(&quot;resource:&#x2F;&#x2F;smeth&#x2F;smethlib&#x2F;SMETHControlFactory.js&quot;);

&#x2F;**
 * SMETHMail class that represent the message object for Smeth
 * 
 * @include SMETHMail.js
 *&#x2F;
Components.utils.import(&quot;resource:&#x2F;&#x2F;smeth&#x2F;smethlib&#x2F;SMETHMail.js&quot;);

&#x2F;**
 * Strict mode for scripts
 * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;JavaScript&#x2F;Reference&#x2F;Functions_and_function_scope&#x2F;Strict_mode
 *
 *&#x2F;
&quot;use strict&quot;;

&#x2F;**
 * SMETHReadMessageController is the class that is attached to SMETHReadMessageView, it helps in the setting up of the thunderbird main window interface for displaying of different type of SEPAmail messages.
 *
 * @class SMETHReadMessageController
 *&#x2F;
var SMETHReadMessageController = {

   &#x2F;**
    * Declare the SMETHMessageHandler class
    * 
    * @attribute _smethMessageHandler
    * @private
    * @default null
    *&#x2F;
    _smethMessageHandler : null,
    
   &#x2F;**
    * Declare the utils class
    * 
    * @attribute _smethUtils
    * @private
    * @default null
    *&#x2F;
    _smethUtils : null,

   &#x2F;**
    * Declare the SMETHControlFactory class
    * 
    * @attribute _smethControlFactory
    * @private
    * @default null
    *&#x2F;
    _smethControlFactory : null,

   &#x2F;**
    * Declare the smeth mail object
    * 
    * @attribute _smethMail
    * @private
    * @default null
    *&#x2F;    
    _smethMail : null,

   &#x2F;**
    * Preferences object
    * 
    * @attribute _smethPreferences
    * @private
    * @default null
    *&#x2F; 
    _smethPreferences : null,

   &#x2F;**
    * Preference prefIsBodyXML
    * 
    * @attribute _smethPrefIsBodyXML
    * @private
    * @default null
    *&#x2F; 
    _smethPrefIsBodyXML : null,

   &#x2F;**
    * Preference prefSEPAmailXMLTag
    * 
    * @attribute _smethPrefSEPAmailXMLTag
    * @private
    * @default null
    *&#x2F; 
    _smethPrefSEPAmailXMLTag : null,

   &#x2F;**
    * Preference for missive message type XPath
    * 
    * @attribute _smethPrefMissiveMsgTypXpath
    * @private
    * @default null
    *&#x2F; 
    _smethPrefMissiveMsgTypXpath : null,

   &#x2F;**
    * Preference for the missive root tag
    * 
    * @attribute _smethPrefMissiveRootTag
    * @private
    * @default null
    *&#x2F; 
    _smethPrefMissiveRootTag : null,

   &#x2F;**
    * Smeth config object
    * 
    * @attribute _smethConfigObject
    * @private
    * @default null
    *&#x2F; 
    _smethConfigObject : null,
    
    &#x2F;**
     * Smeth message type
     * 
     * @attribute _smethMessageType
     * @private
     * @default null
     *&#x2F;
    _smethMessageType : null,

    &#x2F;**
     * Initiation of the Smeth plugin
     * 
     * @method init
     * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Code_snippets&#x2F;Preferences#XPCOM_interfaces_for_preferences_system
     *&#x2F;
    
    init : function () {
        try
        {
            &#x2F;&#x2F; Instantiate the SMETHMessageHandler class
            this._smethMessageHandler = new SMETHMessageHandler(window);
            
            &#x2F;&#x2F; Instantiate the 
            this._smethUtils = new SMETHUtils(window);

            &#x2F;&#x2F; Instantiate the SMETHControlFactory class
            this._smethControlFactory = new SMETHControlFactory(document);

            &#x2F;&#x2F; Register to receive notifications of preference changes
            &#x2F;&#x2F; @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Code_snippets&#x2F;Preferences#XPCOM_interfaces_for_preferences_system
            this._smethPreferences = Components.classes[&quot;@mozilla.org&#x2F;preferences-service;1&quot;]
                                    .getService(Components.interfaces.nsIPrefService)
                                    .getBranch(&quot;extensions.smeth.&quot;);
            this._smethPreferences.QueryInterface(Components.interfaces.nsIPrefBranch2);

            &#x2F;&#x2F; Add an observer for changes in preferences
            this._smethPreferences.addObserver(&quot;&quot;, this, false);

            &#x2F;&#x2F; Retreive the value of the preference &quot;prefIsBodyXML&quot;
            this._smethPrefIsBodyXML = this._smethPreferences.getBoolPref(&quot;prefIsBodyXML&quot;);

            &#x2F;&#x2F; Retreive the value of the preference &quot;prefSEPAmailXMLTag&quot;
            this._smethPrefSEPAmailXMLTag = this._smethPreferences.getCharPref(&quot;prefSEPAmailXMLTag&quot;);

            &#x2F;&#x2F; Retreive the value of the missive preference &quot;prefMsgTypXpath&quot;
            this._smethPrefMissiveMsgTypXpath = this._smethPreferences.getCharPref(&quot;missive.prefMsgTypXpath&quot;);

            &#x2F;&#x2F; Retreive the value of the missive preference &quot;prefRootTag&quot;
            this._smethPrefMissiveRootTag = this._smethPreferences.getCharPref(&quot;missive.prefRootTag&quot;);
            
        }
        catch(ex)
        {
            SMETHReadMessageController._smethMessageHandler.exception(ex);
        }

    },

    &#x2F;**
     * observe function Called when events occur on the preferences
     *
     * @method observe
     * @param {String} aSubject Event Subject
     * @param {String} aTopic Event Topic
     * @param {Object} aData Event Data
     *&#x2F;
    observe: function(aSubject, aTopic, aData)
    {
        try
        {
            if (aTopic != &quot;nsPref:changed&quot;)
            {
                    return;
            }

            switch(aData)
            {
                case &quot;prefIsBodyXML&quot;:
                        &#x2F;&#x2F; Retreive the value of the preference &quot;prefIsBodyXML&quot;
                        this._smethPrefIsBodyXML = this._smethPreferences.getBoolPref(&quot;prefIsBodyXML&quot;);
                        break;
            }
        }
        catch(ex)
        {
            SMETHReadMessageController._smethMessageHandler.exception(ex);
        }
    },

    &#x2F;**
     * onMessagePaneLoad listener to be triggered on each mail select
     *
     * @method onMessagePaneLoad
     * @param {Object} aEvent Event data
     * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Code_snippets&#x2F;On_page_load
     *&#x2F;
    onMessagePaneLoad : function (aEvent) {

        try
        {
            &#x2F;&#x2F; Get the selected mail header
            var selectedMailHeader = gFolderDisplay.selectedMessage;

            if(null != selectedMailHeader)
            {
                &#x2F;&#x2F; Intatiate the smeth mail object
                SMETHReadMessageController.initializeSmethMailObject(selectedMailHeader);
            }
        }
        catch(ex)
        {
            SMETHReadMessageController._smethMessageHandler.exception(ex);
        }
    },

    &#x2F;**
     * initializeSmethMailObject function initialize a SmethMail Object using the mail selected header
     *
     * @method initializeSmethMailObject
     * @param {Object} aSelectedMailHeader Selected mail header
     *&#x2F;
    initializeSmethMailObject : function (aSelectedMailHeader){
        try
        {
            &#x2F;&#x2F; Define the options for the MsgHdrToMimeMessage function
            var options = new Array();
            options[&#x27;examineEncryptedParts&#x27;] = true;
            options[&#x27;partsOnDemand&#x27;] = true;

            &#x2F;&#x2F; Instantiate the smeth mail object
            this._smethMail = new SMETHMail(aSelectedMailHeader);

            &#x2F;&#x2F; Get the mail content
            MsgHdrToMimeMessage(aSelectedMailHeader, null, function (aMailHeader, aMailContent) {
                try
                {
                    &#x2F;&#x2F; Set the mail content object
                    SMETHReadMessageController._smethMail.content = aMailContent;

                    &#x2F;&#x2F; Set the mail body
                    SMETHReadMessageController._smethMail.body = SMETHReadMessageController.getMailBody(SMETHReadMessageController._smethMail.content.parts[0]);

                    &#x2F;&#x2F; Set whether the selected mail is a SEPAmail
                    SMETHReadMessageController._smethMail.isSEPAmail = SMETHReadMessageController.isSEPAmail(SMETHReadMessageController._smethMail);

                    &#x2F;&#x2F; Initialize the messagepane UI using the smeth mail object
                    SMETHReadMessageController.initializeMessagePaneUI(SMETHReadMessageController._smethMail);

                    &#x2F;&#x2F; Set the mail object for the acknowledgement controller
                    SMETHAcknowledgementController.missiveMailObject = SMETHReadMessageController._smethMail;
                }
                catch(ex)
                {
                    SMETHReadMessageController._smethMessageHandler.exception(ex);
                }

            }, true, options);
        }
        catch(ex)
        {
            throw ex;
        }

    },

    &#x2F;**
     * initializeMessagePaneUI initialises the messagepane user interface using the parametered SmethMail object
     *
     * @method initializeMessagePaneUI
     * @param {object} aSmethMail Selected mail object
     *&#x2F;
    initializeMessagePaneUI : function(aSmethMail)
    {
        try
        {
            &#x2F;&#x2F; Smeth mail Object
            var smethMail = aSmethMail;

            &#x2F;&#x2F; Toogle the message header buttons
            &#x2F;&#x2F;SMETHReadMessageController.toogleMessageHeaderButtons(smethMail);

            &#x2F;&#x2F; Check if a mail is a SEPAmail
            if(smethMail.isSEPAmail)
            {
                &#x2F;&#x2F; Initialise
                SMETHReadMessageController.initializeSEPAmailUI();

                &#x2F;&#x2F; Initializes the SEPAmail SMTP header
                SMETHReadMessageController.initializeSEPAmailSMTPHeaderUI();

                &#x2F;&#x2F; Parse the raw mail body
                var bodyXml = new DOMParser().parseFromString(smethMail.body, &quot;text&#x2F;xml&quot;);

                &#x2F;&#x2F; Verify for any parse error
                if(&quot;parsererror&quot; !=  bodyXml.documentElement.nodeName)
                {
                    &#x2F;&#x2F;Set the SEPAmail XML Object
                    this._smethMail.sepamailXMLObject = bodyXml;
                    
                    &#x2F;&#x2F;Set the SEPAmail message type
                    this._smethMail.sepamailMessageType = SMETHReadMessageController.getSEPAmailMessageType(this._smethMail);
                    
                    &#x2F;&#x2F;TODO:Proper handling for different message types
                    if(&#x27;&#x27; != this._smethMail.sepamailMessageType)
                    {
                        &#x2F;&#x2F; Retrieve the Smeth config object from the preferences
                        this._smethConfigObject = this._smethUtils.getControllerConfigObject(this._smethMail.sepamailMessageType);
                        
                        if(null != this._smethConfigObject)
                        {
                            &#x2F;&#x2F; Set the missive message type for the acknowledgement controller
                            SMETHAcknowledgementController.missiveMessageType = this._smethMail.sepamailMessageType;
                            
                            &#x2F;&#x2F; Check for SEPAmail request content
                            if (SMETHRequestController.isSEPAmailRequest(smethMail.body)) {
                                
                                &#x2F;&#x2F; We have a SEPAmail valid report missive XML
                                this._smethMessageType = &#x27;SEPAMAIL_REQUEST&#x27;;
                                
                                &#x2F;&#x2F; Initializes the SEPAmail header
                                SMETHHeaderController.initializeSEPAmailHeaderUI();

                                &#x2F;&#x2F; Initializes the SEPAmail body
                                SMETHReadMessageController.initializeSEPAmailBodyUI();

                                if(this._smethConfigObject.settings.hasAttachments)
                                {
                                    &#x2F;&#x2F; Initializes the SEPAmail attachment
                                    SMETHReadMessageController.initializeSEPAmailAttachmentUI();
                                }

                                &#x2F;&#x2F; Get the SEPAmailUIContainer
                                var sepamailUIContainer = document.getElementById(&quot;sepamailUIContainer&quot;);

                                &#x2F;&#x2F; Set translated labels for SMETH UI controls
                                this._smethUtils.translateSEPAmailDocument(sepamailUIContainer, SMETHTranslations);

                            } else { }
                        }
                        else
                        {
                            this.disableSEPAmailUI();
                            SMETHReadMessageController._smethMessageHandler.info(&quot;SEPAmail message type config not yet defined&quot;);
                        }
                    }
                    else
                    {
                        if(SMETHAcknowledgementController.isAcknowledgementMissiveMessage(smethMail.body)) {

                            &#x2F;&#x2F; We have a SEPAmail valid acknowledgement missive XML
                            this._smethMessageType = &#x27;SEPAMAIL_ACKNOWLEDGEMENT&#x27;;
                        
                            SMETHHeaderController.initializeSEPAmailHeaderUI();

                        } else {

                            this.disableSEPAmailUI();
                            SMETHReadMessageController._smethMessageHandler.info(&quot;SEPAmail message type not yet handled&quot;);
                        }
                    }
                }
                else
                {
                    this.disableSEPAmailUI();
                    SMETHReadMessageController._smethMessageHandler.info(&quot;XML parse error&quot;);
                }
            }
            else
            {
                this.disableSEPAmailUI();
            }
        }
        catch(ex)
        {
            throw ex;
        }

    },

    &#x2F;**
     * initializeSEPAmailUI function initialises the SEPAmail UI
     * 
     * @method initializeSEPAmailUI
     *&#x2F;
    initializeSEPAmailUI : function(){

        &#x2F;&#x2F; Toogle the message header buttons
        SMETHReadMessageController.toogleMessageHeaderButtons();

        &#x2F;&#x2F; Get message pane wrapper
        var messagePaneWrapper = document.getElementById(&quot;messagepanewrapper&quot;);

        &#x2F;&#x2F; Get and hide the message pane browser displaying the raw XML
        var messagePaneBrowser = document.getElementById(&quot;messagepane&quot;);
        messagePaneBrowser.hidden = true;

        &#x2F;&#x2F; Get the SEPAmailUIContainer
        var sepamailUIContainer = document.getElementById(&quot;sepamailUIContainer&quot;);

        &#x2F;&#x2F; Check if the sepamailUIContainer is present
        if(null != sepamailUIContainer)
        {
            &#x2F;&#x2F; Removes the sepamailUIContainer childrens
            while(sepamailUIContainer.hasChildNodes()){
                sepamailUIContainer.removeChild(sepamailUIContainer.firstChild);
            }
        }
        else
        {
            &#x2F;&#x2F; Create the SEPAmailUIContainer
            sepamailUIContainer = this._smethControlFactory.createVBoxXULElement(&quot;sepamailUIContainer&quot;)
            sepamailUIContainer.setAttribute(&quot;flex&quot;, 1);

            &#x2F;&#x2F; Add a the SEPAmailUIContainer vbox in which all the parts of the SEPAmail UI will be added
            messagePaneWrapper.appendChild(sepamailUIContainer);
        }
        
        &#x2F;&#x2F; Get the export menu
        var menuExport = document.getElementById(&quot;menu_Export&quot;);
        
        &#x2F;&#x2F; Enable the export menu
        menuExport.setAttribute(&quot;disabled&quot;, &quot;false&quot;);
    },

    &#x2F;**
     * disableSEPAmailUI function disables the SEPAmail UI
     * 
     * @method disableSEPAmailUI
     *&#x2F;
    disableSEPAmailUI : function(){

        &#x2F;&#x2F; Toogle the message header buttons
        SMETHReadMessageController.toogleMessageHeaderButtons();

        &#x2F;&#x2F; Get the message header toolbox
        var messageheaderToolBox = document.getElementById(&quot;dateValueBox&quot;);

        &#x2F;&#x2F; Get message pane wrapper
        var messagePaneWrapper = document.getElementById(&quot;messagepanewrapper&quot;);

        &#x2F;&#x2F; Check if the sepamailLogoBox is present
        if(null != document.getElementById(&quot;sepamailLogoBox&quot;))
        {
            &#x2F;&#x2F; Removes the sepamailLogoBox
            messageheaderToolBox.removeChild(document.getElementById(&quot;sepamailLogoBox&quot;));

        }
        else{}

        &#x2F;&#x2F; Check if the sepamailUIContainer is present
        if(null != document.getElementById(&quot;sepamailUIContainer&quot;))
        {
            &#x2F;&#x2F; Removes the sepamailUIContainer
            messagePaneWrapper.removeChild(document.getElementById(&quot;sepamailUIContainer&quot;));
        }

        &#x2F;&#x2F; Get and show the message pane browser
        var messagePaneBrowser = document.getElementById(&quot;messagepane&quot;);
        messagePaneBrowser.hidden = false;
        
        &#x2F;&#x2F; Get the export menu
        var menuExport = document.getElementById(&quot;menu_Export&quot;);
        
        &#x2F;&#x2F; Disable the export menu
        menuExport.setAttribute(&quot;disabled&quot;, &quot;true&quot;);
    },

    &#x2F;**
     * initializeSEPAmailSMTPHeaderUI function initialises the SEPAmail SMTP header user interface
     * 
     * @method initializeSEPAmailSMTPHeaderUI
     *&#x2F;
    initializeSEPAmailSMTPHeaderUI : function(){
        try
        {
            &#x2F;&#x2F; Get the message header toolbox
            var messageheaderToolBox = document.getElementById(&quot;dateValueBox&quot;);

            &#x2F;&#x2F; Check if the SEPAmail logo is present
            if(null == document.getElementById(&quot;sepamailLogoBox&quot;))
            {
                &#x2F;&#x2F; Create the box XUL element to contain the SEPAmail logo
                var imageBoxXUL = SMETHReadMessageController._smethControlFactory.createBoxXULElement(&quot;sepamailLogoBox&quot;);

                &#x2F;&#x2F; Create the image XUL element
                var imageXUL = SMETHReadMessageController._smethControlFactory.createImageXULElement(&quot;sepamailLogo&quot;,&quot;chrome:&#x2F;&#x2F;{appname}&#x2F;skin&#x2F;images&#x2F;sepamailLogo.png&quot;, &quot;32px&quot;, &quot;32px&quot;);
                imageXUL.setAttribute(&quot;onclick&quot;, &quot;SMETHReadMessageController.handleSEPAmailInfo();&quot;);

                &#x2F;&#x2F; Append the SEPAmail logo to the box
                imageBoxXUL.appendChild(imageXUL);

                &#x2F;&#x2F; Append SEPAmail logo box to the message header toolbox
                messageheaderToolBox.insertBefore(imageBoxXUL, document.getElementById(&quot;smimeBox&quot;));
            }
            else{}
        }
        catch(ex)
        {
            throw ex;
        }

    },
    
    &#x2F;**
     * initializeSEPAmailBodyUI function initialises the SEPAmail body user interface
     * 
     * @method initializeSEPAmailBodyUI
     *&#x2F;
    initializeSEPAmailBodyUI : function(){
        try
        {
            &#x2F;&#x2F; Declare the Body XSL url
            var bodyXSLUrl = this._smethConfigObject.settings.body;

            &#x2F;&#x2F; Check if the Body XSL Url is define
            if(&quot;&quot; != bodyXSLUrl)
            {
                &#x2F;&#x2F; Transform the SEPAmail XML document
                var sepamailBodyDocument = this._smethUtils.transformXMLDocument(this._smethMail.sepamailXMLObject, &quot;chrome:&#x2F;&#x2F;{appname}&#x2F;content&#x2F;xsl&#x2F;&quot; + bodyXSLUrl);

                &#x2F;&#x2F; Get the sepamailUIContainer
                var sepamailUIContainer = document.getElementById(&quot;sepamailUIContainer&quot;);

                &#x2F;&#x2F; Appends the resulting transformation fragment first child to the sepamailUIContainer
                sepamailUIContainer.appendChild(sepamailBodyDocument.firstChild);
            }
            else
            {
                throw new Error(&quot;XSL Url for SEPAmail body is not define in the configuration file&quot;);
            }
        }
        catch(ex)
        {
            throw ex;
        }
    },

    &#x2F;**
     * initializeSEPAmailAttachmentUI function initialises the SEPAmail attachment user interface
     * 
     * @method initializeSEPAmailAttachmentUI
     *&#x2F;
    initializeSEPAmailAttachmentUI : function(){
        try
        {
            &#x2F;&#x2F; Declare the attachment XSL url
            var attachmentXSLUrl = this._smethPreferences.getCharPref(&quot;missive.attachment&quot;);

            &#x2F;&#x2F; Check if the attachment XSL Url is define
            if(&quot;&quot; != attachmentXSLUrl)
            {
                &#x2F;&#x2F; Transform the SEPAmail XML document
                var sepamailAttachmentDocument = this._smethUtils.transformXMLDocument(this._smethMail.sepamailXMLObject, &quot;chrome:&#x2F;&#x2F;{appname}&#x2F;content&#x2F;xsl&#x2F;&quot; + attachmentXSLUrl);

                &#x2F;&#x2F; Get the sepamailUIContainer
                var sepamailUIContainer = document.getElementById(&quot;sepamailUIContainer&quot;);

                &#x2F;&#x2F; Appends the resulting transformation fragment first child to the sepamailUIContainer
                sepamailUIContainer.appendChild(sepamailAttachmentDocument.firstChild);

                &#x2F;&#x2F; Calculates and sets the attachements size
                SMETHAttachmentController.calculateAttachmentSize();
            }
            else
            {
                throw new Error(&quot;XSL Url for SEPAmail attachment is not define in the configuration file&quot;);
            }
        }
        catch(ex)
        {
            throw ex;
        }
    },

   &#x2F;**
    * getMailBody recursive function get the message body from the message content parts parametered
    *
    * @method getMailBody
    * @param {Object} aMessageParts Object
    * @return {String} Message body String
    *&#x2F;
    getMailBody : function (aMessageParts) {
        try
        {
            if(!aMessageParts)
            {
                &#x2F;&#x2F; If the part contains a body
                if(aMessageParts.body)
                {
                    &#x2F;&#x2F; Return the body
                    return aMessageParts.body;
                }
                else
                {
                    &#x2F;&#x2F; Call the getMessageBody function again
                    return this.getMailBody(aMessageParts.parts[0]);
                }
            }
            else
            {
                return document.getElementById(&quot;messagepane&quot;).contentDocument.body.textContent.replace(&#x2F;(\n|\t)&#x2F;gm,&quot;&quot;);
            }
        }
        catch(ex)
        {
            throw ex;
        }
    },

    &#x2F;**
     * isSEPAmail function checks if a mail is a SEPAmail
     *
     * @method isSEPAmail
     * @param {Object} aSmethMail object
     * @return {Boolean} Whether the mail is a SEPAmail
     *&#x2F;
    isSEPAmail : function (aSmethMail){
        try
        {
            &#x2F;&#x2F;TODO: Proper check for isSEPAmail

            &#x2F;&#x2F; Check the preference value whether we should fo the check if body is XML
            if(this._smethPrefIsBodyXML)
            {
                &#x2F;&#x2F; Check if the body is XML
                if(SMETHReadMessageController.checkBodyContainsTag(aSmethMail.body, &quot;&lt;?xml&quot;))
                {
                    var sepamailXMLTags = this._smethPrefSEPAmailXMLTag.split(&quot;;&quot;);

                    for(i=0; i &lt; sepamailXMLTags.length; i++)
                    {
                        &#x2F;&#x2F; Check if the body contains a specific tag
                        if(SMETHReadMessageController.checkBodyContainsTag(aSmethMail.body, sepamailXMLTags[i]))
                        {
                            this._smethMail.sepamailType = sepamailXMLTags[i].split(&quot;:&quot;)[1].toLowerCase();
                            return true;
                        }
                        else{}
                    }
                }
                else{}
            }
            else{}

            return false;
        }
        catch(ex)
        {
            throw ex;
        }
    },

    &#x2F;**
     * getSEPAmailMessageType function return the SEPAmail message type
     *
     * @method getSEPAmailMessageType
     * @param {Object} aSmethMail Smeth mail object
     * @return {String} The SEPAmail message type
     *&#x2F;
    getSEPAmailMessageType : function (aSmethMail){
        try
        {
            &#x2F;&#x2F; Check if aSmethMail is a SEPAmail
            if(aSmethMail.isSEPAmail)
            {
                 &#x2F;&#x2F; SEPAmail type switch
                switch(aSmethMail.sepamailType)
                {
                    &#x2F;&#x2F; Case for missive
                    case &quot;missive&quot;:
                        &#x2F;&#x2F; Create the SEPAmail namespace resolver object
                        var sepamailNSResolver = this._smethMail.sepamailXMLObject.createNSResolver (this._smethMail.sepamailXMLObject);

                        &#x2F;&#x2F; Get the SEPAmail message type using Xpath
                        return this._smethMail.sepamailXMLObject.evaluate(this._smethPrefMissiveMsgTypXpath, this._smethMail.sepamailXMLObject, sepamailNSResolver, XPathResult.STRING_TYPE,null).stringValue;
                    break;
                }
            }

            return &#x27;&#x27;;
        }
        catch(ex)
        {
            throw ex;
        }
    },

    &#x2F;**
     * checkBodyContainsTag function checks if body conatains the parametered tag
     *
     * @method checkBodyContainsTag
     * @param {String} aBody String
     * @param {String} aTag  String
     * @return {Boolean} Whether the mail body contains the parametered tag
     *&#x2F;
    checkBodyContainsTag : function (aBody, aTag){
        try
        {
            &#x2F;&#x2F; Returns true if body is of type XML
            return -1 != aBody.indexOf(aTag)  ? true : false;
        }
        catch(ex)
        {
            throw ex;
        }
    },

    &#x2F;**
     * checkAttachmentsContentType function checks if the mail content
     * contains an attachement of the parametred content type
     *
     * @method checkAttachmentsContentType
     * @param {Object} aMailContent Object
     * @param {String} aContentType String
     * @return {Boolean} Whether the mail is of type xml
     *&#x2F;
    checkAttachmentsContentType : function(aMailContent, aContentType){

        try
        {
            for(i=0; i &lt; aMailContent.allAttachments.length; i++)
            {
                if(aContentType == aMailContent.allAttachments[i].contentType)
                {
                    return true;
                }
                else
                {
                    return false;
                }
            }

            return false;
        }
        catch(ex)
        {
            throw ex;
        }
    },

    &#x2F;**
     * toogleMessageHeaderButtons function toogle the message header buttons depending whether its a SEPAmail or not
     * 
     * @method toogleMessageHeaderButtons
     *&#x2F;
    toogleMessageHeaderButtons : function()
    {
        try
        {
            &#x2F;&#x2F; Get the header view toolbar
            var headerViewToolbar = document.getElementById(&quot;header-view-toolbar&quot;);

            &#x2F;&#x2F; Get the header other actions button
            var otherActionsButton = document.getElementById(&quot;otherActionsButton&quot;);

            &#x2F;&#x2F; Get the header subject row and textbox
            var subjectRow = document.getElementById(&quot;expandedsubjectRow&quot;);

            &#x2F;&#x2F; Get the to label
            var toLabel = document.getElementById(&quot;expandedtoLabel&quot;);

            if(SMETHReadMessageController._smethMail.isSEPAmail)
            {

                &#x2F;&#x2F; Hide the header buttons
                headerViewToolbar.hidden = true;
                otherActionsButton.hidden = true;

                &#x2F;&#x2F; Hide Subject
                if(SMETHReadMessageController._smethMail.header.subject == &quot;&quot;)
                {
                    &#x2F;&#x2F; Collapse the subject row
                    subjectRow.collapsed = true;

                    &#x2F;&#x2F; Correct the to label when the subject row is collapsed
                    toLabel.setAttribute(&quot;style&quot;, &quot;margin-left:2.8em;&quot;);
                }
                else
                {
                    &#x2F;&#x2F; Expand the subject row
                    subjectRow.collapsed = false;

                    &#x2F;&#x2F; Remove the correction for the to label
                    toLabel.removeAttribute(&quot;style&quot;);
                }
            }
            else
            {
                &#x2F;&#x2F; Unhide the header buttons
                headerViewToolbar.hidden = false;
                otherActionsButton.hidden = false;

                &#x2F;&#x2F;&#x2F; Expand the subject row
                subjectRow.collapsed = false;

                 &#x2F;&#x2F; Remove the correction for the to label
                toLabel.removeAttribute(&quot;style&quot;);
            }
        }
        catch(ex)
        {
            throw ex;
        }
    },
    
    &#x2F;**
     * handleReportButtonClick function handles the click event for report buttons
     * 
     * @method handleReportButtonClick
     * @param {String} anXSLUrl XSL Url for report form
     *&#x2F;
    handleReportButtonClick : function (anXSLUrl) {
        try
        {
            &#x2F;&#x2F; Transform the SEPAmail XML document to get the report XML
            var sepamailReportDocument = this._smethUtils.transformXMLDocument(this._smethMail.sepamailXMLObject, &quot;chrome:&#x2F;&#x2F;{appname}&#x2F;content&#x2F;xsl&#x2F;&quot; + anXSLUrl);
            
            &#x2F;&#x2F; Get the account that will be used to send the report
            var account = this._getAccount(this._smethMail.header);
            
            &#x2F;&#x2F; Open the compose window
            this._smethUtils.openComposeWindow((new XMLSerializer()).serializeToString(sepamailReportDocument), account, this._smethMail.header);
        }
        catch (ex)
        {
            throw ex;
        }
    },

    &#x2F;**
     * Get the account on which the email corresponding to the specified header was obtained
     *
     * @method _getAccount
     * @param {Object} aMsgHdr Message header
     * @return {Object} Account on which the header of the corresponding email was obtained
     * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Thunderbird&#x2F;Account_interfaces
     * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Thunderbird&#x2F;Account_examples
     *&#x2F;
    _getAccount : function(aMsgHdr) {

        var account;

        &#x2F;&#x2F; Account manager interface instance
        &#x2F;&#x2F; @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Thunderbird&#x2F;Account_interfaces
        &#x2F;&#x2F; @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Thunderbird&#x2F;Account_examples
        var accountManager = Components.classes[&quot;@mozilla.org&#x2F;messenger&#x2F;account-manager;1&quot;]
                                       .getService(Components.interfaces.nsIMsgAccountManager);

        &#x2F;&#x2F; List of registered accounts
        var accounts = accountManager.accounts;

        &#x2F;&#x2F; Scan the list of accounts and get the account for sending the acknowledgement
        for (var i = 0; i &lt; accounts.Count(); i++) {

            &#x2F;&#x2F; Current account
            var currentAccount = accounts.QueryElementAt(i, Components.interfaces.nsIMsgAccount);

            &#x2F;&#x2F; Check if we have an account key for the message header
            if (aMsgHdr.accountKey == &quot;&quot;) {

                &#x2F;&#x2F; Check if the defaultIdentity property has been defined the current account
                if (currentAccount.defaultIdentity != undefined) {

                    &#x2F;&#x2F; Check the email address
                    if (currentAccount.defaultIdentity.email == aMsgHdr.mime2DecodedRecipients) {
                        account = currentAccount;
                        break;
                    }

                    &#x2F;&#x2F; Check the identity name
                    if (currentAccount.defaultIdentity.identityName == aMsgHdr.mime2DecodedRecipients) {
                        account = currentAccount;
                        break;
                    }
                }

            } else {

                &#x2F;&#x2F; Check the account key
                if (currentAccount.key == aMsgHdr.accountKey) {
                    account = currentAccount;
                    break;
                }
            }

        }

        return account;
    },

    &#x2F;**
     * defaultSmethAccount function returns the default smeth account to send mail
     *
     * @method getDefaultSmethAccount
     * @return {Object} Default smeth account to send mail
     * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Thunderbird&#x2F;Account_interfaces
     * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Thunderbird&#x2F;Account_examples
     *&#x2F;
    getDefaultSmethAccount : function() {
        try
        {
            &#x2F;&#x2F; Intantiate the account manager interface
            &#x2F;&#x2F; @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Thunderbird&#x2F;Account_interfaces
            &#x2F;&#x2F; @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Thunderbird&#x2F;Account_examples
            var accountMgr = Components.classes[&quot;@mozilla.org&#x2F;messenger&#x2F;account-manager;1&quot;]
                             .getService(Components.interfaces.nsIMsgAccountManager);

            &#x2F;&#x2F; Get the acceptation report XSL url based on the SEPAmail type and SEPAmail Message Type
            var smethAccountEmail = this._smethPreferences.getCharPref( &quot;defaultAccountEmail&quot;);

            if(&quot;&quot; != smethAccountEmail)
            {
                var accounts = accountMgr.accounts;

                for (var i = 0; i &lt; accounts.Count(); i++){

                    var account = accounts.QueryElementAt(i, Components.interfaces.nsIMsgAccount);

                        if(account.defaultIdentity)
                        {
                            if(smethAccountEmail == account.defaultIdentity.email)
                            {
                                return account;
                            }
                            else{}
                        }
                        else{}
                }
            }
            else
            {
                 throw new Error(&quot;Default SMETH account is not define in the configuration file so we are using the default thunderbird account.&quot;);
            }
            return accountMgr.defaultAccount;
        }
        catch (ex)
        {
            throw ex;
        }
    },

    &#x2F;**
     * composeRequestButtonClick function handles the click event for the composeRequestButton
     *
     * @method composeRequestButtonClick
     * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Extensions&#x2F;Thunderbird&#x2F;HowTos&#x2F;Common_Thunderbird_Use_Cases&#x2F;Compose_New_Message
     * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;XPCOM_Interface_Reference&#x2F;nsIIOService
     *&#x2F;
    
    composeRequestButtonClick : function() {
        try {
            
            &#x2F;&#x2F; Compose service instance
            &#x2F;&#x2F; @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Extensions&#x2F;Thunderbird&#x2F;HowTos&#x2F;Common_Thunderbird_Use_Cases&#x2F;Compose_New_Message
            var msgComposeService=
            Components.classes[&quot;@mozilla.org&#x2F;messengercompose;1&quot;]
            .getService(Components.interfaces.nsIMsgComposeService);

            &#x2F;&#x2F; make the URI
            &#x2F;&#x2F; @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;XPCOM_Interface_Reference&#x2F;nsIIOService
            var ioService =
                Components.classes[&quot;@mozilla.org&#x2F;network&#x2F;io-service;1&quot;]
                .getService(Components.interfaces.nsIIOService);

            &#x2F;&#x2F; Decalre the XMLHttpRequest to load the template XML
            var xmlHttpRequest = new XMLHttpRequest();

            &#x2F;&#x2F; Template XML URL
            var templateXML = this._smethPreferences.getCharPref(&quot;missive.activation.request.compose.templateXMLUrl&quot;);

            &#x2F;&#x2F; Send request for the template XML document
            xmlHttpRequest.open(&#x27;GET&#x27;, templateXML, false);
            xmlHttpRequest.send();

            &#x2F;&#x2F; Get the temple XML document object
            var templateXMLDocument = xmlHttpRequest.responseXML;

            &#x2F;&#x2F; Build the URL that will paramter the compose window
            var sURL = &quot;mailto:?body=&quot; + (new XMLSerializer()).serializeToString(templateXMLDocument);
            var aURI = ioService.newURI(sURL, null, null);

            &#x2F;&#x2F; Open new message window
            msgComposeService.OpenComposeWindowWithURI (null, aURI);

        } catch (ex) {
            throw ex;
        }
    },

    &#x2F;**
     * composeTestRequestButtonClick function handles the click event for the composeTestRequestButton
     *
     * @method composeTestRequestButtonClick
     * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Extensions&#x2F;Thunderbird&#x2F;HowTos&#x2F;Common_Thunderbird_Use_Cases&#x2F;Compose_New_Message
     * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;XPCOM_Interface_Reference&#x2F;nsIIOService
     *&#x2F;
    composeTestRequestButtonClick : function() {
        try {
            &#x2F;&#x2F; Compose service instance
            &#x2F;&#x2F; @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Extensions&#x2F;Thunderbird&#x2F;HowTos&#x2F;Common_Thunderbird_Use_Cases&#x2F;Compose_New_Message
            var msgComposeService=
            Components.classes[&quot;@mozilla.org&#x2F;messengercompose;1&quot;]
            .getService(Components.interfaces.nsIMsgComposeService);

            &#x2F;&#x2F; make the URI
            &#x2F;&#x2F; @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;XPCOM_Interface_Reference&#x2F;nsIIOService
            var ioService =
                Components.classes[&quot;@mozilla.org&#x2F;network&#x2F;io-service;1&quot;]
                .getService(Components.interfaces.nsIIOService);

            &#x2F;&#x2F; Decalre the XMLHttpRequest to load the template XML
            var xmlHttpRequest = new XMLHttpRequest();

            &#x2F;&#x2F; Template XML URL
            var templateXML = this._smethPreferences.getCharPref(&quot;missive.simple.request.compose.templateXMLUrl&quot;);

            &#x2F;&#x2F; Send request for the template XML document
            xmlHttpRequest.open(&#x27;GET&#x27;, templateXML, false);
            xmlHttpRequest.send();

            &#x2F;&#x2F; Get the temple XML document object
            var templateXMLDocument = xmlHttpRequest.responseXML;

            &#x2F;&#x2F; Build the URL that will paramter the compose window
            var sURL = &quot;mailto:?body=&quot; + (new XMLSerializer()).serializeToString(templateXMLDocument);
            var aURI = ioService.newURI(sURL, null, null);

            &#x2F;&#x2F; Open new message window
            msgComposeService.OpenComposeWindowWithURI (null, aURI);

        } catch (ex) {
            throw ex;
        }
    },
    
    &#x2F;**
     * handleSEPAmailInfo function handles SEPAmail logo click event
     *
     * @method handleSEPAmailInfo
     *&#x2F;
    handleSEPAmailInfo : function() {
        
        
        &#x2F;&#x2F; Create the SEPAmail namespace resolver object
        var sepamailNSResolver = this._smethMail.sepamailXMLObject.createNSResolver (this._smethMail.sepamailXMLObject);


        var sender;
        var qxban;
        
        switch (SMETHReadMessageController._smethMessageType) {

            case &#x27;SEPAMAIL_ACKNOWLEDGEMENT&#x27;:
                try {
                    &#x2F;&#x2F; Get the sender
                    sender = this._smethMail.sepamailXMLObject.evaluate(&quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvHdr&#x2F;sem:Snd&quot;, this._smethMail.sepamailXMLObject, sepamailNSResolver, XPathResult.STRING_TYPE,null).stringValue;
                    qxban = this._smethMail.sepamailXMLObject.evaluate(&quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvHdr&#x2F;sem:Snd&quot;, this._smethMail.sepamailXMLObject, sepamailNSResolver, XPathResult.STRING_TYPE,null).stringValue;
                } catch (e) {
                    SMETHReadMessageController._smethMessageHandler.exception(e);
                }
                break;
            case &#x27;SEPAMAIL_REQUEST&#x27;:
                try {
                    &#x2F;&#x2F; Get the sender
                    sender = this._smethMail.sepamailXMLObject.evaluate(&quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvBdy&#x2F;sem:sepamail_message_001&#x2F;sem:MsgBdy&#x2F;sem:ActivationRequest&#x2F;sem:ReqCompl&#x2F;sem:Request&#x2F;pain013:PmtInf&#x2F;pain013:Dbtr&#x2F;pain013:Nm&quot;, this._smethMail.sepamailXMLObject, sepamailNSResolver, XPathResult.STRING_TYPE,null).stringValue;
                    qxban = this._smethMail.sepamailXMLObject.evaluate(&quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvHdr&#x2F;sem:Snd&#x2F;sem:IBAN&quot;, this._smethMail.sepamailXMLObject, sepamailNSResolver, XPathResult.STRING_TYPE,null).stringValue;
                } catch (e) {
                    SMETHReadMessageController._smethMessageHandler.exception(e);
                }
                break;

            default:
                &#x2F;&#x2F; We do not handle other types of content and allow Thunderbird to control the sending of messages
        }
        
        &#x2F;&#x2F; Open the dialogue
        window.openDialog(&quot;chrome:&#x2F;&#x2F;Smeth&#x2F;content&#x2F;SMETHInfoView.xul&quot;, &quot;&quot;, &quot;chrome,resizable=1,modal=1,dialog=1&quot;,sender,qxban);
        
        
    },
    
    &#x2F;**
     * handleExporttoEML function handles the export to EML operation
     *
     * @method handleExporttoEML
     *&#x2F;
    handleExporttoEML : function(aType) {
        
        var xslUrl;
        &#x2F;&#x2F; Type of export
        switch(aType)
        {
            &#x2F;&#x2F; Case to Export the envelope
            case &#x27;env&#x27;:
                &#x2F;&#x2F; SEPAmail type switch
                switch(this._smethMail.sepamailType)
                {
                    &#x2F;&#x2F; Case for missive
                    case this._smethPrefMissiveRootTag:
                        &#x2F;&#x2F; Get the xsl url for envelope export
                        xslUrl = this._smethPreferences.getCharPref(this._smethMail.sepamailType+&quot;.&quot;+this._smethMail.sepamailMessageType.split(&#x27;@&#x27;)[0]+&quot;.export.envelopeXSLUrl&quot;);
                    break;
                }
            break;
            &#x2F;&#x2F; Case to Export the missive
            case &#x27;mis&#x27;:
                &#x2F;&#x2F; SEPAmail type switch
                switch(this._smethMail.sepamailType)
                {
                    &#x2F;&#x2F; Case for missive
                    case this._smethPrefMissiveRootTag:
                        &#x2F;&#x2F; Get the xsl url for missive export
                        xslUrl = this._smethPreferences.getCharPref(this._smethMail.sepamailType+&quot;.&quot;+this._smethMail.sepamailMessageType.split(&#x27;@&#x27;)[0]+&quot;.export.missiveXSLUrl&quot;);
                    break;
                }
            break;
            &#x2F;&#x2F; Case to Export the message
            case &#x27;mess&#x27;:
                &#x2F;&#x2F; SEPAmail type switch
                switch(this._smethMail.sepamailType)
                {
                    &#x2F;&#x2F; Case for missive
                    case this._smethPrefMissiveRootTag:
                        &#x2F;&#x2F; Get the xsl url for message export
                        xslUrl = this._smethPreferences.getCharPref(this._smethMail.sepamailType+&quot;.&quot;+this._smethMail.sepamailMessageType.split(&#x27;@&#x27;)[0]+&quot;.export.messageXSLUrl&quot;);
                    break;
                }
            break;
            &#x2F;&#x2F; Case to Export the whole message
            case &#x27;all&#x27;:
                &#x2F;&#x2F; SEPAmail type switch
                switch(this._smethMail.sepamailType)
                {
                    &#x2F;&#x2F; Case for missive
                    case this._smethPrefMissiveRootTag:
                        &#x2F;&#x2F; Get the xsl url for message export
                        xslUrl = this._smethPreferences.getCharPref(this._smethMail.sepamailType+&quot;.&quot;+this._smethMail.sepamailMessageType.split(&#x27;@&#x27;)[0]+&quot;.export.allXSLUrl&quot;);
                    break;
                }
            break;
        }
        
        var messageIdXpath;
        
        &#x2F;&#x2F; SEPAmail type switch
        switch(this._smethMail.sepamailType)
        {
            &#x2F;&#x2F; Case for missive
            case this._smethPrefMissiveRootTag:
                &#x2F;&#x2F; Get message id xpath
                messageIdXpath = this._smethPreferences.getCharPref(this._smethMail.sepamailType+&quot;.&quot;+this._smethMail.sepamailMessageType.split(&#x27;@&#x27;)[0]+&quot;.messageIdXpath&quot;);
            break;
        }
        
        &#x2F;&#x2F; Check if the XSL Url is define
        if(&quot;undefined&quot; != xslUrl)
        {
           if(&quot;undefined&quot; != messageIdXpath)
           {
                &#x2F;&#x2F; Create the SEPAmail namespace resolver object
                var sepamailNSResolver = this._smethMail.sepamailXMLObject.createNSResolver (this._smethMail.sepamailXMLObject);

                &#x2F;&#x2F; Get the SEPAmail message type using Xpath
                var messageId = this._smethMail.sepamailXMLObject.evaluate(messageIdXpath, this._smethMail.sepamailXMLObject, sepamailNSResolver, XPathResult.STRING_TYPE,null).stringValue;
                
                &#x2F;&#x2F; Transform for export
                var exportDocument = this._smethUtils.transformXMLDocument(this._smethMail.sepamailXMLObject, xslUrl);
                
                &#x2F;&#x2F; Export the document
                if(&quot;env&quot; == aType) {
                    this.saveToFile(messageId + &quot;.&quot; + aType + &quot;.eml&quot;, (new XMLSerializer()).serializeToString(exportDocument));
                } else {
                    this.saveToFile(messageId + &quot;.&quot; + aType + &quot;.xml&quot;, (new XMLSerializer()).serializeToString(exportDocument));
                }
           }
           else
           {
                throw new Error(&quot;Xpath to obtain the message ID is not define in the configuration file&quot;);
           }
        }
        else
        {
            throw new Error(&quot;XSL Url for export operation is not define in the configuration file&quot;);
        }

    },
    
    &#x2F;**
     * Save a file to local storage
     *
     * @method saveToFile
     * @param {String} filename Name of the file
     * @param {String} content File content
     *&#x2F;
    saveToFile : function(filename, content) {

        &#x2F;&#x2F; Obtain the location at which the file needs to be saved
        const nsIFilePicker = Components.interfaces.nsIFilePicker;

        &#x2F;&#x2F; File picker instance
        var fp = Components.classes[&quot;@mozilla.org&#x2F;filepicker;1&quot;]
                           .createInstance(nsIFilePicker);
        fp.init(window, &quot;Save file &quot; + filename, nsIFilePicker.modeSave);
        fp.defaultString = filename;

        &#x2F;&#x2F; Show the file picker
        var rv = fp.show();

        &#x2F;&#x2F; Check if user has chosen an attachment file location
        if (rv == nsIFilePicker.returnOK || rv == nsIFilePicker.returnReplace) {

            try {

                &#x2F;&#x2F; File to which content needs to be written
                var file = fp.file;

                &#x2F;&#x2F; Stream for writing binary file
                var stream = Components.classes[&quot;@mozilla.org&#x2F;network&#x2F;safe-file-output-stream;1&quot;]
                                       .createInstance(Components.interfaces.nsIFileOutputStream);
                stream.init(file, 0x04 | 0x08 | 0x20, 0600, 0);
                stream.write(content, content.length);

                &#x2F;&#x2F; Close the stream
                if (stream instanceof Components.interfaces.nsISafeOutputStream) {
                    stream.finish();
                } else {
                    stream.close();
                }
            } catch (e) {
                throw e;
            }
        }
    }
}

&#x2F;&#x2F; Add the window load event listener 
&#x2F;&#x2F; Entry point of the Smeth plugin
&#x2F;&#x2F; @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Code_snippets&#x2F;On_page_load
window.addEventListener(&quot;load&quot;, function load(event) {

    try
    {
        &#x2F;&#x2F;remove listener, no longer needed
        window.removeEventListener(&quot;load&quot;, load, false);

        &#x2F;&#x2F; Get the message pane
        var messagepane = document.getElementById(&quot;messagepane&quot;);

        &#x2F;&#x2F; Check if the message pane is valid
        if(messagepane)
        {   &#x2F;&#x2F; Initialize the SMETHReadMessageController
            SMETHReadMessageController.init();

            &#x2F;&#x2F; Add load event for message pane to be triggered on each message select
            &#x2F;&#x2F; @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Code_snippets&#x2F;On_page_load
            messagepane.addEventListener(&quot;load&quot;, function(event) {SMETHReadMessageController.onMessagePaneLoad(event);}, true);
        }

        &#x2F;&#x2F; Message listener service
        &#x2F;&#x2F; @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Extensions&#x2F;Thunderbird&#x2F;HowTos&#x2F;Common_Thunderbird_Use_Cases&#x2F;Open_Folder
        var notificationService = Components.classes[&quot;@mozilla.org&#x2F;messenger&#x2F;msgnotificationservice;1&quot;]
                                            .getService(Components.interfaces.nsIMsgFolderNotificationService);

        &#x2F;&#x2F; Register listener for new messages
        &#x2F;&#x2F; @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Extensions&#x2F;Thunderbird&#x2F;HowTos&#x2F;Common_Thunderbird_Use_Cases&#x2F;Open_Folder
        notificationService.addListener(SMETHAcknowledgementController, notificationService.msgAdded);

    }
    catch(ex)
    {
        SMETHReadMessageController._smethMessageHandler.exception(ex);
    }
}, false);
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
