<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>content&#x2F;controllers&#x2F;SMETHComposeMessageController.js</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.8.0pr2&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.8.0pr2&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="..&#x2F;assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/SMETHAcknowledgementController.html">SMETHAcknowledgementController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHAcknowledgementPreferencesController.html">SMETHAcknowledgementPreferencesController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHAddressBookController.html">SMETHAddressBookController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHAdvancedPreferencesController.html">SMETHAdvancedPreferencesController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHAttachmentController.html">SMETHAttachmentController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHAutomaticAcknowledgementController.html">SMETHAutomaticAcknowledgementController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHBankPreferencesController.html">SMETHBankPreferencesController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHComposeMessageController.html">SMETHComposeMessageController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHControlFactory.html">SMETHControlFactory</a></li>
            
                <li><a href="..&#x2F;classes/SMETHExportController.html">SMETHExportController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHHeaderController.html">SMETHHeaderController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHMail.html">SMETHMail</a></li>
            
                <li><a href="..&#x2F;classes/SMETHMailPreferencesController.html">SMETHMailPreferencesController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHMessageHandler.html">SMETHMessageHandler</a></li>
            
                <li><a href="..&#x2F;classes/SMETHMessageListController.html">SMETHMessageListController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHOptionController.html">SMETHOptionController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHRawContentController.html">SMETHRawContentController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHReadMessageController.html">SMETHReadMessageController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHReportController.html">SMETHReportController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHRequestController.html">SMETHRequestController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHUtils.html">SMETHUtils</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="..&#x2F;modules/smeth.html">smeth</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: content&#x2F;controllers&#x2F;SMETHComposeMessageController.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x2F;* ***** BEGIN LICENSE BLOCK *****
 * This file is part of smeth (https:&#x2F;&#x2F;code.google.com&#x2F;p&#x2F;sepamail-smeth&#x2F;)
 *
 * Version: MPL 2.0&#x2F;GPL 3.0&#x2F;LGPL 3.0
 *
 * The contents of this file are subject to the Mozilla Public License Version
 * 2.0 (the &quot;License&quot;); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 * http:&#x2F;&#x2F;www.mozilla.org&#x2F;MPL&#x2F;2.0&#x2F;
 *
 * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,
 * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
 * for the specific language governing rights and limitations under the
 * License.
 *
 * The Initials Developers of the Original Code are :
 *  Ammit Heeramun, idSoft
 *  Bishan Kumar Madhoo, idSoft
 *  Manfred Sherlock Olm, deciBI &amp; vizGet
 * Portions created by the Initials Developers are Copyright (C) 2012
 * the Initial Developer. All Rights Reserved.
 *
 * Contributor(s):
 *  Ammit Heeramun
 *  Bishan Kumar Madhoo
 *  Manfred Sherlock Olm, smeth@decibi.fr
 *
 * Alternatively, the contents of this file may be used under the terms of
 * either the GNU General Public License Version 3 or later (the &quot;GPL&quot;), or
 * the GNU Lesser General Public License Version 3.0 or later (the &quot;LGPL&quot;),
 * in which case the provisions of the GPL or the LGPL are applicable instead
 * of those above. If you wish to allow use of your version of this file only
 * under the terms of either the GPL or the LGPL, and not to allow others to
 * use your version of this file under the terms of the MPL, indicate your
 * decision by deleting the provisions above and replace them with the notice
 * and other provisions required by the GPL or the LGPL. If you do not delete
 * the provisions above, a recipient may use your version of this file under
 * the terms of any one of the MPL, the GPL or the LGPL.
 *
 * ***** END LICENSE BLOCK ***** *&#x2F;

&#x2F;**
 * @module smeth
 * @file SMETHComposeMessageController.js
 * @mvc controller
 * @version 1212
 * @since 1210
 * @author Ammit Heeramun
 * @description SMETHComposeMessageController is the class that is attached to SMETHComposeMessageView, it helps in the setting up the composition windows for the composition of different type of SEPAmail messages.
 *&#x2F;

&#x2F;**
 * SMETHMessageHandler class contain functions to handle info, error, warning and exceptions messages
 *
 * @include SMETHMessageHandler.js
 *&#x2F;
Components.utils.import(&quot;resource:&#x2F;&#x2F;smeth&#x2F;smethlib&#x2F;SMETHMessageHandler.js&quot;);

&#x2F;**
 * @description Strict mode for scripts
 * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;JavaScript&#x2F;Reference&#x2F;Functions_and_function_scope&#x2F;Strict_mode
 *&#x2F;
&quot;use strict&quot;;

&#x2F;**
 * SMETHComposeMessageController class defines all the events that is related to &quot;SMETHComposeMessageView&quot;
 *
 * @class SMETHComposeMessageController
 *&#x2F;
var SMETHComposeMessageController = {


   &#x2F;**
    * Compose window content frame
    *
    * @attribute _contentFrame
    * @private
    * @default null
    *&#x2F;
    _contentFrame : null,

    &#x2F;**
     * Declare the SMETHMessageHandler class
     *
     * @attribute _smethMessageHandler
     * @private
     *&#x2F;
    _smethMessageHandler : new SMETHMessageHandler(window),

    &#x2F;**
     * Smeth message type
     *
     * @attribute _smethMessageType
     * @private
     * @default null
     *&#x2F;
    _smethMessageType : null,

    &#x2F;**
     * Declare the smeth preferences class
     *
     * @attribute _smethPreferences
     * @private
     * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Code_snippets&#x2F;Preferences#XPCOM_interfaces_for_preferences_system
     *&#x2F;
    _smethPreferences : Components.classes[&quot;@mozilla.org&#x2F;preferences-service;1&quot;]
                                  .getService(Components.interfaces.nsIPrefService)
                                  .getBranch(&quot;extensions.smeth.&quot;),

    &#x2F;**
     * Declare the message compose object
     *
     * @attribute _msgCompose
     * @private
     * @default null
     *&#x2F;
    _msgCompose : null,

    &#x2F;**
     * Initiation of the compose window
     *
     * @method init
     * @param {Object} event Event parameters
     * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Extensions&#x2F;Thunderbird&#x2F;HowTos&#x2F;Common_Thunderbird_Use_Cases&#x2F;Compose_New_Message
     *&#x2F;
    init : function (event) {

        try {
            &#x2F;&#x2F; Instantiate the message compose object
            SMETHComposeMessageController._msgCompose = gMsgCompose;

            &#x2F;&#x2F; Register the compose window state listener
            &#x2F;&#x2F; @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Extensions&#x2F;Thunderbird&#x2F;HowTos&#x2F;Common_Thunderbird_Use_Cases&#x2F;Compose_New_Message
            gMsgCompose.RegisterStateListener(SMETHComposeMessageController);

        } catch(ex) {
            SMETHComposeMessageController._smethMessageHandler.exception(ex);
        }
    },

    &#x2F;**
     * NotifyComposeFieldsReady event raised when compose window is loaded and fields are ready
     *
     * @method NotifyComposeFieldsReady
     *&#x2F;
    NotifyComposeFieldsReady: function() {

    },

    &#x2F;**
     * NotifyComposeBodyReady event notifies when the compose body is ready
     *
     * @method NotifyComposeBodyReady
     *&#x2F;
    NotifyComposeBodyReady: function() {

        try {

            &#x2F;&#x2F; Get the compose window content frame
            this._contentFrame = document.getElementById(&quot;content-frame&quot;);

            &#x2F;&#x2F; Get the content body
            var content = this._contentFrame.contentDocument.body.textContent;

             &#x2F;&#x2F; Check if the SMETH compose window form container is present
            if (null != document.getElementById(&quot;smethComposeBodyFormContainer&quot;)) {
                 document.getElementById(&quot;appcontent&quot;).removeChild(document.getElementById(&quot;smethComposeBodyFormContainer&quot;));
            }

            &#x2F;&#x2F; Test for SEPAmail content
            if (content.length &gt; 0) {

                &#x2F;&#x2F; Check for SEPAmail report content
                if (SMETHReportController.isSEPAmailReport(content)) {

                    &#x2F;&#x2F; We have a SEPAmail valid report missive XML
                    this._smethMessageType = &#x27;SEPAMAIL_REPORT&#x27;;

                    &#x2F;&#x2F; Create SMETH form container
                    this._addSmethFormContainer();

                    &#x2F;&#x2F; Initialise the compose message window
                    this._initialiseSmethComposeWindow();

                    &#x2F;&#x2F; Call the NotifyComposeBodyReady event handler for SEPAMAIL_REPORT
                    SMETHReportController.NotifyComposeBodyReady();

                } else {

                    &#x2F;&#x2F; Check for SEPAmail acknowledgement content
                    if (SMETHAcknowledgementController.isAcknowledgementMissiveMessage(content)) {

                        &#x2F;&#x2F; We have a SEPAmail valid acknowledgement missive XML
                        this._smethMessageType = &#x27;SEPAMAIL_ACKNOWLEDGEMENT&#x27;;

                        &#x2F;&#x2F; Create SMETH form container
                        this._addSmethFormContainer();

                        &#x2F;&#x2F; Initialise the compose message window
                        this._initialiseSmethComposeWindow();

                        &#x2F;&#x2F; Call the NotifyComposeBodyReady event handler for SEPAMAIL_REPORT
                        SMETHAcknowledgementController.NotifyComposeBodyReady();

                    } else {

                         &#x2F;&#x2F; Check for SEPAmail request content
                        if (SMETHRequestController.isSEPAmailRequest(content)) {

                            &#x2F;&#x2F; We have a SEPAmail valid report missive XML
                            this._smethMessageType = &#x27;SEPAMAIL_REQUEST&#x27;;

                            &#x2F;&#x2F; Create SMETH form container
                            this._addSmethFormContainer();

                            &#x2F;&#x2F; Initialise the compose message window
                            this._initialiseSmethComposeWindow();

                            &#x2F;&#x2F; Call the NotifyComposeBodyReady event handler for SEPAMAIL_REQUEST
                            SMETHRequestController.NotifyComposeBodyReady();

                        } else {

                            &#x2F;&#x2F; We do not have a SEPAmail valid content
                            this._smethMessageType = &#x27;NORMAL&#x27;;

                            &#x2F;&#x2F; Remove SMETH specific compose window settings
                            this._disableSmethComposeWindow();
                        }
                    }
                }

            } else {

                &#x2F;&#x2F; We do not have a SEPAmail valid content
                this._smethMessageType = &#x27;NORMAL&#x27;;

                &#x2F;&#x2F; Remove SMETH specific compose window settings
                this._disableSmethComposeWindow();
            }

        } catch(ex) {
            SMETHComposeMessageController._smethMessageHandler.exception(ex);
        }
    },

    &#x2F;**
     * ComposeProcessDone event notifies when the compose process has been completed
     *
     * @method ComposeProcessDone
     *&#x2F;
    ComposeProcessDone: function(aResult) {

    },

    &#x2F;**
     * SaveInFolderDone event notifies when the save in folder has been completed
     *
     * @method SaveInFolderDone
     *
     *&#x2F;
    SaveInFolderDone: function(folderURI) {

    },

    &#x2F;**
     * SendMailEventHandler event handles the send event of an email
     *
     * @method SendMailEventHandler
     * @param {Object} anEvent Event parameters
     *&#x2F;
    SendMailEventHandler : function(anEvent) {

        &#x2F;&#x2F; Call the appropriate SendMailEventHandler as per the compose message window content
        switch (SMETHComposeMessageController._smethMessageType) {

            case &#x27;SEPAMAIL_REPORT&#x27;:
                try {
                    SMETHReportController.SendMailEventHandler(anEvent);
                } catch (e) {
                    SMETHComposeMessageController._smethMessageHandler.exception(e);
                }
                break;

            case &#x27;SEPAMAIL_ACKNOWLEDGEMENT&#x27;:
                try {
                    SMETHAcknowledgementController.SendMailEventHandler(anEvent);
                } catch (e) {
                    SMETHComposeMessageController._smethMessageHandler.exception(e);
                }
                break;

            case &#x27;SEPAMAIL_REQUEST&#x27;:
                try {
                    SMETHRequestController.SendMailEventHandler(anEvent);
                } catch (e) {
                    SMETHComposeMessageController._smethMessageHandler.exception(e);
                }
                break;

            default:
                &#x2F;&#x2F; We do not handle other types of content and allow Thunderbird to control the sending of messages
        }
    },

    &#x2F;**
     * AttachDocumentEventHandler event handles the attachment of SEPAmail Documents
     *
     * @method AttachDocumentEventHandler
     *&#x2F;
    AttachDocumentEventHandler : function() {

        &#x2F;&#x2F; Call the appropriate AttachDocumentEventHandler as per the compose message window content
        switch (SMETHComposeMessageController._smethMessageType) {

            case &#x27;SEPAMAIL_REPORT&#x27;:

                try {

                    SMETHReportController.AttachDocumentEventHandler();

                } catch (e) {

                    SMETHComposeMessageController._smethMessageHandler.exception(e);
                }

                break;

            case &#x27;SEPAMAIL_ACKNOWLEDGEMENT&#x27;:

                try {

                    &#x2F;&#x2F;SMETHAcknowledgementController.AttachDocumentEventHandler();
                    SMETHComposeMessageController._smethMessageHandler.info(&quot;SEPAmail attachments not yet handled acknowledgements&quot;);

                } catch (e) {

                    SMETHComposeMessageController._smethMessageHandler.exception(e);
                }

                break;

            case &#x27;SEPAMAIL_REQUEST&#x27;:

                try {

                    SMETHRequestController.AttachDocumentEventHandler();

                } catch (e) {

                    SMETHComposeMessageController._smethMessageHandler.exception(e);

                }

                break;

            default:
                &#x2F;&#x2F; We do not handle other types of content and allow Thunderbird to control the sending of messages
        }
    },

    &#x2F;**
     * Add the container for SMETH XUL forms to the compose window
     *
     * @method _addSmethFormContainer
     *&#x2F;
    _addSmethFormContainer : function() {

        &#x2F;&#x2F; Create XUL VBOX element which will contain SMETH XUL forms for compose window
        var container = document.createElementNS(&quot;http:&#x2F;&#x2F;www.mozilla.org&#x2F;keymaster&#x2F;gatekeeper&#x2F;there.is.only.xul&quot;,
            &quot;vbox&quot;);

        &#x2F;&#x2F; Set the properties of the container VBOX
        container.setAttribute(&quot;id&quot;, &quot;smethComposeBodyFormContainer&quot;);
        container.setAttribute(&quot;flex&quot;, &quot;1&quot;);

        &#x2F;&#x2F; Add the container to the compose message window
        document.getElementById(&quot;appcontent&quot;).appendChild(container);
    },

    &#x2F;**
     * _adjustAddressingWidget function adjust addressing widget height as per the number of lines
     *
     * @method _adjustAddressingWidget
     * @param {Integer} aLinesNo Number of lines to display
     *&#x2F;
    _adjustAddressingWidget : function(aLinesNo) {

        var addressingWidget = document.getElementById(&#x27;addressingWidget&#x27;);
        var MsgHeadersToolbar = document.getElementById(&#x27;MsgHeadersToolbar&#x27;);

        &#x2F;&#x2F;height of one row
        var oneRowHeight = document.getElementById(&#x27;addressCol1#1&#x27;).parentNode.boxObject.height;

        &#x2F;&#x2F;how many height we need to add to get MsgHeadersToolbar height from rows height.
        &#x2F;&#x2F;include all orther elements on MsgHeadersToolbar except addressingWidget client area
        var ExtraHeight = 2 + MsgHeadersToolbar.boxObject.height - addressingWidget.boxObject.element.clientHeight;

        &#x2F;&#x2F;set min and current height...
        MsgHeadersToolbar.removeAttribute(&#x27;minheight&#x27;);
        MsgHeadersToolbar.style.minHeight = (oneRowHeight + ExtraHeight).toString() + &#x27;px&#x27;;
        MsgHeadersToolbar.style.height = (oneRowHeight * aLinesNo + ExtraHeight).toString() + &#x27;px&#x27;;

        &#x2F;&#x2F;update addressingWidget internals
        awCreateOrRemoveDummyRows();
    },

    &#x2F;**
     * Check if a given account key has been activated for sending SEPAmail messages
     *
     * @method _checkIfActive
     * @param {String} accountKey Account key that has to be checked for its active status
     * @return Whether the account is activated for sending SEPAmail messages
     *&#x2F;
    _checkIfActive : function(accountKey) {

        &#x2F;&#x2F; Configuration of email accounts
        var accountsConfig = JSON.parse(this._smethPreferences.getCharPref(&#x27;myqxbans&#x27;));

        &#x2F;&#x2F; Scan the configuration settings for email accounts
        for (var i = 0; i &lt; accountsConfig.length; i++) {

            &#x2F;&#x2F; Check if we are at the required account
            if (accountsConfig[i].account == accountKey) {

                &#x2F;&#x2F; Check the active status of the account
                return accountsConfig[i].status != &#x27;INACTIVE&#x27;;
            }
        }

        return false;
    },

    &#x2F;**
     * Remove SMETH specific settings from the  the message compose window
     *
     * @method _disableSmethComposeWindow
     *&#x2F;
    _disableSmethComposeWindow : function() {

        &#x2F;&#x2F; Get the formatting toolbar
        var formattingToolBox = document.getElementById(&quot;FormatToolbox&quot;);

        &#x2F;&#x2F; Show the formatting toolbar
        formattingToolBox.hidden = false;

        &#x2F;&#x2F; Show the content frame
        this._contentFrame.hidden = false;

        &#x2F;&#x2F; Get the attachment button popup menu
        var attachmentButtonPopup = document.getElementById(&quot;button-attachPopup&quot;);

        &#x2F;&#x2F; Show the attachment button popup menu
        attachmentButtonPopup.hidden = false;

        &#x2F;&#x2F; Get the attachment button
        var attachmentButton = document.getElementById(&quot;button-attach&quot;);

        &#x2F;&#x2F; Customize the attachment button to attache SEPAmail documents
        attachmentButton.setAttribute(&quot;type&quot;, &quot;menu-button&quot;);
        attachmentButton.setAttribute(&quot;command&quot;, &quot;cmd_attachFile&quot;);
        attachmentButton.setAttribute(&quot;ondragover&quot;, &quot;nsDragAndDrop.dragOver(event, envelopeDragObserver);&quot;);
        attachmentButton.setAttribute(&quot;ondragdrop&quot;, &quot;nsDragAndDrop.drop(event, envelopeDragObserver);&quot;);
        attachmentButton.setAttribute(&quot;ondragexit&quot;, &quot;nsDragAndDrop.dragExit(event, envelopeDragObserver);&quot;);
        attachmentButton.setAttribute(&quot;oncommand&quot;, &quot;goDoCommand(&#x27;cmd_attachFile&#x27;)&quot;);
    },

    &#x2F;**
     * Get the index of a given account key in the list of addresses that a user can choose to send a SEPAmail message
     *
     * @method _getIndexOfAccountKeyInAddressList
     * @param {String} accountKey Account key for which corresponding address item index needs to be obtained
     * @return Index of given account in the list of addresses that a user can choose
     *&#x2F;
    _getIndexOfAccountKeyInAddressList : function(accountKey) {

        &#x2F;&#x2F; List of accounts
        var accountsList = document.getElementById(&#x27;msgIdentity&#x27;);

        &#x2F;&#x2F; Scan the list of accounts
        for (var i = 0; i &lt; accountsList.itemCount; i++) {

            &#x2F;&#x2F; Check if the we are at the required address item
            if (accountsList.getItemAtIndex(i).getAttribute(&quot;accountkey&quot;) == accountKey) {
                return i;
            }
        }

        return -1;
    },

    &#x2F;**
     * Initialise the message compose window for SMETH
     *
     * @method _initialiseSmethComposeWindow
     *&#x2F;
    _initialiseSmethComposeWindow : function() {

        &#x2F;&#x2F; Remove SMETH inactive accounts from  message composition address list
        this._removeInactiveAccount();

        &#x2F;&#x2F; Get the formatting toolbar
        var formattingToolBox = document.getElementById(&quot;FormatToolbox&quot;);

        &#x2F;&#x2F; Hide the formatting toolbar
        formattingToolBox.hidden = true;

        &#x2F;&#x2F; Hide the content frame
        this._contentFrame.hidden = true;

        &#x2F;&#x2F; Get the attachment button popup menu
        var attachmentButtonPopup = document.getElementById(&quot;button-attachPopup&quot;);

        &#x2F;&#x2F; Show the attachment button popup menu
        attachmentButtonPopup.hidden = true;

        &#x2F;&#x2F; Get the attachment button
        var attachmentButton = document.getElementById(&quot;button-attach&quot;);

        &#x2F;&#x2F; Customize the attachment button to attache SEPAmail documents
        attachmentButton.setAttribute(&quot;type&quot;, &quot;&quot;);
        attachmentButton.setAttribute(&quot;command&quot;, &quot;&quot;);
        attachmentButton.setAttribute(&quot;ondragover&quot;, &quot;&quot;);
        attachmentButton.setAttribute(&quot;ondragdrop&quot;, &quot;&quot;);
        attachmentButton.setAttribute(&quot;ondragexit&quot;, &quot;&quot;);
        attachmentButton.setAttribute(&quot;oncommand&quot;, &quot;SMETHComposeMessageController.AttachDocumentEventHandler()&quot;);

        &#x2F;&#x2F; Disable blank subject checking
        var genericSendMessageStr = GenericSendMessage.toString();
        genericSendMessageStr = genericSendMessageStr.replace(&quot;if (subject == \&quot;\&quot;)&quot;, &quot;if (false &amp;&amp; subject == \&quot;\&quot;)&quot;);
        genericSendMessageStr = genericSendMessageStr.replace(&quot;let&quot;, &quot;var&quot;);
        eval(&quot;GenericSendMessage = &quot; + genericSendMessageStr);

        &#x2F;&#x2F; Get the addressing widget
        var addressingWidget = document.getElementById(&quot;addressingWidget&quot;);

        &#x2F;&#x2F; Remove the all list item apart for the to list item.
        var menuPopup = addressingWidget.getElementsByTagName(&quot;menuitem&quot;);
        for (var i = 0; i &lt; menuPopup.length; i++) {
            if(&quot;addr_to&quot; != menuPopup[i].getAttribute(&quot;value&quot;)) {
                menuPopup[i].hidden = true;
            }
        }

        &#x2F;&#x2F; Remove the compose toolbar sizer
        var composeToolbarSizer = document.getElementById(&quot;compose-toolbar-sizer&quot;);
        composeToolbarSizer.hidden = true;

        &#x2F;&#x2F; Set the header box bottom border
        var appContent = document.getElementById(&quot;appcontent&quot;);
        appContent.setAttribute(&quot;style&quot;, &quot;border-top: 1px solid threedshadow;&quot;);

        &#x2F;&#x2F; Adjust the addressing widget height by one line
        this._adjustAddressingWidget(1);

        &#x2F;&#x2F; Disable the addition of new rows in the addressing widget
        var awAppendNewRowStr = awAppendNewRow.toString();
        awAppendNewRowStr  = awAppendNewRowStr.replace(&quot;if (listbox &amp;&amp; listitem1)&quot;, &quot;if (false)&quot;);
        eval(&quot;awAppendNewRow = &quot; + awAppendNewRowStr);

        &#x2F;&#x2F; Get the encrypt checkbox menu item
        var menuSecurityEncryptRequire = document.getElementById(&quot;menu_securityEncryptRequire2&quot;);

        &#x2F;&#x2F; Get the sign checkbox menu item
        var menuSecuritySign = document.getElementById(&quot;menu_securitySign2&quot;);

        &#x2F;&#x2F; Verify that security options have not already been checked
        if (!(menuSecurityEncryptRequire.checked &amp;&amp; menuSecuritySign.checked)) {

            &#x2F;&#x2F; Allow user to setup certificates if not previously done so
            if(!gCurrentIdentity.getUnicharAttribute(&quot;encryption_cert_name&quot;) ||
                !gCurrentIdentity.getUnicharAttribute(&quot;signing_cert_name&quot;)) {

                &#x2F;&#x2F; Show the message to setup certificates
                showNeedSetupInfo();

            }

            &#x2F;&#x2F; Check if the encryption certificate has been setup
            if(gCurrentIdentity.getUnicharAttribute(&quot;encryption_cert_name&quot;) &amp;&amp; !menuSecurityEncryptRequire.checked) {

                &#x2F;&#x2F; Check the Encrypt this mail checkbox menu item
                menuSecurityEncryptRequire.click();
            }

            &#x2F;&#x2F; Check if the sign certificate has been setup
            if (gCurrentIdentity.getUnicharAttribute(&quot;signing_cert_name&quot;) &amp;&amp; !menuSecuritySign.checked) {

                &#x2F;&#x2F; Check the Sign this mail checkbox menu item
                menuSecuritySign.click();
            }
        }
    },

    &#x2F;**
     * Remove SMETH inactive accounts from the list of accounts
     *
     * @method _removeInactiveAccount
     *&#x2F;
    _removeInactiveAccount : function() {

        &#x2F;&#x2F; Account keys that have to be removed
        var accountKeysToRemove = [];

        &#x2F;&#x2F; List of accounts
        var accountsList = document.getElementById(&#x27;msgIdentity&#x27;);

        &#x2F;&#x2F; Current account
        var currentAccountKey = &#x27;&#x27;;

        &#x2F;&#x2F; Get the current account key
        if (accountsList.selectedItem != null) {
            currentAccountKey = accountsList.selectedItem.getAttribute(&quot;accountkey&quot;);
        }

        &#x2F;&#x2F; Scan the list of accounts
        for (var i = 0; i &lt; accountsList.itemCount; i++) {

            &#x2F;&#x2F; Check if the we are not at the currently selected account
            if (accountsList.getItemAtIndex(i).getAttribute(&quot;accountkey&quot;) != currentAccountKey) {

                &#x2F;&#x2F; Add the account key to the array of keys that have to be removed if account has not been activated
                if (!this._checkIfActive(accountsList.getItemAtIndex(i).getAttribute(&quot;accountkey&quot;))) {
                    accountKeysToRemove.push(accountsList.getItemAtIndex(i).getAttribute(&quot;accountkey&quot;));
                }
            }
        }

        &#x2F;&#x2F; Remove items that correspond to inactive accounts
        for (var j = 0; j &lt; accountKeysToRemove.length; j++) {

            &#x2F;&#x2F; Index of item corresponding to the inactive account
            var inactiveAccountIndex = this._getIndexOfAccountKeyInAddressList(accountKeysToRemove[j]);

            &#x2F;&#x2F; Check if index of account was found
            if (inactiveAccountIndex &gt; -1) {
                accountsList.removeItemAt(inactiveAccountIndex);
            }
        }
    }
}

&#x2F;&#x2F; Add the compose window init event listener
&#x2F;&#x2F; @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Extensions&#x2F;Thunderbird&#x2F;HowTos&#x2F;Common_Thunderbird_Use_Cases&#x2F;Compose_New_Message
window.addEventListener(&quot;compose-window-init&quot;, SMETHComposeMessageController.init, true);

&#x2F;&#x2F; could use document.getElementById(&quot;msgcomposeWindow&quot;) instead of window
&#x2F;&#x2F; @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Extensions&#x2F;Thunderbird&#x2F;HowTos&#x2F;Common_Thunderbird_Use_Cases&#x2F;Compose_New_Message
window.addEventListener( &quot;compose-send-message&quot;, SMETHComposeMessageController.SendMailEventHandler, true);
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
