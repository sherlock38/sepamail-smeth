<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>content&#x2F;controllers&#x2F;SMETHRequestController.js</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.8.0pr2&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.8.0pr2&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="..&#x2F;assets/css/logo.png" title=""></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/SMETHAcknowledgementController.html">SMETHAcknowledgementController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHAcknowledgementPreferencesController.html">SMETHAcknowledgementPreferencesController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHAdvancedPreferencesController.html">SMETHAdvancedPreferencesController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHAttachmentController.html">SMETHAttachmentController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHBankPreferencesController.html">SMETHBankPreferencesController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHComposeMessageController.html">SMETHComposeMessageController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHControlFactory.html">SMETHControlFactory</a></li>
            
                <li><a href="..&#x2F;classes/SMETHHeaderController.html">SMETHHeaderController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHMail.html">SMETHMail</a></li>
            
                <li><a href="..&#x2F;classes/SMETHMailPreferencesController.html">SMETHMailPreferencesController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHMessageHandler.html">SMETHMessageHandler</a></li>
            
                <li><a href="..&#x2F;classes/SMETHOptionController.html">SMETHOptionController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHQXBANPreferencesController.html">SMETHQXBANPreferencesController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHReadMessageController.html">SMETHReadMessageController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHReportController.html">SMETHReportController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHRequestController.html">SMETHRequestController</a></li>
            
                <li><a href="..&#x2F;classes/SMETHUtils.html">SMETHUtils</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="..&#x2F;modules/smeth.html">smeth</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: content&#x2F;controllers&#x2F;SMETHRequestController.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x2F;* ***** BEGIN LICENSE BLOCK *****
 * This file is part of smeth (https:&#x2F;&#x2F;code.google.com&#x2F;p&#x2F;sepamail-smeth&#x2F;)
 *
 * Version: MPL 2.0&#x2F;GPL 3.0&#x2F;LGPL 3.0
 *
 * The contents of this file are subject to the Mozilla Public License Version
 * 2.0 (the &quot;License&quot;); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 * http:&#x2F;&#x2F;www.mozilla.org&#x2F;MPL&#x2F;2.0&#x2F;
 *
 * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,
 * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
 * for the specific language governing rights and limitations under the
 * License.
 *
 * The Initials Developers of the Original Code are :
 *  Ammit Heeramun, idSoft
 *  Bishan Kumar Madhoo, idSoft
 *  Manfred Sherlock Olm, deciBI &amp; vizGet
 * Portions created by the Initials Developers are Copyright (C) 2012
 * the Initial Developer. All Rights Reserved.
 *
 * Contributor(s):
 *  Ammit Heeramun
 *  Bishan Kumar Madhoo 
 *  Manfred Sherlock Olm, smeth@decibi.fr
 *
 * Alternatively, the contents of this file may be used under the terms of
 * either the GNU General Public License Version 3 or later (the &quot;GPL&quot;), or
 * the GNU Lesser General Public License Version 3.0 or later (the &quot;LGPL&quot;),
 * in which case the provisions of the GPL or the LGPL are applicable instead
 * of those above. If you wish to allow use of your version of this file only
 * under the terms of either the GPL or the LGPL, and not to allow others to
 * use your version of this file under the terms of the MPL, indicate your
 * decision by deleting the provisions above and replace them with the notice
 * and other provisions required by the GPL or the LGPL. If you do not delete
 * the provisions above, a recipient may use your version of this file under
 * the terms of any one of the MPL, the GPL or the LGPL.
 *
 * ***** END LICENSE BLOCK ***** *&#x2F;

&#x2F;**
 * @module smeth
 * @file SMETHRequestController.js
 * @mvc controller
 * @version 1212
 * @since 1210
 * @author Ammit Heeramun
 * @description SMETHReportController is the class that is responsible for the composition and sending of SEPAmail requests(Simple Test and Activation)
 *&#x2F;

&#x2F;**
 * The NetUtil.jsm JavaScript code module offers utility routines performing common network related tasks.
 * 
 * @include NetUtil.jsm
 * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Mozilla&#x2F;JavaScript_code_modules&#x2F;NetUtil.jsm
 *&#x2F;
Components.utils.import(&quot;resource:&#x2F;&#x2F;gre&#x2F;modules&#x2F;NetUtil.jsm&quot;);

&#x2F;**
 * SMETHMessageHandler class contain functions to handle info, error, warning and exceptions messages
 * 
 * @include SMETHMessageHandler.js
 *&#x2F;
Components.utils.import(&quot;resource:&#x2F;&#x2F;smeth&#x2F;smethlib&#x2F;SMETHMessageHandler.js&quot;);

&#x2F;**
 * SMETHUtils class contains all the useful functions that will be used in Smeth
 * 
 * @include SMETHUtils.js
 *&#x2F;
Components.utils.import(&quot;resource:&#x2F;&#x2F;smeth&#x2F;smethlib&#x2F;SMETHUtils.js&quot;);

&#x2F;**
 * Strict mode for scripts
 * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;JavaScript&#x2F;Reference&#x2F;Functions_and_function_scope&#x2F;Strict_mode
 *
 *&#x2F;
&quot;use strict&quot;;

&#x2F;**
 * SMETHRequestController class defines all the events that is related to the compose request window
 * 
 * @class SMETHRequestController
 *&#x2F;
var SMETHRequestController = {

   &#x2F;**
    * Declare the SMETHMessageHandler class
    * 
    * @attribute _smethMessageHandler
    * @private
    * @default null
    *&#x2F;
    _smethMessageHandler : null,

   &#x2F;**
    * Preferences object
    * 
    * @attribute _smethPreferences
    * @private
    * @default null
    *&#x2F;
    _smethPreferences : null,

   &#x2F;**
    * Declare the content document
    * 
    * @attribute _content
    * @private
    * @default null
    *&#x2F;
    _content : null,
    
   &#x2F;**
    * XML Object
    * 
    * @attribute _contentXMLObject
    * @private
    * @default null
    *&#x2F;
    _contentXMLObject : null,

   &#x2F;**
    * Smeth message type
    * 
    * @attribute _smethMessageType
    * @private
    * @default null
    *&#x2F;
    _smethMessageType : null,
    
   &#x2F;**
    * Smeth utils object
    * 
    * @attribute _smethUtils
    * @private
    * @default null
    *&#x2F;
    _smethUtils : null,
    
    &#x2F;**
     *init function Initialises all the objects that will be used in &quot;SMETHRequesrController&quot;
     *
     * @method init
     * @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Code_snippets&#x2F;Preferences#XPCOM_interfaces_for_preferences_system
     *&#x2F;
    init:function() {
        
        &#x2F;&#x2F; Instantiate the SMETHMessageHandler class
        this._smethMessageHandler = new SMETHMessageHandler(window);
        
        &#x2F;&#x2F; Instantiate the SMETHUtils class
        this._smethUtils = new SMETHUtils(window);
            
        &#x2F;&#x2F; Initialise the preference object
        &#x2F;&#x2F; @see https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;Code_snippets&#x2F;Preferences#XPCOM_interfaces_for_preferences_system
        this._smethPreferences = Components.classes[&quot;@mozilla.org&#x2F;preferences-service;1&quot;]
                                    .getService(Components.interfaces.nsIPrefService)
                                    .getBranch(&quot;extensions.smeth.&quot;);

        this._smethPreferences.QueryInterface(Components.interfaces.nsIPrefBranch2);
        
    },
    
    &#x2F;**
     * isSEPAmailRequest function check if the content of a body contains a valid request missive message
     *
     * @method isSEPAmailRequest
     * @param {String} aContent Message content
     * @return {Boolean} Whether the message is a valid request missive message
     *&#x2F;
    isSEPAmailRequest: function(aContent) {
        try {
            &#x2F;&#x2F; Initialise the default objects
            this.init();
            
            &#x2F;&#x2F; Initialise the content object
            this._content = aContent;

            &#x2F;&#x2F; Parse the content XML
            this._contentXMLObject = new DOMParser().parseFromString(aContent, &quot;text&#x2F;xml&quot;);

            &#x2F;&#x2F; Verify for any parse error
            if(&quot;parsererror&quot; !=  this._contentXMLObject.documentElement.nodeName) {
                
                &#x2F;&#x2F; Ge the message type xpath
                var smethPrefMissiveMsgTypXpath = this._smethPreferences.getCharPref(&quot;missive.prefMsgTypXpath&quot;);

                &#x2F;&#x2F; Create the SEPAmail namespace resolver object
                var sepamailNSResolver = this._contentXMLObject.createNSResolver(this._contentXMLObject);

                &#x2F;&#x2F; Get the SEPAmail message type using Xpath
                this._smethMessageType = this._contentXMLObject.evaluate(smethPrefMissiveMsgTypXpath, this._contentXMLObject, sepamailNSResolver, XPathResult.STRING_TYPE,null).stringValue;
                
                &#x2F;&#x2F; Check whether the xml is of type &quot;activation.request@payment.activation&quot;
                if(&quot;activation.request@payment.activation&quot; ==  this._smethMessageType || 
                   &quot;simple.request@test&quot; ==  this._smethMessageType) {
                    return true;
                } else {
                    return false;
                }
            } else {
                return false;
            }

            return false;
            
        } catch(ex) {
            SMETHRequestController._smethMessageHandler.exception(ex);
        }
    },

    &#x2F;**
     * NotifyComposeBodyReady event notifies when the compose body is ready
     * 
     * @method NotifyComposeBodyReady
     *&#x2F;
    NotifyComposeBodyReady: function() {
        
        try {
            
            &#x2F;&#x2F; Create the SEPAmail namespace resolver object
            var sepamailNSResolver = this._contentXMLObject.createNSResolver(this._contentXMLObject);
            
            &#x2F;&#x2F; Transform the SEPAmail XML document
            var sepamailComposeBody = this._transformXMLDocument(this._contentXMLObject, this._getComposeWindowXSLPath());
            
            &#x2F;&#x2F; Populate the default values
            SMETHRequestController._populateDefaultValues(sepamailComposeBody);
            
            &#x2F;&#x2F; Get the content window
            var smethComposeBodyFormContainer = document.getElementById(&quot;smethComposeBodyFormContainer&quot;);
            
            &#x2F;&#x2F; Set translated labels for SMETH UI controls
            sepamailComposeBody = this._smethUtils.translateSEPAmailDocument(sepamailComposeBody, SMETHRequestComposeWindowTranslations);
            
            &#x2F;&#x2F; Append the child to the content frame
            smethComposeBodyFormContainer.appendChild(sepamailComposeBody.firstChild);
        
        } catch(ex) {
            SMETHRequestController._smethMessageHandler.exception(ex);
        }
    },
    
    &#x2F;**
     * SendMailEventHandler event handles the send event of an email
     *
     * @method SendMailEventHandler
     * @param {Object} anEvent Event parameters
     *&#x2F;
    SendMailEventHandler : function(anEvent) {
        try {
            &#x2F;&#x2F; Get the message compose window
            var msgcomposeWindow = document.getElementById(&quot;msgcomposeWindow&quot;);

            &#x2F;&#x2F; Get the message type
            var msg_type = msgcomposeWindow.getAttribute(&quot;msgtype&quot;);

            &#x2F;&#x2F; Check if it is an actual send event
            if( !(msg_type == nsIMsgCompDeliverMode.Now || msg_type == nsIMsgCompDeliverMode.Later) ) {

                return;
            } else {

            }

            &#x2F;&#x2F; Get the current editor
            var editor = GetCurrentEditor();

            &#x2F;&#x2F; Begin the transaction
            editor.beginTransaction();
            
            &#x2F;&#x2F; Populate the QXBANS
            if (this._populateQXBAN(gMsgCompose)) {
                &#x2F;&#x2F; Set the other XML fields
                switch(SMETHRequestController._smethMessageType)
                {
                    case &quot;activation.request@payment.activation&quot;:
                        &#x2F;&#x2F; populate the XML object with the forms values
                        this._populateRequestXMLWithFieldsValues();
                        break;
                    case &quot;simple.request@test&quot;:
                        &#x2F;&#x2F; populate the XML object with the forms values
                        this._populateTestRequestXMLWithFieldsValues();
                        break;
                    default:
                        break;
                }

                &#x2F;&#x2F; Set the text content of the mail being sent
                editor.document.body.textContent = (new XMLSerializer()).serializeToString(this._contentXMLObject);
            } else {
                 anEvent.preventDefault();
            }
            
            
            
            editor.endTransaction();
        } catch(ex) {
            SMETHRequestController._smethMessageHandler.exception(ex);
        }
    },
    
    &#x2F;**
     *AttachDocumentEventHandler event handles the attachement of SEPAmail Documents
     *
     * @method AttachDocumentEventHandler
     *&#x2F;
    AttachDocumentEventHandler : function() {
        try {
            switch(SMETHRequestController._smethMessageType)
            {
                case &quot;activation.request@payment.activation&quot;:
                        this._appendAttachmentToXMLDocument(this._openFile());
                    break;
                case &quot;simple.request@test&quot;:
                        SMETHRequestController._smethMessageHandler.info(&quot;Attachments not yet handled for simple test request&quot;);
                    break;
                default:
                        SMETHRequestController._smethMessageHandler.info(&quot;Attachments not yet handled for other type of request&quot;);
                    break;
            }
            
        } catch(ex) {
            SMETHRequestController._smethMessageHandler.exception(ex);
        }
    },
    
   &#x2F;**
     * TryHandleMissiveAttachments handles missive attachment operations
     *
     * @method TryHandleMissiveAttachments
     * @param {String} action Action that is being carried out on the missive attachment
     * @param {Object} target Missive attachment item
     *&#x2F;
    TryHandleMissiveAttachments : function(action, target) {
        
        &#x2F;&#x2F; Get the attachment object
        var missiveAttachmentList = document.getElementById(&quot;missiveAttachmentList&quot;);

        &#x2F;&#x2F; Missive attachment items
        var missiveAttachmentItems = missiveAttachmentList.getElementsByTagName(&quot;missiveattachmentitem&quot;);

        switch (action) {
            case &quot;delete&quot;:
                var nodes = this._contentXMLObject.getElementsByTagName(&quot;sem:Documents&quot;);
                var header = this._contentXMLObject.getElementsByTagName(&quot;sem:Header&quot;);
                
                &#x2F;&#x2F; Check if target has been defined
                if (target == undefined) {

                    &#x2F;&#x2F; Verify that we have a missive attachment item
                    if (missiveAttachmentItems.length &gt; 0) {

                        &#x2F;&#x2F; Check if missive attachment data objects could be found
                        if (missiveAttachmentItems[0].data != null) {

                            try {
                                    for(i=0;i&lt;nodes.length;i++)
                                    {
                                        if(missiveAttachmentItems[0].data.getAttribute(&quot;name&quot;) == 
                                           nodes[i].getElementsByTagName(&quot;sem:name&quot;)[0].textContent)
                                        {
                                            header[0].removeChild(nodes[i]);
                                        }
                                    }
                                    
                                    &#x2F;&#x2F; Initialize the attachment UI
                                    SMETHRequestController._disableAttachmentUI();

                                    &#x2F;&#x2F; Initialize the attachment UI
                                    SMETHRequestController._initializeAttachmentUI(SMETHRequestController._contentXMLObject);

                            } catch (e) {
                                throw e;
                            }

                        } else {
                            throw new Error(&quot;Missive attachment file details could not be found.&quot;);
                        }

                    } else {
                        throw new Error(&quot;Missive attachment file items could not be found.&quot;);
                    }

                } else {

                    &#x2F;&#x2F; Check if missive attachment data objects could be found
                    if (missiveAttachmentList._currentItem.data != null) {

                        try {
                                for(i=0;i&lt;nodes.length;i++)
                                {
                                    if(missiveAttachmentItems[0].data.getAttribute(&quot;name&quot;) == 
                                       nodes[i].getElementsByTagName(&quot;sem:name&quot;)[0].textContent)
                                    {
                                        header[0].removeChild(nodes[i]);
                                    }
                                }

                                &#x2F;&#x2F; Initialize the attachment UI
                                SMETHRequestController._disableAttachmentUI();

                                &#x2F;&#x2F; Initialize the attachment UI
                                SMETHRequestController._initializeAttachmentUI(SMETHRequestController._contentXMLObject);

                        } catch (e) {
                            throw e;
                        }

                    } else {
                        throw new Error(&quot;Missive attachment file details could not be found.&quot;);
                    }
                }
                break;
            default:
                break;
        }
    },
    
    &#x2F;**
     * _openFile function allow open the file picker, allows to select a file and returns the file object
     * 
     * @method _openFile
     * @return {Object} The opened file object
     *&#x2F;
    _openFile : function() {
        try {
            &#x2F;&#x2F; Instantiate the nsIFilePicker
            const nsIFilePicker = Components.interfaces.nsIFilePicker;

            &#x2F;&#x2F; File picker instance
            var fp = Components.classes[&quot;@mozilla.org&#x2F;filepicker;1&quot;]
                            .createInstance(nsIFilePicker);
            fp.init(window, &quot;Open document to attach&quot; , nsIFilePicker.modeOpen);
            
            &#x2F;&#x2F; Show the file picker
            var rv = fp.show();
            
            &#x2F;&#x2F; Check if user has chosen a file to attach
            if (rv == nsIFilePicker.returnOK || rv == nsIFilePicker.returnReplace) {
                
                &#x2F;&#x2F; Check if file exists
                if (false == fp.file.exists()) {
                    throw new Error(&quot;File could not be found.&quot;);
                } else {}
                
                return fp.file;
            }
            
            return null
            
        } catch(ex) {
            SMETHRequestController._smethMessageHandler.exception(ex);
        }  
    },
    
    &#x2F;**
     * _appendAttachmentToXMLDocument appends attachment to XML document
     *
     * @method _appendAttachmentToXMLDocument
     * @param {Object} aFile File to append as attachment
     *&#x2F;
    _appendAttachmentToXMLDocument: function(aFile) {
        try {
            &#x2F;&#x2F; Check if file is not null
            if(null != aFile) {
                &#x2F;&#x2F; Read the file
                NetUtil.asyncFetch(aFile, function(inputStream, status) {

                    &#x2F;&#x2F; Check if there is any reading error
                    if (!Components.isSuccessCode(status)) {
                        throw new Error(&quot;Error reading from file&quot;);
                        return;
                    }
                    var file = aFile;
                    
                    &#x2F;&#x2F; New element for documents node
                    var documentNode = SMETHRequestController._contentXMLObject.createElement(&#x27;sem:Documents&#x27;);
                    
                    &#x2F;&#x2F; New element for type node
                    var typeNode = SMETHRequestController._contentXMLObject.createElement(&#x27;sem:Type&#x27;);
                    typeNode.textContent = &#x27;mandant&#x27;;
                    documentNode.appendChild(typeNode);
                    
                    &#x2F;&#x2F; New element for title node
                    var titleNode = SMETHRequestController._contentXMLObject.createElement(&#x27;sem:Title&#x27;);
                    titleNode.textContent = &#x27;Avis de paiement SEPAmail&#x27;;
                    documentNode.appendChild(titleNode);
                    
                    &#x2F;&#x2F; New element for Date node
                    var dateNode = SMETHRequestController._contentXMLObject.createElement(&#x27;sem:Date&#x27;);
                    dateNode.textContent = &#x27;2012-10-25&#x27;;
                    documentNode.appendChild(dateNode);
                    
                    &#x2F;&#x2F; New element for Language node
                    var langNode = SMETHRequestController._contentXMLObject.createElement(&#x27;sem:Lang&#x27;);
                    langNode.textContent = &#x27;fr&#x27;;
                    documentNode.appendChild(langNode);
                    
                    &#x2F;&#x2F; New element for Contents node
                    var contentsNode = SMETHRequestController._contentXMLObject.createElement(&#x27;sem:Contents&#x27;);
                    
                    var mimeService = Components.classes[&quot;@mozilla.org&#x2F;mime;1&quot;]
                                      .getService(Components.interfaces.nsIMIMEService);
                    var  mimeType = mimeService.getTypeFromFile(file);
                    
                    &#x2F;&#x2F; New element for mime-type node
                    var mimeTypeNode = SMETHRequestController._contentXMLObject.createElement(&#x27;sem:mime-type&#x27;);
                    mimeTypeNode.textContent = mimeType;
                    contentsNode.appendChild(mimeTypeNode);
                    
                    &#x2F;&#x2F; New element for name node
                    var nameNode = SMETHRequestController._contentXMLObject.createElement(&#x27;sem:name&#x27;);
                    nameNode.textContent = file.leafName;
                    contentsNode.appendChild(nameNode);
                    
                    &#x2F;&#x2F; Read the file
                    var data = NetUtil.readInputStreamToString(inputStream, inputStream.available());
                    
                    &#x2F;&#x2F; New element for data node
                    var dataNode = SMETHRequestController._contentXMLObject.createElement(&#x27;sem:data&#x27;);
                    dataNode.appendChild(SMETHRequestController._contentXMLObject.createCDATASection(window.btoa(data)));
                    contentsNode.appendChild(dataNode);
                    
                    &#x2F;&#x2F; Append the content node to the document node
                    documentNode.appendChild(contentsNode);
                    
                    &#x2F;&#x2F; Get the header node
                    var headerNode = SMETHRequestController._contentXMLObject.evaluate(&quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvBdy&#x2F;sem:sepamail_message_001&#x2F;sem:MsgBdy&#x2F;sem:ActivationRequest&#x2F;sem:Header&quot;,
                                     SMETHRequestController._contentXMLObject, SMETHRequestController._contentXMLObject.createNSResolver(SMETHRequestController._contentXMLObject), 
                                     XPathResult.FIRST_ORDERED_NODE_TYPE, null);
                    
                    &#x2F;&#x2F; Append the document node to the header node                 
                    headerNode.singleNodeValue.appendChild(documentNode);
                    
                    &#x2F;&#x2F; Initialize the attachment UI
                    SMETHRequestController._disableAttachmentUI();
                    
                    &#x2F;&#x2F; Initialize the attachment UI
                    SMETHRequestController._initializeAttachmentUI(SMETHRequestController._contentXMLObject);
                });
            } else {}
            
        } catch(ex) {
            SMETHRequestController._smethMessageHandler.exception(ex);
        }
    },
    
    &#x2F;**
     *_populateQXBAN function populates the XML Object with sender and receiver QXBAN
     *
     *@method _populateQXBAN
     *@param {Object} aMsgCompose Message compose object
     *&#x2F;
    _populateQXBAN:function(aMsgCompose) {
        try
        {
            var fromMail = aMsgCompose.identity.email;
            var toMail = aMsgCompose.compFields.to;
            
            var accountMenuItems = document.getElementById(&quot;msgIdentityPopup&quot;).
                                       getElementsByTagNameNS(&quot;http:&#x2F;&#x2F;www.mozilla.org&#x2F;keymaster&#x2F;gatekeeper&#x2F;there.is.only.xul&quot;, &quot;menuitem&quot;);
                                   
            var accountKey;
            
            for(i=0;i&lt;accountMenuItems.length;i++) {
                
                if(true == accountMenuItems[i].selected) {
                    accountKey = accountMenuItems[i].getAttribute(&quot;accountkey&quot;);
                } else {}
            }
            
            if(undefined != accountKey) {
                
                var myQXBAN = this._getQxbanByEmailAddressAccount(accountKey);
                var receiverQXBAN = this._getReceiverQxbanByEmailAddress(toMail);
                
                if(&quot;&quot; == myQXBAN.qxban.trim()) {
                    SMETHRequestController._smethMessageHandler.info(&quot;Your current mail account QXBAN is not define in the SMETH preference. Unable to proceed.&quot;);
                    return false;
                } else {}
                
                if(null == receiverQXBAN) {
                    SMETHRequestController._smethMessageHandler.info(&quot;The receivers QXBAN is not define in the SMETH preference. Unable to proceed.&quot;);
                    return false;
                } else {}
                
                &#x2F;&#x2F; Set the sender IBAN value
                this._setNodeValue(this._contentXMLObject, 
                &quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvHdr&#x2F;sem:Snd&#x2F;sem:IBAN&quot;,
                myQXBAN.qxban);
                
                &#x2F;&#x2F; Set the receiver IBAN value
                this._setNodeValue(this._contentXMLObject, 
                &quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvHdr&#x2F;sem:Rcv&#x2F;sem:IBAN&quot;,
                receiverQXBAN.qxban);
                
                return true;
            } else {
                throw new Error(&quot;No account was detected&quot;);
            }
            
        } catch(ex) {
            
            throw ex;
        }
    },
    
    &#x2F;**
     * Get the email account key to QXBAN association object
     *
     * @method _getQxbanByEmailAddressAccount
     * @param {Object} account Account for which association object is required
     * @return {String} Email address account to QXBAN association object
     *&#x2F;
    _getQxbanByEmailAddressAccount : function(account) {
        
        var qxbanConfig =  JSON.parse(SMETHRequestController._smethPreferences.getCharPref(&quot;myqxbans&quot;));

        &#x2F;&#x2F; Scan the array of email address account to QXBAN association objects
        for (var i = 0; i &lt; qxbanConfig.length; i++) {

            &#x2F;&#x2F; Current association object
            var currentItem = qxbanConfig[i];

            &#x2F;&#x2F; Check if we have the required object
            if (currentItem.account == account) {
                return currentItem;
            }
        }

        return null;
    },
    
    &#x2F;**
     * Get the QXBAN of a specified email address from the array of email address to QXBAN objects
     *
     * @method _getReceiverQxbanByEmailAddress
     * @param {String} email Email address
     * @return {Object} QXBAN of email address in the array of email addresses to QXBAN objects
     *&#x2F;
    _getReceiverQxbanByEmailAddress : function(email) {
        
        var qxbanConfig =  JSON.parse(SMETHRequestController._smethPreferences.getCharPref(&quot;qxbans&quot;));
        
        &#x2F;&#x2F; Scan the array of email addresses to QXBAN objects
        for (var i = 0; i &lt; qxbanConfig.length; i++) {

            &#x2F;&#x2F; Current object
            var currentObj = qxbanConfig[i];

            &#x2F;&#x2F; Check the email address associated with the current object
            if (currentObj.email.trim().toLowerCase() == email.toLowerCase()) {
                return currentObj;
            }
        }

        &#x2F;&#x2F; Item could not be found
        return null;
    },

    
    &#x2F;**
     * _populateDefaultValues populates the default values for the compose body
     *
     * @method _populateDefaultValues
     * @param {XML} aSepamailComposeBody
     *&#x2F;
    _populateDefaultValues : function(aSepamailComposeBody) {
        
        switch(SMETHRequestController._smethMessageType)
        {
            case &quot;activation.request@payment.activation&quot;:
                    &#x2F;&#x2F; Get the default Currency
                    var defaultCurrency =  SMETHRequestController._smethPreferences.getCharPref(&quot;defaultCurrency&quot;);
            
                    &#x2F;&#x2F; Set default Currency
                    aSepamailComposeBody.getElementById(&quot;ccyLabel&quot;).setAttribute(&quot;value&quot;, this._getCurrencyByCode(defaultCurrency));
                break;
            case &quot;simple.request@test&quot;:
                break;
            default:
                break;

        }
    },
    
    &#x2F;**
     *_populateRequestXMLWithFieldsValues function populates the XML Object with the form fields values
     *
     * @method _populateRequestXMLWithFieldsValues
     *&#x2F;
    _populateRequestXMLWithFieldsValues: function() {
        try {
            &#x2F;&#x2F; Check whether the xml is of type &quot;activation.request@payment.activation&quot;
            if(&quot;activation.request@payment.activation&quot; ==  SMETHRequestController._smethMessageType) {
                
                    var requestAmountTextbox = document.getElementById(&quot;semBdyRequestAmount&quot;);
                    var requestPaymentTypeMenulist = document.getElementById(&quot;semBdyRequestPaymentType&quot;);
                    var requestDataDatepicker = document.getElementById(&quot;semBdyRequestDataValue&quot;);
                    var requestTitleTextbox = document.getElementById(&quot;semBdyRequestSubject&quot;);
                     &#x2F;&#x2F; Get the default Currency
                    var defaultCurrency =  SMETHRequestController._smethPreferences.getCharPref(&quot;defaultCurrency&quot;);

                    &#x2F;&#x2F; Set the &quot;InstdAmt&quot; value
                    this._setNodeValue(this._contentXMLObject, 
                    &quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvBdy&#x2F;sem:sepamail_message_001&#x2F;sem:MsgBdy&#x2F;sem:ActivationRequest&#x2F;sem:ReqCompl&#x2F;sem:Request&#x2F;pain013:PmtInf&#x2F;pain013:CdtTrfTx&#x2F;pain013:Amt&#x2F;pain013:InstdAmt&quot;,
                    requestAmountTextbox.value);
                    
                    &#x2F;&#x2F; Set the currency
                    this._setNodeAttribute(this._contentXMLObject,
                    &quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvBdy&#x2F;sem:sepamail_message_001&#x2F;sem:MsgBdy&#x2F;sem:ActivationRequest&#x2F;sem:ReqCompl&#x2F;sem:Request&#x2F;pain013:PmtInf&#x2F;pain013:CdtTrfTx&#x2F;pain013:Amt&#x2F;pain013:InstdAmt&quot;,
                    &quot;Ccy&quot;,
                    defaultCurrency);

                    &#x2F;&#x2F; Set the &quot;PmtMtd&quot; value
                    this._setNodeValue(this._contentXMLObject, 
                    &quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvBdy&#x2F;sem:sepamail_message_001&#x2F;sem:MsgBdy&#x2F;sem:ActivationRequest&#x2F;sem:ReqCompl&#x2F;sem:Request&#x2F;pain013:PmtInf&#x2F;pain013:PmtMtd&quot;,
                    requestPaymentTypeMenulist.value);

                    &#x2F;&#x2F; Set the &quot;ReqdExctnDt&quot; value
                    this._setNodeValue(this._contentXMLObject, 
                    &quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvBdy&#x2F;sem:sepamail_message_001&#x2F;sem:MsgBdy&#x2F;sem:ActivationRequest&#x2F;sem:ReqCompl&#x2F;sem:Request&#x2F;pain013:PmtInf&#x2F;pain013:ReqdExctnDt&quot;,
                    requestDataDatepicker.value);
                    
                    &#x2F;&#x2F; Set the &quot;Title&quot; value
                    this._setNodeValue(this._contentXMLObject, 
                    &quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvBdy&#x2F;sem:sepamail_message_001&#x2F;sem:MsgBdy&#x2F;sem:ActivationRequest&#x2F;sem:ReqCompl&#x2F;sem:Complements&#x2F;sem:Title&quot;,
                    requestTitleTextbox.value);

            } else {

            }   
        } catch(ex) {
            
            throw ex;
        }
    },
    
    &#x2F;**
     *_populateTestRequestXMLWithFieldsValues function populates the XML Object with the form fields values
     *
     * @method _populateTestRequestXMLWithFieldsValues
     *&#x2F;
    _populateTestRequestXMLWithFieldsValues: function() {
        try {
            
            var requestTestIdTextbox = document.getElementById(&quot;requestTestIdTextbox&quot;);
            var requestTextTextbox = document.getElementById(&quot;requestTextTextbox&quot;);
            
            &#x2F;&#x2F; Set the &quot;TestId&quot; value
            this._setNodeValue(this._contentXMLObject, 
            &quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvBdy&#x2F;sem:sepamail_message_001&#x2F;sem:MsgBdy&#x2F;sem:SimpleTestRequest&#x2F;sem:TestId&quot;,
            requestTestIdTextbox.value);

            &#x2F;&#x2F; Set the &quot;Text&quot; value
            this._setNodeValue(this._contentXMLObject, 
            &quot;&#x2F;sem:Missive&#x2F;sem:sepamail_missive_001&#x2F;sem:MsvBdy&#x2F;sem:sepamail_message_001&#x2F;sem:MsgBdy&#x2F;sem:SimpleTestRequest&#x2F;sem:Text&quot;,
            requestTextTextbox.value);
                    
        } catch(ex) {
            
            throw ex;
        }
    },
    
    &#x2F;**
     * _initializeAttachmentUI function initialises the SEPAmail attachment user interface
     * 
     * @method _initializeAttachmentUI
     *&#x2F;
    _initializeAttachmentUI : function(anXMLObject){
        try
        {
            &#x2F;&#x2F; Declare the attachment XSL url
            var attachmentXSLUrl = &quot;&quot;;
            
            var xmlObject = anXMLObject;
            
            if(&quot;activation.request@payment.activation&quot; ==  SMETHRequestController._smethMessageType) {
                
                &#x2F;&#x2F; Get the missive attachment XSL url based on the SEPAmail type and SEPAmail Message Type
                attachmentXSLUrl = SMETHRequestController._smethPreferences.getCharPref(&quot;missive.activation.request.compose.attachmentXSLUrl&quot;);
                
                &#x2F;&#x2F; Check if the attachment XSL Url is define
                if(&quot;&quot; != attachmentXSLUrl)
                {   
                    &#x2F;&#x2F; Regenerate XML object
                    var object = new DOMParser().parseFromString((new XMLSerializer()).serializeToString(xmlObject), &quot;text&#x2F;xml&quot;);
                    
                    &#x2F;&#x2F; Transform the SEPAmail XML document
                    var attachmentDocument = SMETHRequestController._transformXMLDocument(object, attachmentXSLUrl);

                    &#x2F;&#x2F; Get the content window
                    var smethComposeBodyFormContainer = document.getElementById(&quot;smethComposeBodyFormContainer&quot;);

                    &#x2F;&#x2F; Appends the resulting transformation fragment first child to the sepamailUIContainer
                    smethComposeBodyFormContainer.appendChild(attachmentDocument.firstChild);
                }
                else
                {
                    SMETHRequestController._smethMessageHandler.info(&quot;XSL Url for SEPAmail attachment is not define in the configuration file&quot;);
                }
            } else {}
        }
        catch(ex)
        {
            throw ex;
        }
    },
    
    &#x2F;**
     * _disableAttachmentUI function removes the attachment UI
     * 
     * @method _disableAttachmentUI
     *&#x2F;
    _disableAttachmentUI : function() {
        &#x2F;&#x2F; Get the content window
        var smethComposeBodyFormContainer = document.getElementById(&quot;smethComposeBodyFormContainer&quot;);
        
        &#x2F;&#x2F; Check if the sepamailLogoBox is present
        if(null != document.getElementById(&quot;missiveAttachmentContainer&quot;))
        {
            &#x2F;&#x2F; Removes the sepamailLogoBox
            smethComposeBodyFormContainer.removeChild(document.getElementById(&quot;missiveAttachmentContainer&quot;));

        }
        else{}
    },
    

    &#x2F;**
     * Set the text value of a node in a given xml doc
     *
     * @method _setNodeValue
     * @param {XML} anXMLDoc RequestXML Document
     * @param {String} anXpath  Node Xpath
     * @param {String} aValue   Node Value
     *&#x2F;
    _setNodeValue : function(anXMLDoc, anXpath, aValue) {
        
        &#x2F;&#x2F; Get the specific node
        var node = anXMLDoc.evaluate(anXpath,
        anXMLDoc, anXMLDoc.createNSResolver(anXMLDoc), 
        XPathResult.FIRST_ORDERED_NODE_TYPE, null);
        
        node.singleNodeValue.textContent = aValue;
    },
    
    &#x2F;**
     * Set the text value of a node in a given xml doc
     *
     * @method _setNodeValue
     * @param {XML} anXMLDoc RequestXML Document
     * @param {String} anXpath  Node Xpath
     * @param {String} anAttribute Node attribute
     * @param {String} anAttributeValue   Node attribute value
     *&#x2F;
    _setNodeAttribute : function(anXMLDoc, anXpath, anAttribute, anAttributeValue) {
        
        &#x2F;&#x2F; Get the specific node
        var node = anXMLDoc.evaluate(anXpath,
        anXMLDoc, anXMLDoc.createNSResolver(anXMLDoc), 
        XPathResult.FIRST_ORDERED_NODE_TYPE, null);
        
        node.singleNodeValue.setAttribute(anAttribute, anAttributeValue);
    },
    
    &#x2F;**
     * getCurrencyByCode function get currency by code
     *
     * @method _getCurrencyByCode
     * @param {String} aCurCode Currency code
     * @return {String} Currency
     *&#x2F;
    _getCurrencyByCode : function (aCurCode) {
        try
        {
            switch(aCurCode)
            {
                case &quot;EUR&quot;:
                    return &quot;\u0404(euros)&quot;;
                    break;
                case &quot;DOL&quot;:
                    return &quot;$(dollar)&quot;;
                    break;
                default:
                    return &quot;\u0404(euros)&quot;;
                    break;
            }
        }
        catch (ex)
        {
            throw ex;
        }
    },
    
    &#x2F;**
     * getComposeWindowXSLPath compose window xsl path
     * 
     * @method _getComposeWindowXSLPath
     * @return {String} XSL path
     *&#x2F;
    _getComposeWindowXSLPath: function() {
        try {
            
            switch(SMETHRequestController._smethMessageType)
            {
                case &quot;activation.request@payment.activation&quot;:
                    return this._smethPreferences.getCharPref(&quot;missive.activation.request.compose.bodyXSLUrl&quot;);
                    break;
                case &quot;simple.request@test&quot;:
                    return this._smethPreferences.getCharPref(&quot;missive.simple.request.compose.bodyXSLUrl&quot;);
                    break;
                default:
                    return &#x27;&#x27;;
                    break;
                    
            }
            return &#x27;&#x27;;
             
        } catch(ex) {
            SMETHRequestController._smethMessageHandler.exception(ex);
        }
    },

    &#x2F;**
     * _transformXMLDocument function transforms the parametered XML document using the paramentered XSL file URL
     *
     * @method _transformXMLDocument
     * @param {XML} anXML XML document to transform
     * @param {String} anXSLUrl XSL url
     * @return {XML} Transformed XML document
     *&#x2F;
    _transformXMLDocument : function (anXML, anXSLUrl) {
        try {
            &#x2F;&#x2F; Decalre the XMLHttpRequest to load the XSL
            var xmlHttpRequest = new XMLHttpRequest();

            &#x2F;&#x2F; Send request for the XSL document
            xmlHttpRequest.open(&#x27;GET&#x27;, anXSLUrl, false);
            xmlHttpRequest.send();

            &#x2F;&#x2F; Get the XSL document object
            var xslDocument = xmlHttpRequest.responseXML;

            &#x2F;&#x2F; Instatiate the XSLT Processor
            var xsltProcessor= Components.classes[&quot;@mozilla.org&#x2F;document-transformer;1?type=xslt&quot;]
                                .createInstance(Components.interfaces.nsIXSLTProcessor);

            &#x2F;&#x2F; Import the XSL document object in the XSLT processor
            xsltProcessor.importStylesheet(xslDocument);

            &#x2F;&#x2F; Declare an empty XML document that will own the fragment
            var resultDocumentOwner = document.implementation.createDocument(&quot;http:&#x2F;&#x2F;www.mozilla.org&#x2F;keymaster&#x2F;gatekeeper&#x2F;there.is.only.xul&quot;, &quot;&quot;, null);

            &#x2F;&#x2F; Get the resulting transformation fragment
            var resultFragment = xsltProcessor.transformToFragment(anXML,resultDocumentOwner);

            &#x2F;&#x2F; Append the result fragment to its fragment owner
            resultDocumentOwner.appendChild(resultFragment);

            return resultDocumentOwner;
        } catch(ex) {
            throw ex;
        }
    }
}

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
